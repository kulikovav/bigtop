diff -uNr knox-0.7.0-a/CHANGES knox-0.7.0-b/CHANGES
--- knox-0.7.0-a/CHANGES	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/CHANGES	2016-08-02 13:20:40.807808546 +0400
@@ -79,19 +79,7 @@
     * [KNOX-601] - Knox test failures on windows
     * [KNOX-603] - Coverity: Potential resource leak in BaseKeystoreService.createKeystore
     * [KNOX-614] - Incorrect URI template expansion with {**} query params #fragments
-    * [KNOX-616] - XmlUrlRewriteStreamFilter unscapes escaped special characters
-    * [KNOX-616] - XmlUrlRewriteStreamFilter unscapes escaped special characters
-    * [KNOX-620] - Jenkins Knox-master-verify failing since #725 due to JDK version issues
-    * [KNOX-626] - Minor fix to namespace parsing
     * [KNOX-623] - Gateway provider rewriter doesn't support boolean attributes in HTML.
-    * [KNOX-632] - added back configuration for 'replayBufferSize'
-    * [KNOX-632] - Oozie dispatch failing for secure clusters. Fix tests.
-    * [KNOX-632] - Oozie dispatch failing for secure clusters
-    * [KNOX-633] - Upgrade apache commons-collections
-    * [KNOX-637] - Compilation Error in gateway-service-admin and gateway-test test projects (arshad.mohammad via lmccay)
-    * [KNOX-636] - IdentityAsserterHttpServletRequestWrapper must override getUserPrincipal
-    * [KNOX-638] - Hive dispatch failing for secure clusters
-    * [KNOX-639] - Knoxcli.sh create-master should not allow empty strings
 
 ------------------------------------------------------------------------------
 Release Notes - Apache Knox - Version 0.6.0
diff -uNr knox-0.7.0-a/gateway-provider-identity-assertion-common/src/main/java/org/apache/hadoop/gateway/identityasserter/common/filter/IdentityAsserterHttpServletRequestWrapper.java knox-0.7.0-b/gateway-provider-identity-assertion-common/src/main/java/org/apache/hadoop/gateway/identityasserter/common/filter/IdentityAsserterHttpServletRequestWrapper.java
--- knox-0.7.0-a/gateway-provider-identity-assertion-common/src/main/java/org/apache/hadoop/gateway/identityasserter/common/filter/IdentityAsserterHttpServletRequestWrapper.java	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-provider-identity-assertion-common/src/main/java/org/apache/hadoop/gateway/identityasserter/common/filter/IdentityAsserterHttpServletRequestWrapper.java	2016-08-02 13:20:40.787808078 +0400
@@ -100,7 +100,7 @@
     Map<String, String[]> params = null;
     if (getMethod().equals("GET")) {
       if (qString != null && qString.length() > 0) {
-        params = HttpUtils.parseQueryString( qString );
+        params = HttpUtils.parseQueryString2( qString );
       }
       else {
         params = new HashMap<String, String[]>();
@@ -111,7 +111,7 @@
         return null;
       }
       else {
-        params = HttpUtils.parseQueryString( qString );
+        params = HttpUtils.parseQueryString2( qString );
       }
     }  
     return params;
diff -uNr knox-0.7.0-a/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/i18n/UrlRewriteMessages.java knox-0.7.0-b/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/i18n/UrlRewriteMessages.java
--- knox-0.7.0-a/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/i18n/UrlRewriteMessages.java	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/i18n/UrlRewriteMessages.java	2016-08-02 13:20:41.435823224 +0400
@@ -73,7 +73,7 @@
   @Message( level = MessageLevel.DEBUG, text = "Rewrote URL: {0}, direction: {1} via explicit rule: {2} to URL: {3}" )
   void rewroteUrlViaExplicitRule( Template inputUri, UrlRewriter.Direction direction, String ruleName, Template outputUri );
 
-  @Message( level = MessageLevel.ERROR, text = "Failed to rewrite URL: {0}, direction: {1} via rule: {2}, status: {3}" )
+  @Message( level = MessageLevel.WARN, text = "Failed to rewrite URL: {0}, direction: {1} via rule: {2}, status: {3}" )
   void failedToRewriteUrl( Template inputUri, UrlRewriter.Direction direction, String ruleName, UrlRewriteStepStatus stepStatus );
 
   @Message( level = MessageLevel.ERROR, text = "Failed to rewrite URL: {0}, direction: {1}, rule: {2}" )
diff -uNr knox-0.7.0-a/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/impl/html/HtmlFilterReaderBase.java knox-0.7.0-b/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/impl/html/HtmlFilterReaderBase.java
--- knox-0.7.0-a/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/impl/html/HtmlFilterReaderBase.java	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/impl/html/HtmlFilterReaderBase.java	2016-08-02 13:20:41.471824065 +0400
@@ -199,9 +199,8 @@
         // This can happen for whitespace outside of the root element.
         //outputValue = filterText( null, inputValue );
       } else {
-        String tagType = stack.peek().getTag().getAttributeValue("type");
         String tagName = stack.peek().getTag().getName();
-        if (SCRIPTTAG.equals(tagName) && JSTYPES.contains(tagType) && config != null && !config.getSelectors().isEmpty() ) {
+        if (SCRIPTTAG.equals(tagName) && config != null && !config.getSelectors().isEmpty() ) {
           // embedded javascript content
           outputValue = UrlRewriteUtil.filterJavaScript( inputValue, config, this, REGEX_COMPILER );
         } else {
diff -uNr knox-0.7.0-a/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/impl/json/JsonUrlRewriteStreamFilter.java knox-0.7.0-b/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/impl/json/JsonUrlRewriteStreamFilter.java
--- knox-0.7.0-a/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/impl/json/JsonUrlRewriteStreamFilter.java	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-provider-rewrite/src/main/java/org/apache/hadoop/gateway/filter/rewrite/impl/json/JsonUrlRewriteStreamFilter.java	2016-08-02 13:20:41.477824206 +0400
@@ -29,7 +29,7 @@
 
 public class JsonUrlRewriteStreamFilter implements UrlRewriteStreamFilter {
 
-  private static String[] TYPES = new String[]{ "application/json", "text/json", "*/json" };
+  private static String[] TYPES = new String[]{ "application/json", "text/json", "*/json", "application/vnd.kafka.v1+json" };
   private static String[] NAMES = new String[]{ null };
 
   @Override
diff -uNr knox-0.7.0-a/gateway-provider-rewrite-func-header/pom.xml knox-0.7.0-b/gateway-provider-rewrite-func-header/pom.xml
--- knox-0.7.0-a/gateway-provider-rewrite-func-header/pom.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-provider-rewrite-func-header/pom.xml	2016-08-02 13:20:41.507824908 +0400
@@ -0,0 +1,107 @@
+<?xml version="1.0" encoding="UTF-8"?>
+
+<!--
+  Licensed to the Apache Software Foundation (ASF) under one or more
+  contributor license agreements.  See the NOTICE file distributed with
+  this work for additional information regarding copyright ownership.
+  The ASF licenses this file to You under the Apache License, Version 2.0
+  (the "License"); you may not use this file except in compliance with
+  the License.  You may obtain a copy of the License at
+
+      http://www.apache.org/licenses/LICENSE-2.0
+
+  Unless required by applicable law or agreed to in writing, software
+  distributed under the License is distributed on an "AS IS" BASIS,
+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  See the License for the specific language governing permissions and
+  limitations under the License.
+-->
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
+    <modelVersion>4.0.0</modelVersion>
+    <parent>
+        <groupId>org.apache.knox</groupId>
+        <artifactId>gateway</artifactId>
+        <version>0.7.0</version>
+    </parent>
+    <artifactId>gateway-provider-rewrite-func-header</artifactId>
+
+    <name>gateway-provider-rewrite-func-header</name>
+    <description>An extension to the URL rewriter that provides a way to include header values in rewrite rules.</description>
+
+    <licenses>
+        <license>
+            <name>The Apache Software License, Version 2.0</name>
+            <url>http://www.apache.org/licenses/LICENSE-2.0.txt</url>
+            <distribution>repo</distribution>
+        </license>
+    </licenses>
+
+    <dependencies>
+
+        <dependency>
+            <groupId>${gateway-group}</groupId>
+            <artifactId>gateway-i18n</artifactId>
+        </dependency>
+        <dependency>
+            <groupId>${gateway-group}</groupId>
+            <artifactId>gateway-spi</artifactId>
+        </dependency>
+        <dependency>
+            <groupId>${gateway-group}</groupId>
+            <artifactId>gateway-provider-rewrite</artifactId>
+        </dependency>
+
+        <dependency>
+            <groupId>org.jboss.shrinkwrap</groupId>
+            <artifactId>shrinkwrap-api</artifactId>
+        </dependency>
+        <dependency>
+            <groupId>org.jboss.shrinkwrap</groupId>
+            <artifactId>shrinkwrap-impl-base</artifactId>
+        </dependency>
+        <dependency>
+            <groupId>org.jboss.shrinkwrap.descriptors</groupId>
+            <artifactId>shrinkwrap-descriptors-api-javaee</artifactId>
+        </dependency>
+        <dependency>
+            <groupId>org.jboss.shrinkwrap.descriptors</groupId>
+            <artifactId>shrinkwrap-descriptors-impl-javaee</artifactId>
+        </dependency>
+
+        <!-- ********** ********** ********** ********** ********** ********** -->
+        <!-- ********** Test Dependencies                           ********** -->
+        <!-- ********** ********** ********** ********** ********** ********** -->
+
+        <dependency>
+            <groupId>${gateway-group}</groupId>
+            <artifactId>gateway-test-utils</artifactId>
+            <scope>test</scope>
+        </dependency>
+
+        <dependency>
+            <groupId>org.hamcrest</groupId>
+            <artifactId>hamcrest-core</artifactId>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.hamcrest</groupId>
+            <artifactId>hamcrest-library</artifactId>
+            <scope>test</scope>
+        </dependency>
+
+        <!-- This must be after restassured otherwise is messes up the hamcrest dependencies. -->
+        <dependency>
+            <groupId>junit</groupId>
+            <artifactId>junit</artifactId>
+            <scope>test</scope>
+        </dependency>
+
+        <dependency>
+            <groupId>org.easymock</groupId>
+            <artifactId>easymock</artifactId>
+            <scope>test</scope>
+        </dependency>
+
+    </dependencies>
+
+</project>
diff -uNr knox-0.7.0-a/gateway-provider-rewrite-func-header/src/main/java/org/apache/hadoop/gateway/header/api/HeaderFunctionDescriptor.java knox-0.7.0-b/gateway-provider-rewrite-func-header/src/main/java/org/apache/hadoop/gateway/header/api/HeaderFunctionDescriptor.java
--- knox-0.7.0-a/gateway-provider-rewrite-func-header/src/main/java/org/apache/hadoop/gateway/header/api/HeaderFunctionDescriptor.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-provider-rewrite-func-header/src/main/java/org/apache/hadoop/gateway/header/api/HeaderFunctionDescriptor.java	2016-08-02 13:20:41.506824884 +0400
@@ -0,0 +1,31 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.header.api;
+
+import org.apache.hadoop.gateway.filter.rewrite.api.UrlRewriteFunctionDescriptor;
+
+public class HeaderFunctionDescriptor implements UrlRewriteFunctionDescriptor<HeaderFunctionDescriptor> {
+
+  public static final String FUNCTION_NAME = "header";
+
+  @Override
+  public String name() {
+    return FUNCTION_NAME;
+  }
+
+}
diff -uNr knox-0.7.0-a/gateway-provider-rewrite-func-header/src/main/java/org/apache/hadoop/gateway/header/impl/HeaderFunctionProcessor.java knox-0.7.0-b/gateway-provider-rewrite-func-header/src/main/java/org/apache/hadoop/gateway/header/impl/HeaderFunctionProcessor.java
--- knox-0.7.0-a/gateway-provider-rewrite-func-header/src/main/java/org/apache/hadoop/gateway/header/impl/HeaderFunctionProcessor.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-provider-rewrite-func-header/src/main/java/org/apache/hadoop/gateway/header/impl/HeaderFunctionProcessor.java	2016-08-02 13:20:41.506824884 +0400
@@ -0,0 +1,61 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.header.impl;
+
+import org.apache.hadoop.gateway.filter.rewrite.api.UrlRewriteEnvironment;
+import org.apache.hadoop.gateway.filter.rewrite.spi.UrlRewriteContext;
+import org.apache.hadoop.gateway.filter.rewrite.spi.UrlRewriteFunctionProcessor;
+import org.apache.hadoop.gateway.header.api.HeaderFunctionDescriptor;
+
+import java.util.Collections;
+import java.util.List;
+
+public class HeaderFunctionProcessor
+    implements UrlRewriteFunctionProcessor<HeaderFunctionDescriptor> {
+
+  @Override
+  public String name() {
+    return HeaderFunctionDescriptor.FUNCTION_NAME;
+  }
+
+  @Override
+  public void initialize( UrlRewriteEnvironment environment, HeaderFunctionDescriptor descriptor ) throws Exception {
+  }
+
+  @Override
+  public void destroy() throws Exception {
+  }
+
+  @Override
+  public List<String> resolve( UrlRewriteContext context, List<String> parameters ) throws Exception {
+    if( parameters == null || parameters.size() == 0 ) {
+      return Collections.emptyList();
+    } else {
+      switch( context.getDirection() ) {
+        case IN:
+          return context.getParameters().resolve( "request.header." + parameters.get( 0 ) );
+        case OUT:
+          return context.getParameters().resolve( "response.header." + parameters.get( 0 ) );
+        default:
+          return Collections.emptyList();
+      }
+    }
+  }
+
+}
+
diff -uNr knox-0.7.0-a/gateway-provider-rewrite-func-header/src/main/resources/META-INF/services/org.apache.hadoop.gateway.filter.rewrite.api.UrlRewriteFunctionDescriptor knox-0.7.0-b/gateway-provider-rewrite-func-header/src/main/resources/META-INF/services/org.apache.hadoop.gateway.filter.rewrite.api.UrlRewriteFunctionDescriptor
--- knox-0.7.0-a/gateway-provider-rewrite-func-header/src/main/resources/META-INF/services/org.apache.hadoop.gateway.filter.rewrite.api.UrlRewriteFunctionDescriptor	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-provider-rewrite-func-header/src/main/resources/META-INF/services/org.apache.hadoop.gateway.filter.rewrite.api.UrlRewriteFunctionDescriptor	2016-08-02 13:20:41.504824836 +0400
@@ -0,0 +1,19 @@
+##########################################################################
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+##########################################################################
+
+org.apache.hadoop.gateway.header.api.HeaderFunctionDescriptor
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-provider-rewrite-func-header/src/main/resources/META-INF/services/org.apache.hadoop.gateway.filter.rewrite.spi.UrlRewriteFunctionProcessor knox-0.7.0-b/gateway-provider-rewrite-func-header/src/main/resources/META-INF/services/org.apache.hadoop.gateway.filter.rewrite.spi.UrlRewriteFunctionProcessor
--- knox-0.7.0-a/gateway-provider-rewrite-func-header/src/main/resources/META-INF/services/org.apache.hadoop.gateway.filter.rewrite.spi.UrlRewriteFunctionProcessor	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-provider-rewrite-func-header/src/main/resources/META-INF/services/org.apache.hadoop.gateway.filter.rewrite.spi.UrlRewriteFunctionProcessor	2016-08-02 13:20:41.504824836 +0400
@@ -0,0 +1,19 @@
+##########################################################################
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+##########################################################################
+
+org.apache.hadoop.gateway.header.impl.HeaderFunctionProcessor
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-provider-security-jwt/pom.xml knox-0.7.0-b/gateway-provider-security-jwt/pom.xml
--- knox-0.7.0-a/gateway-provider-security-jwt/pom.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-provider-security-jwt/pom.xml	2016-08-02 13:20:40.570803006 +0400
@@ -52,6 +51,11 @@
         </dependency>
 
         <dependency>
+            <groupId>com.thetransactioncompany</groupId>
+            <artifactId>cors-filter</artifactId>
+        </dependency>
+
+        <dependency>
             <groupId>commons-io</groupId>
             <artifactId>commons-io</artifactId>
         </dependency>
diff -uNr knox-0.7.0-a/gateway-provider-security-shiro/pom.xml knox-0.7.0-b/gateway-provider-security-shiro/pom.xml
--- knox-0.7.0-a/gateway-provider-security-shiro/pom.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-provider-security-shiro/pom.xml	2016-08-02 13:20:41.405822522 +0400
@@ -88,6 +87,12 @@
         </dependency>
 
         <dependency>
+            <groupId>org.kohsuke</groupId>
+            <artifactId>libpam4j</artifactId>
+            <version>1.8</version>
+        </dependency>
+
+        <dependency>
             <groupId>org.apache.knox</groupId>
             <artifactId>gateway-test-utils</artifactId>
             <scope>test</scope>
diff -uNr knox-0.7.0-a/gateway-provider-security-shiro/src/main/java/org/apache/hadoop/gateway/filter/ShiroSubjectIdentityAdapter.java knox-0.7.0-b/gateway-provider-security-shiro/src/main/java/org/apache/hadoop/gateway/filter/ShiroSubjectIdentityAdapter.java
--- knox-0.7.0-a/gateway-provider-security-shiro/src/main/java/org/apache/hadoop/gateway/filter/ShiroSubjectIdentityAdapter.java	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-provider-security-shiro/src/main/java/org/apache/hadoop/gateway/filter/ShiroSubjectIdentityAdapter.java	2016-08-02 13:20:41.399822383 +0400
@@ -42,6 +42,7 @@
 import org.apache.hadoop.gateway.security.PrimaryPrincipal;
 import org.apache.shiro.SecurityUtils;
 import org.apache.shiro.subject.Subject;
+import org.apache.shiro.mgt.SecurityManager;
 
 public class ShiroSubjectIdentityAdapter implements Filter {
   
@@ -68,7 +69,7 @@
     // we use shiro authorization realm to look up groups
     subject.hasRole("authenticatedUser");
     
-    final String principalName = (String) subject.getPrincipal();
+    final String principalName = (String) subject.getPrincipal().toString();
 
     CallableChain callableChain = new CallableChain(request, response, chain);
     SecurityUtils.getSubject().execute(callableChain);
@@ -95,7 +96,7 @@
         }
       };
       Subject shiroSubject = SecurityUtils.getSubject();
-      final String principal = (String) shiroSubject.getPrincipal();
+      final String principal = (String) shiroSubject.getPrincipal().toString();
       HashSet emptySet = new HashSet();
       Set<Principal> principals = new HashSet<Principal>();
       Principal p = new PrimaryPrincipal(principal);
@@ -104,13 +105,33 @@
       String sourceUri = (String)request.getAttribute( AbstractGatewayFilter.SOURCE_REQUEST_CONTEXT_URL_ATTRIBUTE_NAME );
       auditor.audit( Action.AUTHENTICATION , sourceUri, ResourceType.URI, ActionOutcome.SUCCESS );
 
+      // Returns the security manager accessible to the calling code.
+      //
+      SecurityManager securityManager = SecurityUtils.getSecurityManager();
+      // 
+      // Sets a VM (static) singleto SecurityManager, specifically for transparent use in the getSubect() method
+      // of SecurityUtils. This is used since when Knox calls a filter running in a different thread there is no way
+      // to save an instance of a SecurityManager thus we need a way to get one.
+      SecurityUtils.setSecurityManager(securityManager);
+
       Set<String> userGroups = null;
       // map ldap groups saved in session to Java Subject GroupPrincipal(s)
       if (SecurityUtils.getSubject().getSession().getAttribute(SUBJECT_USER_GROUPS) != null) {
         userGroups = (Set<String>)SecurityUtils.getSubject().getSession().getAttribute(SUBJECT_USER_GROUPS);
-      } else {
-        userGroups = new HashSet<String>(shiroSubject.getPrincipals().asSet());
-        userGroups.remove(principal);
+      } else { // LDAP Shiro case
+        if(  shiroSubject.getPrincipal() instanceof String ) { 
+           userGroups = new HashSet<String>(shiroSubject.getPrincipals().asSet());
+           userGroups.remove(principal);
+        } else { // PAM Shiro case
+           Set<Principal> shiroPrincipals = new HashSet<Principal>(shiroSubject.getPrincipals().asSet());
+           userGroups = new HashSet<String>(); // Here we are creating a new UserGroup
+                                               // so we don't need to remove a Principal
+                                               // In the case of LDAP the userGroup may have already Principal
+                                               // added to the list of groups, so it is not needed.
+           for( Principal shiroPincipal: shiroPrincipals ) {
+                userGroups.add(shiroPincipal.toString() );
+           }
+        }
       }
       for (String userGroup : userGroups) {
         Principal gp = new GroupPrincipal(userGroup);
diff -uNr knox-0.7.0-a/gateway-provider-security-shiro/src/main/java/org/apache/hadoop/gateway/shirorealm/KnoxPamRealm.java knox-0.7.0-b/gateway-provider-security-shiro/src/main/java/org/apache/hadoop/gateway/shirorealm/KnoxPamRealm.java
--- knox-0.7.0-a/gateway-provider-security-shiro/src/main/java/org/apache/hadoop/gateway/shirorealm/KnoxPamRealm.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-provider-security-shiro/src/main/java/org/apache/hadoop/gateway/shirorealm/KnoxPamRealm.java	2016-08-02 13:20:41.401822430 +0400
@@ -0,0 +1,144 @@
+/*
+ *  Licensed to the Apache Software Foundation (ASF) under one
+ *  or more contributor license agreements.  See the NOTICE file
+ *  distributed with this work for additional information
+ *  regarding copyright ownership.  The ASF licenses this file
+ *  to you under the Apache License, Version 2.0 (the
+ *  "License"); you may not use this file except in compliance
+ *  with the License.  You may obtain a copy of the License at
+ *
+ *        http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing,
+ *  software distributed under the License is distributed on an
+ *  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ *  KIND, either express or implied.  See the License for the
+ *  specific language governing permissions and limitations
+ *  under the License.
+ */
+
+package org.apache.hadoop.gateway.shirorealm;
+import java.util.LinkedHashSet;
+import java.util.Set;
+import java.security.Principal;
+
+import org.apache.shiro.ShiroException;
+import org.apache.shiro.authc.AuthenticationException;
+import org.apache.shiro.authc.AuthenticationInfo;
+import org.apache.shiro.authc.AuthenticationToken;
+import org.apache.shiro.authc.SimpleAuthenticationInfo;
+import org.apache.shiro.authc.UsernamePasswordToken;
+import org.apache.shiro.authz.AuthorizationInfo;
+import org.apache.shiro.authz.SimpleAuthorizationInfo;
+import org.apache.shiro.realm.AuthorizingRealm;
+import org.apache.shiro.subject.PrincipalCollection;
+import org.jvnet.libpam.PAM;
+import org.jvnet.libpam.PAMException;
+import org.jvnet.libpam.UnixUser;
+
+/**
+ * A Unix-style <a href="http://www.kernel.org/pub/linux/libs/pam/index.html">PAM</a> 
+ * {@link org.apache.shiro.realm.Realm Realm} that uses <a href="https://github.com/kohsuke/libpam4j">libpam4j</a>
+ * to interface with the PAM system libraries.
+ * <p>
+ * This is a single Shiro {@code Realm} that interfaces with the OS's {@code PAM} subsystem which itself
+ * can be connected to several authentication methods (unix-crypt, LDAP, etc.)
+ * <p>
+ * This {@code Realm} can also take part in Shiro's Pluggable Realms concept.
+ * <p>
+ * Using a {@code KnoxPamRealm} requires a PAM {@code service} name. This is the name of the file under
+ * {@code /etc/pam.d} that is used to initialise and configure the PAM subsytem. Normally, this file reflects
+ * the application using it. For example {@code gdm}, {@code su}, etc. There is no default value for this propery.
+ * <p>
+ * For example, defining this realm in Shiro .ini:
+ * <pre>
+ * [main]
+ * pamRealm = org.apache.shiro.realm.libpam4j.KnoxPamRealm
+ * pamRealm.service = my-app
+ * </pre>
+ * 
+ * @author philippe.laflamme@gmail.com
+ */
+public class KnoxPamRealm extends AuthorizingRealm {
+
+	private String service;
+
+	public void setService(String service) {
+		this.service = service;
+	}
+
+	@Override
+	protected AuthorizationInfo doGetAuthorizationInfo(
+			PrincipalCollection principals) {
+		Set<String> roles = new LinkedHashSet<String>();
+
+		UnixUserPrincipal user = principals.oneByType(UnixUserPrincipal.class);
+		if (user != null) {
+			roles.addAll(user.getUnixUser().getGroups());
+		}
+		return new SimpleAuthorizationInfo(roles);
+	}
+
+	@Override
+	protected AuthenticationInfo doGetAuthenticationInfo(
+			AuthenticationToken token) throws AuthenticationException {
+		UsernamePasswordToken upToken = (UsernamePasswordToken) token;
+		UnixUser user;
+		try {
+			user = getPam().authenticate(upToken.getUsername(),
+					new String(upToken.getPassword()));
+		} catch (PAMException e) {
+			// Until libpam4j provides more details, we can only throw the top-level exception
+			throw new AuthenticationException(e);
+		}
+		return new SimpleAuthenticationInfo(new UnixUserPrincipal(user), upToken.getPassword(),
+				getName());
+	}
+
+	@Override
+	protected void onInit() {
+		super.onInit();
+		try {
+			// Tests PAM "connectivity"
+			getPam();
+		} catch (PAMException e) {
+			throw new ShiroException("Cannot obtain PAM subsystem.", e);
+		}
+	}
+
+	/**
+	 * Returns a {@code PAM} instance for the configured {@code service}.
+	 * <p>
+	 * Note that {@code PAM} instances are not reusable.
+	 * 
+	 * @return an instance of {@code PAM} usable for authenticating users
+	 * @throws PAMException when something bad happens
+	 */
+	protected PAM getPam() throws PAMException {
+		// PAM instances are not reusable.
+		return new PAM(service);
+	}
+
+	private static class UnixUserPrincipal implements Principal {
+
+		private final UnixUser userName;
+		public UnixUserPrincipal(UnixUser userName) {
+			this.userName = userName;
+		}
+		
+		public UnixUser getUnixUser() {
+			return userName;
+		}
+                
+                @Override
+                public String getName() {
+                   return userName.getUserName();   
+                }
+		
+		@Override
+		public String toString() {
+			//return String.valueOf( userName.getUserName() + ":" + userName.getUID());
+			return String.valueOf( userName.getUserName());
+		}
+	}
+}
diff -uNr knox-0.7.0-a/gateway-release/home/bin/gateway.cmd knox-0.7.0-b/gateway-release/home/bin/gateway.cmd
--- knox-0.7.0-a/gateway-release/home/bin/gateway.cmd	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-release/home/bin/gateway.cmd	2016-08-02 13:20:41.198817684 +0400
@@ -1,41 +1,41 @@
-@echo off
-REM Licensed to the Apache Software Foundation (ASF) under one or more
-REM contributor license agreements. See the NOTICE file distributed with
-REM this work for additional information regarding copyright ownership.
-REM The ASF licenses this file to You under the Apache License, Version 2.0
-REM (the "License"); you may not use this file except in compliance with
-REM the License. You may obtain a copy of the License at
-REM
-REM http://www.apache.org/licenses/LICENSE-2.0
-REM
-REM Unless required by applicable law or agreed to in writing, software
-REM distributed under the License is distributed on an "AS IS" BASIS,
-REM WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-REM See the License for the specific language governing permissions and
-REM limitations under the License.
-
-REM Start/stop script location
-set APP_BIN_DIR=%~dp0
-
-REM The app's jar name
-set APP_JAR=%APP_BIN_DIR%gateway.jar
-
-if not exist "%JAVA_HOME%"\bin\java.exe (
-  echo Error: JAVA_HOME is incorrectly set.
-  exit /b 1
-)
-set JAVA=%JAVA_HOME%\bin\java
-
-if "%1" == "--service" (
-  echo ^<service^>
-  echo   ^<id^>knox-gateway^</id^>
-  echo   ^<name^>knox-gateway^</name^>
-  echo   ^<description^>This service runs the Knox Gateway^</description^>
-  echo   ^<executable^>%JAVA%^</executable^>
-  echo   ^<arguments^>-jar "%APP_JAR%"^</arguments^>
-  echo ^</service^>
-  exit /b 0
-)
-
-"%JAVA%" -jar "%APP_JAR%"
+@echo off
+REM Licensed to the Apache Software Foundation (ASF) under one or more
+REM contributor license agreements. See the NOTICE file distributed with
+REM this work for additional information regarding copyright ownership.
+REM The ASF licenses this file to You under the Apache License, Version 2.0
+REM (the "License"); you may not use this file except in compliance with
+REM the License. You may obtain a copy of the License at
+REM
+REM http://www.apache.org/licenses/LICENSE-2.0
+REM
+REM Unless required by applicable law or agreed to in writing, software
+REM distributed under the License is distributed on an "AS IS" BASIS,
+REM WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+REM See the License for the specific language governing permissions and
+REM limitations under the License.
+
+REM Start/stop script location
+set APP_BIN_DIR=%~dp0
+
+REM The app's jar name
+set APP_JAR=%APP_BIN_DIR%gateway.jar
+
+if not exist "%JAVA_HOME%"\bin\java.exe (
+  echo Error: JAVA_HOME is incorrectly set.
+  exit /b 1
+)
+set JAVA=%JAVA_HOME%\bin\java
+
+if "%1" == "--service" (
+  echo ^<service^>
+  echo   ^<id^>knox-gateway^</id^>
+  echo   ^<name^>knox-gateway^</name^>
+  echo   ^<description^>This service runs the Knox Gateway^</description^>
+  echo   ^<executable^>%JAVA%^</executable^>
+  echo   ^<arguments^>-jar "%APP_JAR%"^</arguments^>
+  echo ^</service^>
+  exit /b 0
+)
+
+"%JAVA%" -jar "%APP_JAR%"
 exit /b %ERRORLEVEL%
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-release/home/bin/gateway.sh knox-0.7.0-b/gateway-release/home/bin/gateway.sh
--- knox-0.7.0-a/gateway-release/home/bin/gateway.sh	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-release/home/bin/gateway.sh	2016-08-02 13:20:41.199817708 +0400
@@ -48,7 +48,10 @@
 APP_LOG_OPTS=""
 
 # The app's memory options
-APP_MEM_OPTS=""
+APP_MEM_OPTS="-Xms512m -Xmx2G"
+
+# Additional security options
+APP_SEC_OPTS="-Djdk.tls.ephemeralDHKeySize=2048 "
 
 # The app's debugging options
 APP_DBG_OPTS=""
@@ -118,7 +121,7 @@
    
    rm -f $APP_PID_FILE
 
-   nohup $JAVA $APP_MEM_OPTS $APP_DBG_OPTS $APP_LOG_OPTS -jar $APP_JAR >>$APP_OUT_FILE 2>>$APP_ERR_FILE & printf $!>$APP_PID_FILE || exit 1
+   nohup $JAVA $APP_MEM_OPTS $APP_SEC_OPTS $APP_DBG_OPTS $APP_LOG_OPTS -jar $APP_JAR >>$APP_OUT_FILE 2>>$APP_ERR_FILE & printf $!>$APP_PID_FILE || exit 1
 
    getPID
    for ((i=0; i<APP_START_WAIT_TIME*10; i++)); do
diff -uNr knox-0.7.0-a/gateway-release/home/bin/knoxcli.cmd knox-0.7.0-b/gateway-release/home/bin/knoxcli.cmd
--- knox-0.7.0-a/gateway-release/home/bin/knoxcli.cmd	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-release/home/bin/knoxcli.cmd	2016-08-02 13:20:41.201817756 +0400
@@ -1,35 +1,35 @@
-@echo off
-REM  Licensed to the Apache Software Foundation (ASF) under one or more
-REM  contributor license agreements.  See the NOTICE file distributed with
-REM  this work for additional information regarding copyright ownership.
-REM  The ASF licenses this file to You under the Apache License, Version 2.0
-REM  (the "License"); you may not use this file except in compliance with
-REM  the License.  You may obtain a copy of the License at
-REM
-REM      http://www.apache.org/licenses/LICENSE-2.0
-REM
-REM  Unless required by applicable law or agreed to in writing, software
-REM  distributed under the License is distributed on an "AS IS" BASIS,
-REM  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-REM  See the License for the specific language governing permissions and
-REM  limitations under the License.
-
-REM Start/stop script location
-set APP_BIN_DIR=%~dp0
-
-REM The app's jar name
-set APP_JAR=%APP_BIN_DIR%knoxcli.jar
-
-if not exist "%JAVA_HOME%"\bin\java.exe (
-  echo Error: JAVA_HOME is incorrectly set.
-  exit /B 1
-)
-set JAVA=%JAVA_HOME%\bin\java
-
-"%JAVA%" -jar "%APP_JAR%" %*
-
-if not %ERRORLEVEL% == 0 (
-  exit /B %ERRORLEVEL%
-)
-
-exit /B 0
+@echo off
+REM  Licensed to the Apache Software Foundation (ASF) under one or more
+REM  contributor license agreements.  See the NOTICE file distributed with
+REM  this work for additional information regarding copyright ownership.
+REM  The ASF licenses this file to You under the Apache License, Version 2.0
+REM  (the "License"); you may not use this file except in compliance with
+REM  the License.  You may obtain a copy of the License at
+REM
+REM      http://www.apache.org/licenses/LICENSE-2.0
+REM
+REM  Unless required by applicable law or agreed to in writing, software
+REM  distributed under the License is distributed on an "AS IS" BASIS,
+REM  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+REM  See the License for the specific language governing permissions and
+REM  limitations under the License.
+
+REM Start/stop script location
+set APP_BIN_DIR=%~dp0
+
+REM The app's jar name
+set APP_JAR=%APP_BIN_DIR%knoxcli.jar
+
+if not exist "%JAVA_HOME%"\bin\java.exe (
+  echo Error: JAVA_HOME is incorrectly set.
+  exit /B 1
+)
+set JAVA=%JAVA_HOME%\bin\java
+
+"%JAVA%" -jar "%APP_JAR%" %*
+
+if not %ERRORLEVEL% == 0 (
+  exit /B %ERRORLEVEL%
+)
+
+exit /B 0
diff -uNr knox-0.7.0-a/gateway-release/home/bin/ldap.cmd knox-0.7.0-b/gateway-release/home/bin/ldap.cmd
--- knox-0.7.0-a/gateway-release/home/bin/ldap.cmd	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-release/home/bin/ldap.cmd	2016-08-02 13:20:41.196817638 +0400
@@ -1,47 +1,47 @@
-@echo off
-REM Licensed to the Apache Software Foundation (ASF) under one or more
-REM contributor license agreements. See the NOTICE file distributed with
-REM this work for additional information regarding copyright ownership.
-REM The ASF licenses this file to You under the Apache License, Version 2.0
-REM (the "License"); you may not use this file except in compliance with
-REM the License. You may obtain a copy of the License at
-REM
-REM http://www.apache.org/licenses/LICENSE-2.0
-REM
-REM Unless required by applicable law or agreed to in writing, software
-REM distributed under the License is distributed on an "AS IS" BASIS,
-REM WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-REM See the License for the specific language governing permissions and
-REM limitations under the License.
-
-REM Script location
-set APP_BIN_DIR=%~dp0
-
-REM  The app's home dir
-set APP_HOME_DIR=%APP_BIN_DIR:~0,-5%
-
-REM The apps conf dir
-set APP_CONF_DIR=%APP_HOME_DIR%\conf
-
-REM The app's jar name
-set APP_JAR=%APP_BIN_DIR%ldap.jar
-
-if not exist "%JAVA_HOME%"\bin\java.exe (
-  echo Error: JAVA_HOME is incorrectly set.
-  exit /b 1
-)
-set JAVA=%JAVA_HOME%\bin\java
-
-if "%1" == "--service" (
-  @echo ^<service^>
-  @echo   ^<id^>knox-demo-ldap^</id^>
-  @echo   ^<name^>knox-demo-ldap^</name^>
-  @echo   ^<description^>This service runs the Knox demonstration LDAP server^</description^>
-  @echo   ^<executable^>%JAVA%^</executable^>
-  @echo   ^<arguments^>-jar "%APP_JAR%" "%APP_CONF_DIR%"^</arguments^>
-  @echo ^</service^>
-  exit /b 0
-)
-
-"%JAVA%" -jar "%APP_JAR%" "%APP_CONF_DIR%"
+@echo off
+REM Licensed to the Apache Software Foundation (ASF) under one or more
+REM contributor license agreements. See the NOTICE file distributed with
+REM this work for additional information regarding copyright ownership.
+REM The ASF licenses this file to You under the Apache License, Version 2.0
+REM (the "License"); you may not use this file except in compliance with
+REM the License. You may obtain a copy of the License at
+REM
+REM http://www.apache.org/licenses/LICENSE-2.0
+REM
+REM Unless required by applicable law or agreed to in writing, software
+REM distributed under the License is distributed on an "AS IS" BASIS,
+REM WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+REM See the License for the specific language governing permissions and
+REM limitations under the License.
+
+REM Script location
+set APP_BIN_DIR=%~dp0
+
+REM  The app's home dir
+set APP_HOME_DIR=%APP_BIN_DIR:~0,-5%
+
+REM The apps conf dir
+set APP_CONF_DIR=%APP_HOME_DIR%\conf
+
+REM The app's jar name
+set APP_JAR=%APP_BIN_DIR%ldap.jar
+
+if not exist "%JAVA_HOME%"\bin\java.exe (
+  echo Error: JAVA_HOME is incorrectly set.
+  exit /b 1
+)
+set JAVA=%JAVA_HOME%\bin\java
+
+if "%1" == "--service" (
+  @echo ^<service^>
+  @echo   ^<id^>knox-demo-ldap^</id^>
+  @echo   ^<name^>knox-demo-ldap^</name^>
+  @echo   ^<description^>This service runs the Knox demonstration LDAP server^</description^>
+  @echo   ^<executable^>%JAVA%^</executable^>
+  @echo   ^<arguments^>-jar "%APP_JAR%" "%APP_CONF_DIR%"^</arguments^>
+  @echo ^</service^>
+  exit /b 0
+)
+
+"%JAVA%" -jar "%APP_JAR%" "%APP_CONF_DIR%"
 exit /b %ERRORLEVEL%
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-release/home/conf/knox-pam-ldap-service knox-0.7.0-b/gateway-release/home/conf/knox-pam-ldap-service
--- knox-0.7.0-a/gateway-release/home/conf/knox-pam-ldap-service	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-release/home/conf/knox-pam-ldap-service	2016-08-02 13:20:41.207817895 +0400
@@ -0,0 +1,70 @@
+##########################################################################
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+##########################################################################
+# Requirements
+# ============
+# This configuration file is specific to Linux, although it should work on most Unixes.
+#
+# Instructions
+# ============
+# 1. Place this file in /etc/pam.d
+# 2. Uncomment one of the Module configurations below
+# 3. change /etc/shadow to be readable by the user.
+#
+# Format of pam.d files
+# =====================
+#
+# The first column is the facility. Possible values are:
+# account - account management
+# auth - authentication management
+# password - password  management
+# session - session session management.
+#
+# The second column is the control flag,  which is how the result of the operation is to
+# be interpreted. Possible values are:
+#
+# required - If the module succeeds, the rest of the chain is executed, and the request is granted unless some other module fails. If the module fails, the rest of the chain is also executed, but the request is ultimately denied.
+# requisite - If the module succeeds, the rest of the chain is executed, and the request is granted unless some other module fails. If the module fails, the chain is immediately terminated and the request is denied.
+# sufficient - If the module succeeds and no earlier module in the chain has failed, the chain is immediately terminated and the request is granted. If the module fails, the module is ignored and the rest of the chain is executed.
+#
+# The third column is the path to the module to be used for the chain.
+#
+# The fourth column is optional. It is for any options to be passed to the module.
+#
+######################################################################
+#
+# Unix PAM Module -- multiuser
+# ===============
+#
+# Requirements: Requires /etc/shadow be made readable by the user executing java
+#
+#
+
+ auth      sufficient  /lib64/security/pam_unix.so
+ auth      sufficient  /lib64/security/pam_ldap.so minimum_uid=100 use_first_pass
+ auth      required    /lib64/security/pam_deny.so
+
+ account   sufficient  /lib64/security/pam_unix.so
+ account   sufficient  /lib64/security/pam_ldap.so minimum_uid=100
+ account   required    /lib64/security/pam_permit.so
+
+ session   required    /lib64/security/pam_unix.so
+ session   optional    /lib64/security/pam_ldap.so minimum_uid=100
+
+ password  sufficient  /lib64/security/pam_unix.so nullok md5 shadow use_authtok
+ password  sufficient  /lib64/security/pam_ldap.so minimum_uid=100 try_first_pass
+ password  required    /lib64/security/pam_deny.so
diff -uNr knox-0.7.0-a/gateway-release/home/conf/knox-pam-os-service knox-0.7.0-b/gateway-release/home/conf/knox-pam-os-service
--- knox-0.7.0-a/gateway-release/home/conf/knox-pam-os-service	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-release/home/conf/knox-pam-os-service	2016-08-02 13:20:41.205817848 +0400
@@ -0,0 +1,66 @@
+##########################################################################
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+##########################################################################
+# Requirements
+# ============
+# This configuration file is specific to Linux, although it should work on most Unixes.
+#
+# Instructions
+# ============
+# 1. Place this file in /etc/pam.d
+# 2. Uncomment one of the Module configurations below
+# 3. change /etc/shadow to be readable by the user.
+#
+# Format of pam.d files
+# =====================
+#
+# The first column is the facility. Possible values are:
+# account - account management
+# auth - authentication management
+# password - password  management
+# session - session session management.
+#
+# The second column is the control flag,  which is how the result of the operation is to
+# be interpreted. Possible values are:
+#
+# required - If the module succeeds, the rest of the chain is executed, and the request is granted unless some other module fails. If the module fails, the rest of the chain is also executed, but the request is ultimately denied.
+# requisite - If the module succeeds, the rest of the chain is executed, and the request is granted unless some other module fails. If the module fails, the chain is immediately terminated and the request is denied.
+# sufficient - If the module succeeds and no earlier module in the chain has failed, the chain is immediately terminated and the request is granted. If the module fails, the module is ignored and the rest of the chain is executed.
+#
+# The third column is the path to the module to be used for the chain.
+#
+# The fourth column is optional. It is for any options to be passed to the module.
+#
+######################################################################
+#
+# Unix PAM Module -- multiuser
+# ===============
+#
+# Requirements: Requires /etc/shadow be made readable by the user executing java
+#
+#
+
+ auth      sufficient  /lib64/security/pam_unix.so
+ auth      required    /lib64/security/pam_deny.so
+
+ account   sufficient  /lib64/security/pam_unix.so
+ account   required    /lib64/security/pam_permit.so
+
+ session   required    /lib64/security/pam_unix.so
+
+ password  sufficient  /lib64/security/pam_unix.so nullok md5 shadow use_authtok
+ password  required    /lib64/security/pam_deny.so
diff -uNr knox-0.7.0-a/gateway-release/home/conf/topologies/generate_template.py knox-0.7.0-b/gateway-release/home/conf/topologies/generate_template.py
--- knox-0.7.0-a/gateway-release/home/conf/topologies/generate_template.py	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-release/home/conf/topologies/generate_template.py	2016-08-02 13:20:41.205817848 +0400
@@ -0,0 +1,237 @@
+#!/usr/bin/env python
+"""
+Licensed to the Apache Software Foundation (ASF) under one
+or more contributor license agreements.  See the NOTICE file
+distributed with this work for additional information
+regarding copyright ownership.  The ASF licenses this file
+to you under the Apache License, Version 2.0 (the
+"License"); you may not use this file except in compliance
+with the License.  You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+
+KNOX create web interface topologies
+
+"""
+
+
+import os
+import sys
+import re
+from xml.dom.minidom import parse,  getDOMImplementation, parseString
+from xml.dom import minidom
+from xml.parsers.expat import ExpatError
+
+default_topology='./default.xml'
+
+knoxPathMap={ 
+               "FALCONUI":"falconui.xml", 
+               "OOZIEUI":"oozieui.xml",
+               "GANGLIAUI":"gangliaui.xml",
+               "NAGIOSUI":"nagiosui.xml",
+               "HBASEUI":"hbaseui.xml",
+               "SPARKUI":"sparkui.xml",
+               "JOBSTORYUI":"jobstoryui.xml",
+               "YARNUI":"yarnui.xml",
+               "NODEUI":"nodemanagerui.xml",
+               "THRIFTSERVERUI":"thriftserverui.xml"
+            }
+
+#
+# create_topology function creates a topology file used
+# by Knox
+#
+
+#
+# generates one topology file for OS UI
+#
+def create_topology(service_key, gateway, service_dom ) :
+#
+# Create a new dom 
+#
+   impl = getDOMImplementation()
+   doc = impl.createDocument(None, "topology", None)
+   top_element = doc.documentElement
+#
+# Create topology element inside document
+#
+   top_element.appendChild(gateway)
+   top_element.appendChild(service_dom)
+   doc.writexml( open(knoxPathMap[service_key], 'w'), indent="", addindent="" ) 
+   return
+
+#
+# create all the new OS UI topology files
+#
+def create_topology_files():
+   dom_default = parse(default_topology)
+
+   #
+   #  Get gateway element with topology ldap, and provider informatio
+   #  The gateway information is common to all of them
+   #
+   gateway = dom_default.getElementsByTagName('gateway')[0]
+
+   services = dom_default.getElementsByTagName('service')
+
+
+   for key in  knoxPathMap:
+      for service in services:
+          role = service.getElementsByTagName('role')
+          if( role[0].firstChild.data  == key ):
+
+              if( os.path.isfile( './' + knoxPathMap[key] ) ):
+                  os.remove('./' + knoxPathMap[key]) 
+              create_topology(key, gateway, service)
+
+   return
+
+#
+# remove all UI service defintions from default xml
+# except HDFSUI
+#
+def remove_created_topology_from_default(): 
+   dom_default = parse(default_topology)
+   services = dom_default.getElementsByTagName('service')
+
+   for key in  knoxPathMap:
+       for service in services:
+           role = service.getElementsByTagName('role')
+           if( role[0].firstChild.data  == key and key != "HDFSUI" ):
+              service.parentNode.removeChild(service)
+
+   dom_default.writexml( open(default_topology, 'w'), indent="", addindent="" ) 
+   return
+
+
+# get all serverces that have enabled ha
+#
+def getParameters(params):
+   length = len(params)
+   # if there is no ha parameter then just return 
+   if (length < 2):
+       return
+   HAservices = {}
+   for i in range(1, length):
+       # start from 1 because index 0 is the python file name
+       haparams = params[i].split(",")
+       #if there is a service that does not have at least two hostsname, then there is erro, just return
+       if len(haparams) < 3:
+          return
+       hosts = []
+       for j in range(1, len(haparams)):
+          hostname = haparams[j]
+          if len(hostname) > 0 :
+             hosts.append(hostname)
+
+       HAservices[haparams[0]] = hosts
+
+   addHaProvider(HAservices)
+   addServiceHostname(HAservices)       
+   beutify()
+   return
+   
+
+
+
+#
+# add HA providers for HA components
+#
+def addHaProvider(HAservices):
+   dom_default = parse(default_topology)
+
+   #
+   #  Get gateway element with topology ldap, and provider information
+   #  The gateway information is common to all of them
+   #
+   gateway = dom_default.getElementsByTagName('gateway')[0]
+
+   #services = dom_default.getElementsByTagName('service')
+   providers = gateway.getElementsByTagName('provider')
+   provider = providers[len(providers) - 1]
+   role = provider.getElementsByTagName('role')[0]
+
+   #rewrite if it already exit
+   if(role.firstChild.data == 'ha'):
+       provider.parentNode.removeChild(provider)
+
+   ha_provider = dom_default.createElement('provider')
+
+   role = dom_default.createElement('role')
+   role.appendChild(dom_default.createTextNode('ha'))
+
+   name = dom_default.createElement('name')
+   name.appendChild(dom_default.createTextNode('HaProvider'))
+
+   enabled = dom_default.createElement('enabled')
+   enabled.appendChild(dom_default.createTextNode('true'))
+
+   ha_provider.appendChild(role)
+   ha_provider.appendChild(name)
+   ha_provider.appendChild(enabled)
+   
+   for key in HAservices:
+       param = dom_default.createElement('param')
+       param_name = dom_default.createElement('name')
+       param_name.appendChild(dom_default.createTextNode(key))
+
+       # add default value for each HAservice    
+       value = dom_default.createElement('value')
+       value.appendChild(dom_default.createTextNode("maxFailoverAttempts=3;failoverSleep=1000;enabled=true"))
+
+       param.appendChild(param_name)
+       param.appendChild(value)
+       ha_provider.appendChild(param)
+
+
+   gateway.appendChild(ha_provider)
+   dom_default.writexml( open(default_topology, 'w'))
+   return 
+
+def addServiceHostname(HAservices):
+   dom_default = parse(default_topology)
+   services = dom_default.getElementsByTagName('service')
+   # iterate each service that enabled HA
+   for key in HAservices:
+       
+     # iterate services in the file to find the right place to insert multiple hostnames
+     for service in services:
+         role = service.getElementsByTagName('role')[0]
+         if (role.firstChild.data == key):
+             urls = service.getElementsByTagName('url')
+             for url in urls:
+                 service.removeChild(url)
+             # add all the hostsname, index 0 is the HAservice name so start from 1
+             for j in range(len(HAservices[key])):
+                 new_hostName = dom_default.createElement('url')
+                 new_hostName.appendChild(dom_default.createTextNode(HAservices[key][j]))
+                 service.appendChild(new_hostName)
+             # remove this service from the list so next time will not consider this modified service to be more efficient
+             services.remove(service)    
+
+   dom_default.writexml( open(default_topology, 'w'))
+   return 
+
+def beutify():
+   dom_default = parse(default_topology)
+   xmlToFormat = dom_default.toprettyxml(indent='  ')
+   defaultText = re.compile('>\n\s+([^<>\s].*?)\n\s+</', re.DOTALL)    
+   prettyXml = defaultText.sub('>\g<1></', xmlToFormat)
+   f =  open(default_topology, 'w')
+   f.write(prettyXml)
+   f.close()
+   return
+
+def main():
+   getParameters(sys.argv)
+   create_topology_files()
+   remove_created_topology_from_default()
+
+if __name__ == "__main__":
+    main()
diff -uNr knox-0.7.0-a/gateway-release/home/logs/.gitignore knox-0.7.0-b/gateway-release/home/logs/.gitignore
--- knox-0.7.0-a/gateway-release/home/logs/.gitignore	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-release/home/logs/.gitignore	2016-08-02 13:20:41.202817779 +0400
@@ -0,0 +1,19 @@
+##########################################################################
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+##########################################################################
+# Used to ensure this "empty" directory is included in binary distro
+!.gitignore
diff -uNr knox-0.7.0-a/gateway-release/home/pids/.gitignore knox-0.7.0-b/gateway-release/home/pids/.gitignore
--- knox-0.7.0-a/gateway-release/home/pids/.gitignore	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-release/home/pids/.gitignore	2016-08-02 13:20:41.201817756 +0400
@@ -0,0 +1,19 @@
+##########################################################################
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+##########################################################################
+# Used to ensure this "empty" directory is included in binary distro
+!.gitignore
diff -uNr knox-0.7.0-a/gateway-release/pom.xml knox-0.7.0-b/gateway-release/pom.xml
--- knox-0.7.0-a/gateway-release/pom.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-release/pom.xml	2016-08-02 13:20:41.213818035 +0400
@@ -172,6 +170,10 @@
         </dependency>
         <dependency>
             <groupId>${gateway-group}</groupId>
+            <artifactId>gateway-service-rm</artifactId>
+        </dependency>
+        <dependency>
+            <groupId>${gateway-group}</groupId>
             <artifactId>gateway-service-storm</artifactId>
         </dependency>
         <dependency>
diff -uNr knox-0.7.0-a/gateway-server/src/main/java/org/apache/hadoop/gateway/deploy/DeploymentContextImpl.java knox-0.7.0-b/gateway-server/src/main/java/org/apache/hadoop/gateway/deploy/DeploymentContextImpl.java
--- knox-0.7.0-a/gateway-server/src/main/java/org/apache/hadoop/gateway/deploy/DeploymentContextImpl.java	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-server/src/main/java/org/apache/hadoop/gateway/deploy/DeploymentContextImpl.java	2016-08-02 13:20:40.606803847 +0400
@@ -127,7 +127,7 @@
       provider.setName( name );
       provider.setEnabled( true );
     }
-    if( provider.isEnabled() ) {
+    if( provider.isEnabled() && contributor != null ) {
       contributor.contributeFilter( this, provider, service, resource, params );
     }
   }
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/falcon-ui/0.8.0.4.2/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/falcon-ui/0.8.0.4.2/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/falcon-ui/0.8.0.4.2/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/falcon-ui/0.8.0.4.2/rewrite.xml	2016-08-02 13:20:41.019813500 +0400
@@ -0,0 +1,33 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+    <rule dir="IN" name="FALCONUI/falcon/inbound/root" pattern="*://*:*/**/falcon/">
+        <rewrite template="{$serviceUrl[FALCONUI]}/"/>
+    </rule>
+    <rule dir="IN" name="FALCONUI/falcon/inbound/path" pattern="*://*:*/**/falcon/{**}">
+    <rewrite template="{$serviceUrl[FALCONUI]}/{**}"/>
+  </rule>
+<rule dir="IN" name="FALCONUI/falcon/inbound/path" pattern="*://*:*/**/api/{**}">
+    <rewrite template="{$serviceUrl[FALCONUI]}/api/{**}"/>
+  </rule>
+  <rule dir="IN" name="FALCONUI/falcon/inbound/path" pattern="*://*:*/**/api/{**}?{**}">
+    <rewrite template="{$serviceUrl[FALCONUI]}/api/{**}?{**}"/>
+</rule>
+  <rule dir="IN" name="FALCONUI/falcon/inbound/query" pattern="*://*:*/**/falcon/{**}?{**}">
+    <rewrite template="{$serviceUrl[FALCONUI]}/{**}?{**}"/>
+  </rule>
+</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/falcon-ui/0.8.0.4.2/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/falcon-ui/0.8.0.4.2/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/falcon-ui/0.8.0.4.2/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/falcon-ui/0.8.0.4.2/service.xml	2016-08-02 13:20:41.020813525 +0400
@@ -0,0 +1,32 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="FALCONUI" name="falcon" version="0.8.0.4.2">
+    <routes>
+        <route path="/falcon/"/>
+        <route path="/falcon/**"/>
+        <route path="/falcon/**?**"/>
+        <route path="/api/**"/>
+        <route path="/api/**?**"/>
+    </routes>
+    <testURLs>
+        <testURL>/falcon/api/admin/stack</testURL>
+        <testURL>/falcon/api/admin/version</testURL>
+        <testURL>/falcon/api/metadata/lineage/serialize</testURL>
+        <testURL>/falcon/api/metadata/lineage/vertices/all</testURL>
+        <testURL>/falcon/api/metadata/lineage/edges/all</testURL>
+    </testURLs>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase/0.98.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase/0.98.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase/0.98.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase/0.98.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,62 +0,0 @@
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-
-    <rule dir="IN" name="WEBHBASE/webhbase/root/inbound" pattern="*://*:*/**/hbase/?{**}">
-        <rewrite template="{$serviceUrl[WEBHBASE]}/?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="WEBHBASE/webhbase/path/inbound" pattern="*://*:*/**/hbase/{path=**}?{**}">
-        <rewrite template="{$serviceUrl[WEBHBASE]}/{path=**}?{**}"/>
-    </rule>
-
-    <rule name="WEBHBASE/webhbase/location/outbound">
-        <match pattern="*://*:*/{path=**}?{**}"/>
-        <rewrite template="{$frontend[url]}/hbase/{path=**}?{**}"/>
-    </rule>
-
-    <rule name="WEBHBASE/webhbase/address/outbound">
-        <match pattern="{host}:{port}"/>
-        <rewrite template="{$frontend[url]}/hbase-region?host={host}?port={port}"/>
-        <encrypt-query/>
-    </rule>
-
-    <filter name="WEBHBASE/webhbase/headers/outbound">
-        <content type="application/x-http-headers">
-            <apply path="Location" rule="WEBHBASE/webhbase/location/outbound"/>
-        </content>
-    </filter>
-
-    <filter name="WEBHBASE/webhbase/status/outbound">
-        <content type="*/json">
-            <apply path="$[LiveNodes][*][name]" rule="WEBHBASE/webhbase/address/outbound"/>
-        </content>
-        <content type="*/xml">
-            <apply path="/ClusterStatus/LiveNodes/Node/@name" rule="WEBHBASE/webhbase/address/outbound"/>
-        </content>
-    </filter>
-
-    <filter name="WEBHBASE/webhbase/regions/outbound">
-        <content type="*/json">
-            <apply path="$[Region][*][location]" rule="WEBHBASE/webhbase/address/outbound"/>
-        </content>
-        <content type="*/xml">
-            <apply path="/TableInfo/Region/@location" rule="WEBHBASE/webhbase/address/outbound"/>
-        </content>
-    </filter>
-
-</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase/0.98.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase/0.98.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase/0.98.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase/0.98.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,39 +0,0 @@
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="WEBHBASE" name="webhbase" version="0.98.0">
-    <routes>
-        <route path="/hbase/?**">
-            <rewrite apply="WEBHBASE/webhbase/headers/outbound" to="response.headers"/>
-        </route>
-        <route path="/hbase/**?**">
-            <rewrite apply="WEBHBASE/webhbase/headers/outbound" to="response.headers"/>
-        </route>
-        <route path="/hbase/status/cluster?**">
-            <rewrite apply="WEBHBASE/webhbase/status/outbound" to="response.body"/>
-        </route>
-        <route path="/hbase/*/regions?**">
-            <rewrite apply="WEBHBASE/webhbase/regions/outbound" to="response.body"/>
-        </route>
-    </routes>
-    <dispatch classname="org.apache.hadoop.gateway.hbase.HBaseDispatch"/>
-    <testURLs>
-        <testURL>/hbase/version</testURL>
-        <testURL>/hbase/version/cluster</testURL>
-        <testURL>/hbase/status/cluster</testURL>
-        <testURL>/hbase</testURL>
-    </testURLs>
-</service>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase/0.98.0.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase/0.98.0.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase/0.98.0.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase/0.98.0.1/rewrite.xml	2016-08-02 13:20:41.021813549 +0400
@@ -0,0 +1,62 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+
+    <rule dir="IN" name="WEBHBASE/webhbase/root/inbound" pattern="*://*:*/**/hbase/?{**}">
+        <rewrite template="{$serviceUrl[WEBHBASE]}/?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="WEBHBASE/webhbase/path/inbound" pattern="*://*:*/**/hbase/{path=**}?{**}">
+        <rewrite template="{$serviceUrl[WEBHBASE]}/{path=**}?{**}"/>
+    </rule>
+
+    <rule name="WEBHBASE/webhbase/location/outbound">
+        <match pattern="*://*:*/{path=**}?{**}"/>
+        <rewrite template="{$frontend[url]}/hbase/{path=**}?{**}"/>
+    </rule>
+
+    <rule name="WEBHBASE/webhbase/address/outbound">
+        <match pattern="{host}:{port}"/>
+        <rewrite template="{$frontend[url]}/hbase-region?host={host}?port={port}"/>
+        <encrypt-query/>
+    </rule>
+
+    <filter name="WEBHBASE/webhbase/headers/outbound">
+        <content type="application/x-http-headers">
+            <apply path="Location" rule="WEBHBASE/webhbase/location/outbound"/>
+        </content>
+    </filter>
+
+    <filter name="WEBHBASE/webhbase/status/outbound">
+        <content type="*/json">
+            <apply path="$[LiveNodes][*][name]" rule="WEBHBASE/webhbase/address/outbound"/>
+        </content>
+        <content type="*/xml">
+            <apply path="/ClusterStatus/LiveNodes/Node/@name" rule="WEBHBASE/webhbase/address/outbound"/>
+        </content>
+    </filter>
+
+    <filter name="WEBHBASE/webhbase/regions/outbound">
+        <content type="*/json">
+            <apply path="$[Region][*][location]" rule="WEBHBASE/webhbase/address/outbound"/>
+        </content>
+        <content type="*/xml">
+            <apply path="/TableInfo/Region/@location" rule="WEBHBASE/webhbase/address/outbound"/>
+        </content>
+    </filter>
+
+</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase/0.98.0.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase/0.98.0.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase/0.98.0.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase/0.98.0.1/service.xml	2016-08-02 13:20:41.021813549 +0400
@@ -0,0 +1,39 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="WEBHBASE" name="webhbase" version="0.98.0.1">
+    <routes>
+        <route path="/hbase/?**">
+            <rewrite apply="WEBHBASE/webhbase/headers/outbound" to="response.headers"/>
+        </route>
+        <route path="/hbase/**?**">
+            <rewrite apply="WEBHBASE/webhbase/headers/outbound" to="response.headers"/>
+        </route>
+        <route path="/hbase/status/cluster?**">
+            <rewrite apply="WEBHBASE/webhbase/status/outbound" to="response.body"/>
+        </route>
+        <route path="/hbase/*/regions?**">
+            <rewrite apply="WEBHBASE/webhbase/regions/outbound" to="response.body"/>
+        </route>
+    </routes>
+    <dispatch classname="org.apache.hadoop.gateway.hbase.HBaseDispatch"/>
+    <testURLs>
+        <testURL>/hbase/version</testURL>
+        <testURL>/hbase/version/cluster</testURL>
+        <testURL>/hbase/status/cluster</testURL>
+        <testURL>/hbase</testURL>
+    </testURLs>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbaseui/1.1.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbaseui/1.1.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbaseui/1.1.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbaseui/1.1.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,105 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-
-  <rule dir="IN" name="HBASEUI/hbase/inbound/master/root" pattern="*://*:*/**/hbase/webui">
-    <rewrite template="{$serviceUrl[HBASEUI]}/master-status"/>
-  </rule>
-  <rule dir="IN" name="HBASEUI/hbase/inbound/master/path" pattern="*://*:*/**/hbase/webui/{**}">
-    <rewrite template="{$serviceUrl[HBASEUI]}/{**}"/>
-  </rule>
-  <rule dir="IN" name="HBASEUI/hbase/inbound/master/query" pattern="*://*:*/**/hbase/webui/{**}?{**}">
-    <rewrite template="{$serviceUrl[HBASEUI]}/{**}?{**}"/>
-  </rule>
-  <rule dir="IN" name="HBASEUI/hbase/inbound/regionserver/home" pattern="*://*:*/**/hbase/webui/regionserver/rs-status?{host}?{port}">
-    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/rs-status"/>
-  </rule>
-  <rule dir="IN" name="HBASEUI/hbase/inbound/master/home" pattern="*://*:*/**/hbase/webui/master/master-status?{host}?{port}">
-    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/master-status"/>
-  </rule>
-
-  <rule dir="IN" name="HBASEUI/hbase/inbound/logs" pattern="*://*:*/**/hbase/webui/logs?{scheme}?{host}?{port}?{**}">
-    <rewrite template="{scheme}://{host}:{port}/logs/?{**}"/>
-  </rule>
-
-  <filter name="HBASEUI/hbase/outbound/headers">
-    <content type="application/x-http-headers">
-      <apply path="Location" rule="HBASEUI/hbase/outbound/headers/location"/>
-    </content>
-  </filter>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/headers/location">
-    <match pattern="{scheme}://{host}:{port}/logs/?{**}"/>
-    <rewrite template="{$frontend[url]}/hbase/webui/logs?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
-  </rule>
-
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/regionserver/home" pattern="//{host}:{port}/rs-status/">
-    <rewrite template="{$frontend[url]}/hbase/webui/regionserver/rs-status?host={$hostmap(host)}?{port}"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/master/home" pattern="//{host}:{port}/master-status/">
-    <rewrite template="{$frontend[url]}/hbase/webui/master/master-status?host={$hostmap(host)}?{port}"/>
-  </rule>
-
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/png" pattern="/static/{hbase*.png}">
-    <rewrite template="{$frontend[url]}/hbase/webui/static/{hbase*.png}"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/static" pattern="/static/{**}">
-    <rewrite template="{$frontend[url]}/hbase/webui/static/{**}"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/master" pattern="/master-status">
-    <rewrite template="{$frontend[url]}/hbase/webui/master-status"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/tables" pattern="/tablesDetailed.jsp">
-    <rewrite template="{$frontend[url]}/hbase/webui/tablesDetailed.jsp"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/logs" pattern="/logs/">
-    <rewrite template="{$frontend[url]}/hbase/webui/logs/"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/logs/files" pattern="/logs/{**}">
-    <rewrite template="{$frontend[url]}/hbase/webui/logs/{**}"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/logLevel" pattern="/logLevel">
-    <rewrite template="{$frontend[url]}/hbase/webui/logLevel"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/debug" pattern="/dump">
-    <rewrite template="{$frontend[url]}/hbase/webui/dump"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/jmx" pattern="/jmx">
-    <rewrite template="{$frontend[url]}/hbase/webui/jmx"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/conf" pattern="/conf">
-    <rewrite template="{$frontend[url]}/hbase/webui/conf"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/table" pattern="table.jsp?{**}">
-    <rewrite template="{$frontend[url]}/hbase/webui/table.jsp?{**}"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/filter" pattern="?{filter}">
-    <rewrite template="{$frontend[url]}/hbase/webui/master-status?{filter}"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/format" pattern="?{format}?{filter}">
-    <rewrite template="{$frontend[url]}/hbase/webui/master-status?{format}?{filter}"/>
-  </rule>
-  <rule dir="OUT" name="HBASEUI/hbase/outbound/zkdump" pattern="/zk.jsp">
-    <rewrite template="{$frontend[url]}/hbase/webui/zk.jsp"/>
-  </rule>
-
-  <filter name="HBASEUI/hbase/outbound/configuration">
-    <content type="*/xml">
-      <buffer path="/configuration/property"/>
-    </content>
-  </filter>
-</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbaseui/1.1.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbaseui/1.1.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbaseui/1.1.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbaseui/1.1.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,45 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="HBASEUI" name="hbase" version="1.1.0">
-    <routes>
-        <route path="/hbase/webui/">
-            <rewrite apply="HBASEUI/hbase/inbound/master/root" to="request.url"/>
-        </route>
-        <route path="/hbase/webui/**">
-            <rewrite apply="HBASEUI/hbase/inbound/master/path" to="request.url"/>
-            <rewrite apply="HBASEUI/hbase/outbound/headers" to="response.headers"/>
-        </route>
-        <route path="/hbase/webui/**?**">
-            <rewrite apply="HBASEUI/hbase/inbound/master/query" to="request.url"/>
-            <rewrite apply="HBASEUI/hbase/outbound/tasks" to="response.body"/>
-        </route>
-        <route path="/hbase/webui/regionserver/**?{host}?{port}">
-            <rewrite apply="HBASEUI/hbase/inbound/regionserver/home" to="request.url"/>
-        </route>
-        <route path="/hbase/webui/master/**?{host}?{port}">
-            <rewrite apply="HBASEUI/hbase/inbound/master/home" to="request.url"/>
-        </route>
-        <route path="/hbase/webui/logs?**">
-            <rewrite apply="HBASEUI/hbase/outbound/headers" to="response.headers"/>
-        </route>
-        <route path="/hbase/webui/conf">
-            <rewrite apply="HBASEUI/hbase/outbound/configuration" to="response.body"/>
-        </route>
-    </routes>
-    <dispatch classname="org.apache.hadoop.gateway.hbase.HBaseDispatch"/>
-</service>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase-ui/1.1.3.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase-ui/1.1.3.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase-ui/1.1.3.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase-ui/1.1.3.1/rewrite.xml	2016-08-02 13:20:41.025813641 +0400
@@ -0,0 +1,135 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/master/root" pattern="*://*:*/**/hbase/">
+    <rewrite template="{$serviceUrl[HBASEUI]}/master-status"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/master/path" pattern="*://*:*/**/hbase/{**}">
+    <rewrite template="{$serviceUrl[HBASEUI]}/{**}"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/master/query" pattern="*://*:*/**/hbase/{**}?{**}">
+    <rewrite template="{$serviceUrl[HBASEUI]}/{**}?{**}"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/regionserver/home" pattern="*://*:*/**//hbase/regionserver?{host}?{port}">
+    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/rs-status"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/master/home" pattern="*://*:*/**//hbase/master?{host}?{port}">
+    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/master-status"/>
+  </rule>
+  
+  <rule dir="IN" name="HBASEUI/hbase/inbound/logs" pattern="*://*:*/**/hbase/logs?{host}?{port}?{**}">
+    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/{host}/{port}/logs/?{**}"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/masterlogs" pattern="*://*:*/**/hbase/logs">
+    <rewrite template="{$serviceUrl[HBASEUI]}/logs/"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/dump" pattern="*://*:*/**/hbase/dump?{host}?{port}">
+    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/dump"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/masterdump" pattern="*://*:*/**/hbase/dump">
+    <rewrite template="{$serviceUrl[HBASEUI]}/dump"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/jmx" pattern="*://*:*/**/hbase/jmx?{host}?{port}">
+    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/jmx"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/masterjmx" pattern="*://*:*/**/hbase/jmx">
+    <rewrite template="{$serviceUrl[HBASEUI]}/jmx"/>
+  </rule>
+
+  <rule dir="IN" name="HBASEUI/hbase/inbound/zkdump" pattern="*://*:*/**/hbase/zk.jsp">
+    <rewrite template="{$serviceUrl[HBASEUI]}/zk.jsp"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/loglevel" pattern="*://*:*/**/hbase/logLevel?{host}?{port}">
+    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/logLevel"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/regions" pattern="*://*:*/**/hbase/region.jsp?{host}?{port}?name={**}">
+    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/region.jsp?name={**}"/>
+  </rule>
+  <rule dir="IN" name="HBASEUI/hbase/inbound/storefile" pattern="*://*:*/**/hbase/storeFile.jsp?{host}?{port}?name={**}">
+    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/storeFile.jsp?name={**}"/>
+  </rule>
+
+  <rule dir="IN" name="HBASEUI/hbase/inbound/logfile" pattern="*://*:*/**/hbase/{host}/{port}/logs/{**}">
+    <rewrite template="{$serviceScheme[HBASEUI]}://{host}:{port}/{host}/{port}/logs/{**}"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/hbase/outbound/master/root" pattern="/">
+    <rewrite template="{$frontend[url]}/hbase/master-status"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/hbase/outbound/regionserver/home" pattern="//{host}:{port}/rs-status/">
+    <rewrite template="{$frontend[url]}/hbase/regionserver?host={$hostmap(host)}?{port}"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/hbase/outbound/master/home" pattern="//{host}:{port}/master-status/">
+    <rewrite template="{$frontend[url]}/hbase/master?host={$hostmap(host)}?{port}"/>
+  </rule>
+
+  <rule dir="OUT" name="HBASEUI/png" pattern="/static/hbase_logo_small.png">
+    <rewrite template="{$frontend[url]}/hbase/static/hbase_logo_small.png"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/css" pattern="/static/css/{**}">
+    <rewrite template="{$frontend[url]}/hbase/static/css/{**}"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/js" pattern="/static/js/{**}">
+    <rewrite template="{$frontend[url]}/hbase/static/js/{**}"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/static" pattern="/static/{**}">
+    <rewrite template="{$frontend[url]}/hbase/static/{**}"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/master" pattern="/master-status">
+    <rewrite template="{$frontend[url]}/hbase/master-status"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/hbase/outbound/zkdump" pattern="/zk.jsp">
+    <rewrite template="{$frontend[url]}/hbase/zk.jsp"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/tables" pattern="/tablesDetailed.jsp">
+    <rewrite template="{$frontend[url]}/hbase/tablesDetailed.jsp"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/regions" pattern="//{host}:{port}/region.jsp?name={**}">
+    <rewrite template="{$frontend[url]}/hbase/region.jsp?host={$hostmap(host)}?{port}?name={**}"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/logs" pattern="/logs/">
+    <rewrite template="{$frontend[url]}/hbase/logs"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/logs/files" pattern="/logs/{**}">
+    <rewrite template="{$frontend[url]}/hbase/logs/{**}"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/logLevel" pattern="/logLevel">
+    <rewrite template="{$frontend[url]}/hbase/logLevel"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/debug" pattern="/dump">
+    <rewrite template="{$frontend[url]}/hbase/dump"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/jmx" pattern="/jmx">
+    <rewrite template="{$frontend[url]}/hbase/jmx"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/conf" pattern="/conf">
+    <rewrite template="{$frontend[url]}/hbase/conf"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/table" pattern="//{host}:{port}/table.jsp?name={**}">
+    <rewrite template="{$frontend[url]}/hbase/table.jsp?name={**}"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/hbase/outbound/storefile" pattern="/storeFile.jsp?name={**}">
+    <rewrite template="{$frontend[url]}/hbase/storeFile.jsp?name={**}"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/filter" pattern="?{filter}">
+    <rewrite template="{$frontend[url]}/hbase/master-status?{filter}"/>
+  </rule>
+  <rule dir="OUT" name="HBASEUI/format" pattern="?{format}?{filter}">
+    <rewrite template="{$frontend[url]}/hbase/master-status?{format}?{filter}"/>
+  </rule>
+
+</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase-ui/1.1.3.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase-ui/1.1.3.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hbase-ui/1.1.3.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hbase-ui/1.1.3.1/service.xml	2016-08-02 13:20:41.026813664 +0400
@@ -0,0 +1,71 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="HBASEUI" name="hbase" version="1.1.3.1">
+    <routes>
+        <route path="/hbase/">
+            <rewrite apply="HBASEUI/hbase/inbound/master/root" to="request.url"/>
+            <rewrite apply="HBASEUI/hbase/outbound/master/root" to="request.body"/>
+        </route>
+        <route path="/hbase/**">
+            <rewrite apply="HBASEUI/hbase/inbound/master/path" to="request.url"/>
+            <rewrite apply="HBASEUI/hbase/outbound/headers" to="response.headers"/>
+        </route>
+        <route path="/hbase/**?**">
+            <rewrite apply="HBASEUI/hbase/inbound/master/query" to="request.url"/>
+            <rewrite apply="HBASEUI/hbase/outbound/tasks" to="response.body"/>
+        </route>
+        <route path="/hbase/regionserver?**">
+            <rewrite apply="HBASEUI/hbase/inbound/regionserver/home" to="request.url"/>
+        </route>
+        <route path="/hbase/master?**">
+            <rewrite apply="HBASEUI/hbase/inbound/master/home" to="request.url"/>
+        </route>
+        <route path="/hbase/logs">
+            <rewrite apply="HBASEUI/hbase/inbound/masterlogs" to="request.url"/>
+        </route>
+        <route path="/hbase/logs?{host}?{port}">
+            <rewrite apply="HBASEUI/hbase/inbound/logs" to="request.url"/>
+        </route>
+        <route path="/hbase/dump/">
+            <rewrite apply="HBASEUI/hbase/inbound/masterdump" to="request.url"/>
+        </route>
+         <route path="/hbase/dump?{host}?{port}">
+            <rewrite apply="HBASEUI/hbase/inbound/dump" to="request.url"/>
+         </route>
+        <route path="/hbase/jmx?{host}?{port}">
+            <rewrite apply="HBASEUI/hbase/inbound/jmx" to="request.url"/>
+        </route>
+        <route path="/hbase/jmx">
+           <rewrite apply="HBASEUI/hbase/inbound/masterjmx" to="request.url"/>
+        </route>
+        <route path="/hbase/region.jsp?{**}">
+           <rewrite apply="HBASEUI/hbase/inbound/regions" to="request.url"/>
+        </route>
+        <route path="/hbase/storeFile.jsp?{**}">
+           <rewrite apply="HBASEUI/hbase/inbound/storefile" to="request.url"/>
+        </route>
+        <route path="/hbase/{host}/{post}/logs/{**}">
+           <rewrite apply="HBASEUI/hbase/inbound/logfile" to="request.url"/>
+        </route>
+        <route path="/hbase/conf">
+            <rewrite apply="HBASEUI/hbase/outbound/configuration" to="response.body"/>
+        </route>
+
+    </routes>
+    <dispatch classname="org.apache.hadoop.gateway.hbase.HBaseDispatch"/>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hdfsui/2.7.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hdfsui/2.7.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hdfsui/2.7.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hdfsui/2.7.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,94 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-
-  <rule dir="IN" name="HDFSUI/hdfs/inbound/namenode/root" pattern="*://*:*/**/hdfs/">
-    <rewrite template="{$serviceUrl[HDFSUI]}/dfshealth.html"/>
-  </rule>
-  <rule dir="IN" name="HDFSUI/hdfs/inbound/namenode/path" pattern="*://*:*/**/hdfs/{**}">
-    <rewrite template="{$serviceUrl[HDFSUI]}/{**}"/>
-  </rule>
-  <rule dir="IN" name="HDFSUI/hdfs/inbound/namenode/query" pattern="*://*:*/**/hdfs/{**}?{**}">
-    <rewrite template="{$serviceUrl[HDFSUI]}/{**}?{**}"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/bootstrapcss" pattern="/static/{bootstrap=bootstrap*}/css/{**}">
-    <rewrite template="{$frontend[url]}/hdfs/static/{bootstrap}/css/{**}"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/hadoopcss" pattern="/static/hadoop.css">
-    <rewrite template="{$frontend[url]}/hdfs/static/hadoop.css"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/jquery" pattern="/static/jquery-1.10.2.min.js">
-    <rewrite template="{$frontend[url]}/hdfs/static/jquery-1.10.2.min.js"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/dust" pattern="/static/{dust=*dust*js}">
-    <rewrite template="{$frontend[url]}/hdfs/static/{dust}"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/bootstrapjs" pattern="/static/{bootstrap=bootstrap*}/js/{**}">
-    <rewrite template="{$frontend[url]}/hdfs/static/{bootstrap}/js/{**}"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/logs" pattern="logs">
-    <rewrite template="{$frontend[url]}/hdfs/logs"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/logs/files" pattern="/logs/{**}">
-    <rewrite template="{$frontend[url]}/hdfs/logs/{**}"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/dfshealthjs" pattern="dfshealth.js">
-    <rewrite template="{$frontend[url]}/hdfs/dfshealth.js"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/explorerhtml" pattern="explorer.html">
-    <rewrite template="{$frontend[url]}/hdfs/explorer.html"/>
-  </rule>
-
-  <rule dir="IN" name="HDFSUI/hdfs/inbound/logs" pattern="*://*:*/**/hdfs/logs?{scheme}?{host}?{port}?{**}">
-    <rewrite template="{scheme}://{host}:{port}/logs/?{**}"/>
-  </rule>
-
-  <filter name="HDFSUI/hdfs/outbound/headers">
-    <content type="application/x-http-headers">
-      <apply path="Location" rule="HDFSUI/hdfs/outbound/headers/location"/>
-    </content>
-  </filter>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/headers/location">
-    <match pattern="{scheme}://{host}:{port}/logs/?{**}"/>
-    <rewrite template="{$frontend[url]}/hdfs/logs?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
-  </rule>
-
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/namenode/dfs/jmx">
-    <rewrite template="{$frontend[url]}/hdfs/jmx"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/namenode/dfs/conf">
-    <rewrite template="{$frontend[url]}/hdfs/conf"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/namenode/dfs/startupProgress">
-    <rewrite template="{$frontend[url]}/hdfs/startupProgress"/>
-  </rule>
-  <rule dir="OUT" name="HDFSUI/hdfs/outbound/namenode/dfs/webhdfs">
-    <rewrite template="{$frontend[url]}/webhdfs"/>
-  </rule>
-  <filter name="HDFSUI/hdfs/outbound/namenode/dfs">
-    <content type="*/x-javascript">
-      <apply path="/jmx" rule="HDFSUI/hdfs/outbound/namenode/dfs/jmx"/>
-      <apply path="/conf" rule="HDFSUI/hdfs/outbound/namenode/dfs/conf"/>
-      <apply path="/startupProgress" rule="HDFSUI/hdfs/outbound/namenode/dfs/startupProgress"/>
-      <apply path="/webhdfs" rule="HDFSUI/hdfs/outbound/namenode/dfs/webhdfs"/>
-    </content>
-    <content type="*/html">
-    </content>
-  </filter>
-
-</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hdfsui/2.7.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hdfsui/2.7.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hdfsui/2.7.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hdfsui/2.7.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,39 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="HDFSUI" name="hdfs" version="2.7.0">
-    <routes>
-        <route path="/hdfs/">
-            <rewrite apply="HDFSUI/hdfs/inbound/namenode/root" to="request.url"/>
-            <rewrite apply="HDFSUI/hdfs/outbound/namenode/dfs" to="response.body"/>
-        </route>
-        <route path="/hdfs/**">
-            <rewrite apply="HDFSUI/hdfs/inbound/namenode/path" to="request.url"/>
-            <rewrite apply="HDFSUI/hdfs/outbound/headers" to="response.headers"/>
-            <rewrite apply="HDFSUI/hdfs/outbound/namenode/dfs" to="response.body"/>
-        </route>
-        <route path="/hdfs/**?**">
-            <rewrite apply="HDFSUI/hdfs/inbound/namenode/query" to="request.url"/>
-            <rewrite apply="HDFSUI/hdfs/outbound/namenode/dfs" to="response.body"/>
-        </route>
-        <route path="/hdfs/logs?**">
-            <rewrite apply="HDFSUI/hdfs/outbound/headers" to="response.headers"/>
-            <rewrite apply="HDFSUI/hdfs/outbound/namenode/dfs" to="response.body"/>
-        </route>
-    </routes>
-    <dispatch classname="org.apache.hadoop.gateway.hdfs.dispatch.HdfsHttpClientDispatch" ha-classname="org.apache.hadoop.gateway.hdfs.dispatch.WebHdfsHaDispatch"/>
-</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hdfs-ui/2.7.2.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hdfs-ui/2.7.2.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hdfs-ui/2.7.2.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hdfs-ui/2.7.2.1/rewrite.xml	2016-08-02 13:20:41.015813409 +0400
@@ -0,0 +1,122 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+
+  <!-- Route in rules  -->
+  <!-- namenode rules  -->
+  <rule dir="IN" name="HDFSUI/hdfs/inbound/namenode/root" pattern="*://*:*/**/hdfs/">
+    <rewrite template="{$serviceUrl[HDFSUI]}/"/>
+  </rule>
+  <rule dir="IN" name="HDFSUI/hdfs/inbound/namenode/dfs" pattern="*://*:*/**/hdfs/dfshealth.html">
+    <rewrite template="{$serviceUrl[HDFSUI]}/dfshealth.html"/>
+  </rule>
+  <rule dir="IN" name="HDFSUI/hdfs/inbound/namenode/path" pattern="*://*:*/**/hdfs/{**}">
+    <rewrite template="{$serviceUrl[HDFSUI]}/{**}"/>
+  </rule>
+  <rule dir="IN" name="HDFSUI/hdfs/inbound/namenode/query" pattern="*://*:*/**/hdfs/{**}?{**}">
+    <rewrite template="{$serviceUrl[HDFSUI]}/{**}?{**}"/>
+  </rule>
+
+  <!-- log rules  -->
+  <rule dir="IN" name="HDFSUI/hdfs/inbound/logs" pattern="*://*:*/**/hdfs/logs">
+    <rewrite template="{$serviceUrl[HDFSUI]}/logs"/>
+  </rule>
+    <rule dir="IN" name="HDFSUI/hdfs/inbound/logs/files" pattern="*://*:*/**/hdfs/logs/{**}">
+    <rewrite template="{$serviceUrl[HDFSUI]}/logs/{**}"/>
+  </rule>
+
+  <!--             
+    After the redirection(302) from {$frontend[url]}/hdfs/logs/?{**}, hdfs returns the datanode host from 
+    which we need to access the log as part of the redirection location header.
+    e.g
+    After call to /logs a 302 is generated with a location  location header that has
+    "https://knox_host:knox_port/gateway/knox_deployment/hdfs/logs/?port=50070&host=nodehost.com&scheme
+=http&user.name=guest"
+    The following rule accomplish the inbound call after 302.
+    {host} -> host=nodehost.com
+    {scheme} -> scheme=http
+    {port} -> port=50070
+    {**} -> user.name=guest
+   -->
+  <rule dir="IN" name="HDFSUI/hdfs/inbound/logs/redir" pattern="*://*:*/**/hdfs/logs?{scheme}?{host}?{port}?{**}">
+        <rewrite template="{scheme}://{host}:{port}/logs/?{**}"/>
+   </rule>
+
+  <!-- Outbound rewrite rule that apply to html body-->
+
+  <rule dir="OUT" name="HDFSUI/content/static" pattern="/static/{**}">
+
+    <rewrite template="{$frontend[url]}/hdfs/static/{**}"/>
+  </rule>
+  <rule dir="OUT" name="HDFSUI/content/resource" pattern="dfshealth.js">
+    <rewrite template="{$frontend[url]}/hdfs/dfshealth.js"/>
+  </rule>
+  <rule dir="OUT" name="HDFSUI/hdfs/outbound/logs/files" pattern="/logs/{**}">
+    <rewrite template="{$frontend[url]}/hdfs/logs/{**}"/>
+  </rule>
+
+  <!-- Redirection rules that rewrite the Location reponse header  -->
+  <filter name="HDFSUI/hdfs/outbound/headers/logs">
+    <content type="application/x-http-headers">
+      <apply path="Location" rule="HDFSUI/hdfs/outbound/headers/logs/location"/>
+    </content>
+  </filter>
+
+    <!-- 
+    The following outbound  rule re-writes the response Location header, and it used by the
+    "HDFSUI/hdfs/outbound/headers/logs" redirection rule.
+    Any /logs query parameter is matched and then it is rewritten so Location has
+    {host} -> host=nodehost.com
+    host can be mapped using the hostmap function(used to map server that may have an outside hostname and inside hostname
+    see hostmap function in Knox User's guide).
+    {scheme} -> scheme=http
+    {port} -> port=50070
+    {**} -> user.name=guest
+    The result of rewriting the Location header is that the browser then will go through Knox, and the next request 
+    will trigger the inbound "HDFSUI/hdfs/inbound/logs/redir" rule.
+   -->
+  <rule dir="OUT" name="HDFSUI/hdfs/outbound/headers/logs/location">
+    <match pattern="{scheme}://{host}:{port}/logs/?{**}"/>
+    <rewrite template="{$frontend[url]}/hdfs/logs?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
+  </rule>
+  
+  <!-- JavaScript re-write rules -->
+  <rule dir="OUT" name="HDFSUI/hdfs/outbound/namenode/relative/jmx">
+    <rewrite template="{$frontend[url]}/hdfs/jmx"/>
+  </rule>
+  <rule dir="OUT" name="HDFSUI/hdfs/outbound/namenode/relative/conf">
+    <rewrite template="{$frontend[url]}/hdfs/conf"/>
+  </rule>
+  <rule dir="OUT" name="HDFSUI/hdfs/outbound/namenode/relative/startupProgress">
+    <rewrite template="{$frontend[url]}/hdfs/startupProgress"/>
+  </rule>
+  <rule dir="OUT" name="HDFSUI/hdfs/outbound/namenode/relative/webhdfs">
+    <rewrite template="{$frontend[url]}/webhdfs"/>
+  </rule>
+  <filter name="HDFSUI/hdfs/outbound/namenode/relative">
+    <content type="*/x-javascript">
+      <apply path="/jmx" rule="HDFSUI/hdfs/outbound/namenode/relative/jmx"/>
+      <apply path="/conf" rule="HDFSUI/hdfs/outbound/namenode/relative/conf"/>
+      <apply path="/startupProgress" rule="HDFSUI/hdfs/outbound/namenode/relative/startupProgress"/>
+      <apply path="/webhdfs" rule="HDFSUI/hdfs/outbound/namenode/relative/webhdfs"/>
+    </content>
+    <content type="*/html">
+    </content>
+  </filter>
+
+</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hdfs-ui/2.7.2.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hdfs-ui/2.7.2.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hdfs-ui/2.7.2.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hdfs-ui/2.7.2.1/service.xml	2016-08-02 13:20:41.016813432 +0400
@@ -0,0 +1,37 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="HDFSUI" name="hdfs" version="2.7.2.1">
+    <routes>
+        <route path="/hdfs/">
+            <rewrite apply="HDFSUI/hdfs/outbound/namenode/relative" to="response.body"/>
+        </route>
+        <route path="/hdfs/**">
+            <rewrite apply="HDFSUI/hdfs/outbound/namenode/relative" to="response.body"/>
+        </route>
+        <route path="/hdfs/**?**">
+            <rewrite apply="HDFSUI/hdfs/outbound/namenode/relative" to="response.body"/>
+        </route>
+        <route path="/hdfs/logs?**">
+            <rewrite apply="HDFSUI/hdfs/outbound/headers/logs" to="response.headers"/>
+        </route>
+
+    </routes>
+    <!--
+    <dispatch classname="org.apache.hadoop.gateway.hdfs.dispatch.HdfsHttpClientDispatch" ha-classname="org.apache.hadoop.gateway.hdfs.dispatch.WebHdfsHaDispatch"/>
+    -->
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hive/0.13.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hive/0.13.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hive/0.13.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hive/0.13.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,21 +0,0 @@
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-    <rule dir="IN" name="HIVE/hive/inbound" pattern="*://*:*/**/hive">
-        <rewrite template="{$serviceUrl[HIVE]}"/>
-    </rule>
-</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hive/0.13.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hive/0.13.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hive/0.13.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hive/0.13.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,22 +0,0 @@
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="HIVE" name="hive" version="0.13.0">
-    <routes>
-        <route path="/hive"/>
-    </routes>
-    <dispatch classname="org.apache.hadoop.gateway.hive.HiveDispatch" ha-classname="org.apache.hadoop.gateway.hive.HiveHaDispatch"/>
-</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hive/0.13.0.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hive/0.13.0.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hive/0.13.0.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hive/0.13.0.1/rewrite.xml	2016-08-02 13:20:41.024813618 +0400
@@ -0,0 +1,21 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+    <rule dir="IN" name="HIVE/hive/inbound" pattern="*://*:*/**/hive">
+        <rewrite template="{$serviceUrl[HIVE]}"/>
+    </rule>
+</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hive/0.13.0.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hive/0.13.0.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/hive/0.13.0.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/hive/0.13.0.1/service.xml	2016-08-02 13:20:41.025813641 +0400
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="HIVE" name="hive" version="0.13.0.1">
+    <routes>
+        <route path="/hive"/>
+    </routes>
+    <dispatch classname="org.apache.hadoop.gateway.hive.HiveDispatch" ha-classname="org.apache.hadoop.gateway.hive.HiveHaDispatch"/>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/jobhistoryui/2.7.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/jobhistoryui/2.7.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/jobhistoryui/2.7.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/jobhistoryui/2.7.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,125 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/root" pattern="*://*:*/**/jobhistory/">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/jobhistory"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/path" pattern="*://*:*/**/jobhistory/{**}">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/jobhistory/{**}"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/query" pattern="*://*:*/**/jobhistory/{**}?{**}">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/jobhistory/{**}?{**}"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/static" pattern="*://*:*/**/jobhistory/static/{**}">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/static/{**}"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/conf" pattern="*://*:*/**/jobhistory/conf">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/conf"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/logs" pattern="*://*:*/**/jobhistory/logs">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/logs"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/joblogs" pattern="*://*:*/**/jobhistory/joblogs">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/jobhistory/logs"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/logs/files" pattern="*://*:*/**/jobhistory/logs/{**}">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/logs/{**}"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/joblogs/filecontent" pattern="*://*:*/**/jobhistory/joblogs/{**}">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/jobhistory/logs/{**}"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/joblogs/fullfilecontent" pattern="*://*:*/**/jobhistory/joblogs/{**}/?{**}">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/jobhistory/logs/{**}/?{**}"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/logs/redirect" pattern="*://*:*/**/jobhistory/logs?{scheme}?{host}?{port}?{**}">
-    <rewrite template="{scheme}://{host}:{port}/logs/?{**}"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/stacks" pattern="*://*:*/**/jobhistory/stacks">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/stacks"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/metrics" pattern="*://*:*/**/jobhistory/metrics">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/metrics"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/jmx" pattern="*://*:*/**/jobhistory/jmx">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/jmx"/>
-  </rule>
-  <rule dir="IN" name="JOBHISTORYUI/jobhistory/inbound/jmx/query" pattern="*://*:*/**/jobhistory/jmx?{**}">
-    <rewrite template="{$serviceUrl[JOBHISTORYUI]}/jmx?{**}"/>
-  </rule>
-
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/headers/location">
-    <match pattern="{scheme}://{host}:{port}/logs/?{**}"/>
-    <rewrite template="{$frontend[url]}/jobhistory/logs?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/logs/files" pattern="/logs/{**}">
-    <rewrite template="{$frontend[url]}/jobhistory/logs/{**}"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/static" pattern="/static/{**}">
-    <rewrite template="{$frontend[url]}/jobhistory/static/{**}"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/jobhistory" pattern="/jobhistory/{**}">
-    <rewrite template="{$frontend[url]}/jobhistory/{**}"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/jobhistory/query" pattern="/jobhistory/{**}?{**}">
-    <rewrite template="{$frontend[url]}/jobhistory/{**}?{**}"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/jobhistory/logs" pattern="/jobhistory/logs/{**}/?{**}">
-    <rewrite template="{$frontend[url]}/jobhistory/joblogs/{**}/?{**}"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/conf" pattern="/conf">
-    <rewrite template="{$frontend[url]}/jobhistory/conf"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/logs" pattern="/logs">
-    <rewrite template="{$frontend[url]}/jobhistory/logs"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/stacks" pattern="/stacks">
-    <rewrite template="{$frontend[url]}/jobhistory/stacks"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/metrics" pattern="/metrics">
-    <rewrite template="{$frontend[url]}/jobhistory/metrics"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/jmx" pattern="/jmx?{**}">
-    <rewrite template="{$frontend[url]}/jobhistory/jmx?{**}"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/jobs/job">
-    <rewrite template="{$frontend[url]}/jobhistory/job"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/jobs/task">
-    <rewrite template="{$frontend[url]}/jobhistory/task"/>
-  </rule>
-  <rule dir="OUT" name="JOBHISTORYUI/jobhistory/outbound/jobs/logs">
-    <rewrite template="{$frontend[url]}/jobhistory/joblogs"/>
-  </rule>
-  <filter name="JOBHISTORYUI/jobhistory/outbound/headers">
-    <content type="application/x-http-headers">
-      <apply path="Location" rule="JOBHISTORYUI/jobhistory/outbound/headers/location"/>
-    </content>
-  </filter>
-  <filter name="JOBHISTORYUI/jobhistory/outbound/configuration">
-    <content type="*/xml">
-      <buffer path="/configuration/property"/>
-    </content>
-  </filter>
-  <filter name="JOBHISTORYUI/jobhistory/outbound/jobs">
-    <content type="*/html">
-      <apply path="/jobhistory/job" rule="JOBHISTORYUI/jobhistory/outbound/jobs/job"/>
-      <apply path="/jobhistory/task" rule="JOBHISTORYUI/jobhistory/outbound/jobs/task"/>
-      <apply path="/jobhistory/logs" rule="JOBHISTORYUI/jobhistory/outbound/jobs/logs"/>
-    </content>
-  </filter>
-</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/jobhistoryui/2.7.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/jobhistoryui/2.7.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/jobhistoryui/2.7.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/jobhistoryui/2.7.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,36 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="JOBHISTORYUI" name="jobhistory" version="2.7.0">
-    <routes>
-        <route path="/jobhistory/">
-            <rewrite apply="JOBHISTORYUI/jobhistory/outbound/jobs" to="response.body"/>
-        </route>
-        <route path="/jobhistory/**">
-            <rewrite apply="JOBHISTORYUI/jobhistory/outbound/jobs" to="response.body"/>
-        </route>
-        <route path="/jobhistory/**?**">
-            <rewrite apply="JOBHISTORYUI/jobhistory/outbound/jobs" to="response.body"/>
-        </route>
-        <route path="/jobhistory/logs?**">
-            <rewrite apply="JOBHISTORYUI/jobhistory/outbound/headers" to="response.headers"/>
-        </route>
-        <route path="/jobhistory/conf">
-            <rewrite apply="JOBHISTORYUI/jobhistory/outbound/configuration" to="response.body"/>
-        </route>
-     </routes>
-</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/jobhistory-ui/2.7.2.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/jobhistory-ui/2.7.2.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/jobhistory-ui/2.7.2.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/jobhistory-ui/2.7.2.1/rewrite.xml	2016-08-02 13:20:41.027813688 +0400
@@ -0,0 +1,145 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+
+<rules>
+  <!-- request in rewrite rules -->
+
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/root" pattern="*://*:*/**/jobstory/">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/jobhistory"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/path" pattern="*://*:*/**/jobstory/{**}">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/jobhistory/{**}"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/static" pattern="*://*:*/**/jobstory/static/{**}">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/static/{**}"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/jobhistory" pattern="*://*:*/**/jobstory/jobhistory/{**}">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/jobhistory/{**}"/>
+  </rule>
+ <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/jobhistory/params" pattern="*://*:*/**/jobstory/jobhistory/{**}?{**}">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/jobhistory/{**}?{**}"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/conf" pattern="*://*:*/**/jobstory/conf">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/conf"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/logs" pattern="*://*:*/**/jobstory/logs">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/logs"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/logs/files" pattern="*://*:*/**/jobstory/logs/{**}">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/logs/{**}"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/stacks" pattern="*://*:*/**/jobstory/stacks">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/stacks"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/metrics" pattern="*://*:*/**/jobstory/metrics">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/metrics"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/jmx" pattern="*://*:*/**/jobstory/jmx">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/jmx"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/jmx/query" pattern="*://*:*/**/jobstory/jmx?{**}">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/jmx?{**}"/>
+  </rule>
+  <rule dir="IN" name="JOBSTORYUI/jobstory/inbound/logs" pattern="*://*:*/**/jobstory/logs?{scheme}?{host}?{port}?{**}">
+    <rewrite template="{scheme}://{host}:{port}/logs/?{**}"/>
+  </rule>
+
+  <rule dir="IN" name="JOBSTORYUI/nodelink/inbound" pattern="*://*:*/**/jobstory/node?{scheme}?{host}?{port}">
+      <rewrite template="{scheme}://{host}:{port}/node?{scheme}?{host}?{port}"/>
+  </rule>
+
+
+  <!-- request out web content rewrite rules -->
+
+  <!-- rewrite map reduce node manager request -->
+  <!-- This maps to Nodemanager           -->
+  <rule dir="OUT" name="JOBSTORYUI/nodelink" pattern="{scheme}://{host}:{port}">
+    <rewrite template="{gateway.scheme}://{gateway.host}:{gateway.port}/gateway/nodemanagerui/node?{host}"/>
+  </rule>
+
+  <!-- static web resources (css, js, jpeg, etc). -->
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/static" pattern="/static/{**}">
+    <rewrite template="{$frontend[url]}/jobstory/static/{**}"/>
+  </rule>
+
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/jobhistory" pattern="/jobhistory/{**}">
+    <rewrite template="{$frontend[url]}/jobstory/jobhistory/{**}"/>
+  </rule>
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/jobhistory/params" pattern="/jobhistory/{**}?{**}">
+    <rewrite template="{$frontend[url]}/jobstory/jobhistory/{**}?{**}"/>
+  </rule>
+
+  <!-- tab content rewrite e.g. /conf, /logs, /stacks, /metrics,/jmx, etc -->
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/conf" pattern="/conf">
+    <rewrite template="{$frontend[url]}/jobstory/conf"/>
+  </rule>
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/logs" pattern="/logs">
+    <rewrite template="{$frontend[url]}/jobstory/logs"/>
+  </rule>
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/logs/files" pattern="/logs/{**}">
+    <rewrite template="{$frontend[url]}/jobstory/logs/{**}"/>
+  </rule>
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/stacks" pattern="/stacks">
+    <rewrite template="{$frontend[url]}/jobstory/stacks"/>
+  </rule>
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/metrics" pattern="/metrics">
+    <rewrite template="{$frontend[url]}/jobstory/metrics"/>
+  </rule>
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/jmx/query" pattern="/jmx?{**}">
+    <rewrite template="{$frontend[url]}/jobstory/jmx?{**}"/>
+  </rule>
+
+  <!-- 302 redirection for jobs, tasks, logs -->
+  <filter name="JOBSTORYUI/jobstory/outbound/headers">
+    <content type="application/x-http-headers">
+      <apply path="Location" rule="JOBSTORYUI/jobstory/outbound/headers/location"/>
+    </content>
+  </filter>
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/headers/location">
+    <match pattern="{scheme}://{host}:{port}/logs/?{**}"/>
+    <rewrite template="{$frontend[url]}/jobstory/logs?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
+  </rule>
+
+  <!-- xml content rewrite  -->
+  <filter name="JOBSTORYUI/jobstory/configuration">
+    <content type="*/xml">
+      <buffer path="/configuration/property"/>
+    </content>
+  </filter>
+
+  <!-- embedded javascript content rewrite -->
+  <filter name="JOBSTORYUI/jobstory/outbound/jobs">
+    <content type="*/html">
+      <apply path="/jobhistory/job" rule="JOBSTORYUI/jobstory/outbound/jobs/job"/>
+      <apply path="/jobhistory/task" rule="JOBSTORYUI/jobstory/outbound/jobs/task"/>
+      <apply path="/jobhistory/logs" rule="JOBSTORYUI/jobstory/outbound/jobs/logs"/>
+    </content>
+  </filter>
+
+  <!-- rules for embedded js rewrite   -->
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/jobs/job">
+    <rewrite template="{$frontend[url]}/jobstory/jobhistory/job"/>
+  </rule>
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/jobs/task">
+    <rewrite template="{$frontend[url]}/jobstory/jobhistory/task"/>
+  </rule>
+  <rule dir="OUT" name="JOBSTORYUI/jobstory/outbound/jobs/logs">
+    <rewrite template="{$frontend[url]}/jobstory/jobhistory/logs"/>
+  </rule>
+
+</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/jobhistory-ui/2.7.2.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/jobhistory-ui/2.7.2.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/jobhistory-ui/2.7.2.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/jobhistory-ui/2.7.2.1/service.xml	2016-08-02 13:20:41.028813712 +0400
@@ -0,0 +1,36 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="JOBSTORYUI" name="jobstory" version="2.7.2.1">
+    <routes>
+        <route path="/jobstory/">
+            <rewrite apply="JOBSTORYUI/jobstory/outbound/jobs" to="response.body"/>
+        </route>
+        <route path="/jobstory/**">
+            <rewrite apply="JOBSTORYUI/jobstory/outbound/jobs" to="response.body"/>
+        </route>
+        <route path="/jobstory/**?**">
+            <rewrite apply="JOBSTORYUI/jobstory/outbound/jobs" to="response.body"/>
+        </route>
+        <route path="/jobstory/logs?**">
+            <rewrite apply="JOBSTORYUI/jobstory/outbound/headers" to="response.headers"/>
+        </route>
+        <route path="/jobstory/conf">
+            <rewrite apply="JOBSTORYUI/jobstory/outbound/configuration" to="response.body"/>
+        </route>
+     </routes>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/nodemanager-ui/2.7.2.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/nodemanager-ui/2.7.2.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/nodemanager-ui/2.7.2.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/nodemanager-ui/2.7.2.1/rewrite.xml	2016-08-02 13:20:41.009813259 +0400
@@ -0,0 +1,101 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+Licensed to the Apache Software Foundation (ASF) under one or more
+contributor license agreements.  See the NOTICE file distributed with
+this work for additional information regarding copyright ownership.
+The ASF licenses this file to You under the Apache License, Version 2.0
+(the "License"); you may not use this file except in compliance with
+the License.  You may obtain a copy of the License at
+
+http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+-->
+<rules>
+<!-- Inbound rules -->
+<!-- Resource manager routing in rules -->
+<!-- 
+     {$frontend[url] is used through the rewrite and is it equivalent to {$serviceUrl[NODEUI]},  this the endpoint url for the service.
+     e.g. http://host.com:8042
+-->
+
+<rule dir="IN" name="NODEUI/logs" pattern="*://*:*/**/node/logs/?{host}">
+    <rewrite template="http://{host}:8042/logs/"/>
+</rule>
+<rule dir="IN" name="NODEUI/logs2" pattern="*://*:*/**/node/logs/{**}?{host}">
+    <rewrite template="http://{host}:8042/logs/{**}"/>
+</rule>
+<rule dir="IN" name="NODEUI/node/root" pattern="*://*:*/**/node/?{host}">
+    <rewrite template="http://{host}:8042/node"/>
+</rule>
+<rule dir="IN" name="NODEUI/node/path" pattern="*://*:*/**/node/{**}?{host}">
+     <rewrite template="http://{host}:8042/node/{**}"/>
+</rule>
+<rule dir="IN" name="NODEUI/node/query" pattern="*://*:*/**/node/{**}?{**}?{host}">
+    <rewrite template="http://{host}:8042/node/{**}?{**}"/>
+</rule>
+<rule dir="IN" name="NODEUI/node/static" pattern="*://*:*/**/node/static/{**}?{host}">
+    <rewrite template="http://{host}:8042/static/{**}"/>
+</rule>
+
+<rule dir="IN" name="nodeconf" pattern="*://*:*/**/node/conf?{host}">
+    <rewrite template="http://{host}:8042/conf"/>
+</rule>
+
+<!-- Node manager Thread Server stacks inbound routing -->
+<rule dir="IN" name="NODEUI/node/inbound/stacks" pattern="*://*:*/**/node/stacks?{host}">
+    <rewrite template="http://{host}:8042/stacks"/>
+</rule>
+<rule dir="IN" name="NODEUI/node/inbound/metrics" pattern="*://*:*/**/node/metrics?{host}">
+    <rewrite template="http://{host}:8042/metrics"/>
+</rule>
+<!-- Node manageNode manager Resource Manager server Metrics JMX inbound routing -->
+<rule dir="IN" name="NODEUI/node/inbound/jmx" pattern="*://*:*/**/node/jmx?{host}">
+    <rewrite template="http://{host}:8042/jmx"/>
+</rule>
+<rule dir="IN" name="NODEUI/node/inbound/jmx/query" pattern="*://*:*/**/node/jmx?{**}?{host}">
+    <rewrite template="http://{host}:8042/jmx?{**}"/>
+</rule>
+
+<rule dir="OUT" name="NODEUI/node/static" pattern="/static/{**}">
+    <rewrite template="{$frontend[url]}/node/static/{**}?host={$frontend[host]}"/>
+</rule>
+<rule dir="OUT" name="NODEUI/node/nodemanager" pattern="/node/{**}">
+    <rewrite template="{$frontend[url]}/node/node/{**}?host={$frontend[host]}"/>
+</rule>
+<rule dir="OUT" name="nodeconfOut" pattern="/conf">
+    <rewrite template="{$frontend[url]}/node/conf?host={$frontend[host]}"/>
+</rule>
+<rule dir="OUT" name="nodelogsOut" pattern="/logs">
+    <rewrite template="{$frontend[url]}/node/logs/?host={$frontend[host]}"/>
+</rule>
+<rule dir="OUT" name="NODEUI/node/outbound/stacks" pattern="/stacks">
+    <rewrite template="{$frontend[url]}/node/stacks?host={$frontend[host]}"/>
+</rule>
+    <rule dir="OUT" name="NODEUI/node/outbound/metrics" pattern="/metrics">
+    <rewrite template="{$frontend[url]}/node/metrics?host={$frontend[host]}"/>
+</rule>
+<rule dir="OUT" name="NODEUI/node/outbound/jmx" pattern="/jmx?{**}">
+    <rewrite template="{$frontend[url]}/node/jmx?{**}?host={$frontend[host]}"/>
+</rule>
+
+<rule dir="OUT" name="NODEUI/nodelink" pattern="{scheme}://{host}:{port}">
+    <rewrite template="{gateway.scheme}://{gateway.host}:{gateway.port}/gateway/yarnui/yarn/"/>
+</rule>
+
+<rule dir="OUT" name="NODEUI/logfiles" pattern="/logs/{**}">
+    <rewrite template="{$frontend[url]}/node/logs/{**}?host={$frontend[host]}"/>
+</rule>
+
+<!-- rewrites XML content from configuration link -->
+<filter name="NODEUI/configuration">
+    <content type="*/xml">
+        <buffer path="/configuration/property"/>
+    </content>
+</filter>
+
+</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/nodemanager-ui/2.7.2.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/nodemanager-ui/2.7.2.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/nodemanager-ui/2.7.2.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/nodemanager-ui/2.7.2.1/service.xml	2016-08-02 13:20:41.011813314 +0400
@@ -0,0 +1,34 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="NODEUI" name="nodeui" version="2.7.2.1">
+    <routes>
+        <route path="/node/">
+            <rewrite apply="noderoot" to="response.body"/>
+        </route>
+        <route path="/node/**">
+            <rewrite apply="nodepath" to="response.body"/>
+        </route>
+        <route path="/node/**?**">
+            <rewrite apply="nodequery" to="response.body"/>
+        </route>
+        <route path="/node/conf">
+            <rewrite apply="NODEUI/configuration" to="response.body"/>
+        </route>
+
+    </routes>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie/4.0.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie/4.0.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie/4.0.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie/4.0.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,125 +0,0 @@
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-
-    <rule dir="IN" name="OOZIE/oozie/root" pattern="*://*:*/**/oozie/{**}?{**}">
-        <rewrite template="{$serviceUrl[OOZIE]}/{**}?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="OOZIE/oozie/v1" pattern="*://*:*/**/oozie/v1/{**}?{**}">
-        <rewrite template="{$serviceUrl[OOZIE]}/v1/{**}?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="OOZIE/oozie/v2" pattern="*://*:*/**/oozie/v2/{**}?{**}">
-        <rewrite template="{$serviceUrl[OOZIE]}/v2/{**}?{**}"/>
-    </rule>
-
-    <rule name="OOZIE/oozie/user-name">
-        <rewrite template="{$username}"/>
-    </rule>
-
-    <rule name="OOZIE/oozie/name-node-url">
-        <rewrite template="hdfs://{$serviceMappedAddr[NAMENODE]}"/>
-    </rule>
-
-    <rule name="OOZIE/oozie/job-tracker-address">
-        <rewrite template="{$serviceMappedAddr[JOBTRACKER]}"/>
-    </rule>
-
-    <rule name="OOZIE/oozie/hdfs-path" flow="OR">
-        <match pattern="/~">
-            <rewrite template="hdfs://{$serviceMappedAddr[NAMENODE]}/user/{$username}"/>
-        </match>
-        <match pattern="/~/{path=**}">
-            <rewrite template="hdfs://{$serviceMappedAddr[NAMENODE]}/user/{$username}/{path=**}"/>
-        </match>
-        <match pattern="{var=${*}}/{path=**}">
-            <rewrite template="{var}/{path=**}"/>
-        </match>
-        <match pattern="{path=**}">
-            <rewrite template="{$serviceMappedUrl[NAMENODE]}/{path=**}"/>
-        </match>
-    </rule>
-
-    <filter name="OOZIE/oozie/configuration">
-        <content type="*/xml">
-            <buffer path="/configuration/property">
-                <detect path="name" value="user.name">
-                    <apply path="value" rule="OOZIE/oozie/user-name"/>
-                </detect>
-                <detect path="name" value="nameNode">
-                    <apply path="value" rule="OOZIE/oozie/name-node-url"/>
-                </detect>
-                <detect path="name" value="jobTracker">
-                    <apply path="value" rule="OOZIE/oozie/job-tracker-address"/>
-                </detect>
-                <detect path="name" value="fs.default.name">
-                    <apply path="value" rule="OOZIE/oozie/name-node-url"/>
-                </detect>
-                <detect path="name" value="fs.defaultFS">
-                    <apply path="value" rule="OOZIE/oozie/name-node-url"/>
-                </detect>
-                <detect path="name" value="oozie.wf.application.path">
-                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
-                </detect>
-                <detect path="name" value="oozie.coord.application.path">
-                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
-                </detect>
-                <detect path="name" value="oozie.bundle.application.path">
-                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
-                </detect>
-                <detect path="name" value="oozie.libpath">
-                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
-                </detect>
-                <detect path="name" value="mapreduce.job.user.name">
-                    <apply path="value" rule="OOZIE/oozie/user-name"/>
-                </detect>
-                <detect path="name" value="mapred.job.tracker">
-                    <apply path="value" rule="OOZIE/oozie/job-tracker-address"/>
-                </detect>
-                <detect path="name" value="mapred.input.dir">
-                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
-                </detect>
-                <detect path="name" value="inputDir">
-                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
-                </detect>
-                <detect path="name" value="mapred.output.dir">
-                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
-                </detect>
-                <detect path="name" value="outputDir">
-                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
-                </detect>
-            </buffer>
-        </content>
-        <content type="*/json">
-            <apply path="$[user.name]" rule="OOZIE/oozie/user-name"/>
-            <apply path="$[nameNode]" rule="OOZIE/oozie/name-node-url"/>
-            <apply path="$[jobTracker]" rule="OOZIE/oozie/job-tracker-addr"/>
-            <apply path="$[fs.default.name]" rule="OOZIE/oozie/name-node-url"/>
-            <apply path="$[fs.defaultFS]" rule="OOZIE/oozie/name-node-url"/>
-            <apply path="$[oozie.wf.application.path]" rule="OOZIE/oozie/hdfs-path"/>
-            <apply path="$[oozie.coord.application.path]" rule="OOZIE/oozie/hdfs-path"/>
-            <apply path="$[oozie.bundle.application.path]" rule="OOZIE/oozie/hdfs-path"/>
-            <apply path="$[oozie.libpath]" rule="OOZIE/oozie/hdfs-path"/>
-            <apply path="$[mapreduce.job.user.name]" rule="OOZIE/oozie/user-name"/>
-            <apply path="$[mapred.job.tracker]" rule="OOZIE/oozie/job-tracker-address"/>
-            <apply path="$[mapred.input.dir]" rule="OOZIE/oozie/hdfs-path"/>
-            <apply path="$[mapred.output.dir]" rule="OOZIE/oozie/hdfs-path"/>
-        </content>
-    </filter>
-
-</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie/4.0.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie/4.0.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie/4.0.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie/4.0.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,35 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="OOZIE" name="oozie" version="4.0.0">
-    <routes>
-        <route path="/oozie/**?**">
-            <rewrite apply="OOZIE/oozie/configuration" to="request.body"/>
-        </route>
-        <route path="/oozie/v1/**?**">
-            <rewrite apply="OOZIE/oozie/configuration" to="request.body"/>
-        </route>
-        <route path="/oozie/v2/**?**">
-            <rewrite apply="OOZIE/oozie/configuration" to="request.body"/>
-        </route>
-    </routes>
-    <testURLs>
-        <testURL>/oozie/v1/admin/build-version</testURL>
-        <testURL>/oozie/v1/admin/status</testURL>
-        <testURL>/oozie/versions</testURL>
-    </testURLs>
-</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie/4.0.0.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie/4.0.0.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie/4.0.0.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie/4.0.0.1/rewrite.xml	2016-08-02 13:20:40.966812263 +0400
@@ -0,0 +1,125 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+
+    <rule dir="IN" name="OOZIE/oozie/root" pattern="*://*:*/**/oozie/{**}?{**}">
+        <rewrite template="{$serviceUrl[OOZIE]}/{**}?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="OOZIE/oozie/v1" pattern="*://*:*/**/oozie/v1/{**}?{**}">
+        <rewrite template="{$serviceUrl[OOZIE]}/v1/{**}?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="OOZIE/oozie/v2" pattern="*://*:*/**/oozie/v2/{**}?{**}">
+        <rewrite template="{$serviceUrl[OOZIE]}/v2/{**}?{**}"/>
+    </rule>
+
+    <rule name="OOZIE/oozie/user-name">
+        <rewrite template="{$username}"/>
+    </rule>
+
+    <rule name="OOZIE/oozie/name-node-url">
+        <rewrite template="hdfs://{$serviceMappedAddr[NAMENODE]}"/>
+    </rule>
+
+    <rule name="OOZIE/oozie/job-tracker-address">
+        <rewrite template="{$serviceMappedAddr[JOBTRACKER]}"/>
+    </rule>
+
+    <rule name="OOZIE/oozie/hdfs-path" flow="OR">
+        <match pattern="/~">
+            <rewrite template="hdfs://{$serviceMappedAddr[NAMENODE]}/user/{$username}"/>
+        </match>
+        <match pattern="/~/{path=**}">
+            <rewrite template="hdfs://{$serviceMappedAddr[NAMENODE]}/user/{$username}/{path=**}"/>
+        </match>
+        <match pattern="{var=${*}}/{path=**}">
+            <rewrite template="{var}/{path=**}"/>
+        </match>
+        <match pattern="{path=**}">
+            <rewrite template="{$serviceMappedUrl[NAMENODE]}/{path=**}"/>
+        </match>
+    </rule>
+
+    <filter name="OOZIE/oozie/configuration">
+        <content type="*/xml">
+            <buffer path="/configuration/property">
+                <detect path="name" value="user.name">
+                    <apply path="value" rule="OOZIE/oozie/user-name"/>
+                </detect>
+                <detect path="name" value="nameNode">
+                    <apply path="value" rule="OOZIE/oozie/name-node-url"/>
+                </detect>
+                <detect path="name" value="jobTracker">
+                    <apply path="value" rule="OOZIE/oozie/job-tracker-address"/>
+                </detect>
+                <detect path="name" value="fs.default.name">
+                    <apply path="value" rule="OOZIE/oozie/name-node-url"/>
+                </detect>
+                <detect path="name" value="fs.defaultFS">
+                    <apply path="value" rule="OOZIE/oozie/name-node-url"/>
+                </detect>
+                <detect path="name" value="oozie.wf.application.path">
+                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
+                </detect>
+                <detect path="name" value="oozie.coord.application.path">
+                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
+                </detect>
+                <detect path="name" value="oozie.bundle.application.path">
+                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
+                </detect>
+                <detect path="name" value="oozie.libpath">
+                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
+                </detect>
+                <detect path="name" value="mapreduce.job.user.name">
+                    <apply path="value" rule="OOZIE/oozie/user-name"/>
+                </detect>
+                <detect path="name" value="mapred.job.tracker">
+                    <apply path="value" rule="OOZIE/oozie/job-tracker-address"/>
+                </detect>
+                <detect path="name" value="mapred.input.dir">
+                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
+                </detect>
+                <detect path="name" value="inputDir">
+                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
+                </detect>
+                <detect path="name" value="mapred.output.dir">
+                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
+                </detect>
+                <detect path="name" value="outputDir">
+                    <apply path="value" rule="OOZIE/oozie/hdfs-path"/>
+                </detect>
+            </buffer>
+        </content>
+        <content type="*/json">
+            <apply path="$[user.name]" rule="OOZIE/oozie/user-name"/>
+            <apply path="$[nameNode]" rule="OOZIE/oozie/name-node-url"/>
+            <apply path="$[jobTracker]" rule="OOZIE/oozie/job-tracker-addr"/>
+            <apply path="$[fs.default.name]" rule="OOZIE/oozie/name-node-url"/>
+            <apply path="$[fs.defaultFS]" rule="OOZIE/oozie/name-node-url"/>
+            <apply path="$[oozie.wf.application.path]" rule="OOZIE/oozie/hdfs-path"/>
+            <apply path="$[oozie.coord.application.path]" rule="OOZIE/oozie/hdfs-path"/>
+            <apply path="$[oozie.bundle.application.path]" rule="OOZIE/oozie/hdfs-path"/>
+            <apply path="$[oozie.libpath]" rule="OOZIE/oozie/hdfs-path"/>
+            <apply path="$[mapreduce.job.user.name]" rule="OOZIE/oozie/user-name"/>
+            <apply path="$[mapred.job.tracker]" rule="OOZIE/oozie/job-tracker-address"/>
+            <apply path="$[mapred.input.dir]" rule="OOZIE/oozie/hdfs-path"/>
+            <apply path="$[mapred.output.dir]" rule="OOZIE/oozie/hdfs-path"/>
+        </content>
+    </filter>
+
+</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie/4.0.0.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie/4.0.0.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie/4.0.0.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie/4.0.0.1/service.xml	2016-08-02 13:20:40.967812286 +0400
@@ -0,0 +1,35 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="OOZIE" name="oozie" version="4.0.0.1">
+    <routes>
+        <route path="/oozie/**?**">
+            <rewrite apply="OOZIE/oozie/configuration" to="request.body"/>
+        </route>
+        <route path="/oozie/v1/**?**">
+            <rewrite apply="OOZIE/oozie/configuration" to="request.body"/>
+        </route>
+        <route path="/oozie/v2/**?**">
+            <rewrite apply="OOZIE/oozie/configuration" to="request.body"/>
+        </route>
+    </routes>
+    <testURLs>
+        <testURL>/oozie/v1/admin/build-version</testURL>
+        <testURL>/oozie/v1/admin/status</testURL>
+        <testURL>/oozie/versions</testURL>
+    </testURLs>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozieui/4.2.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozieui/4.2.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozieui/4.2.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozieui/4.2.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,28 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-    <rule dir="IN" name="OOZIEUI/oozie/inbound/root" pattern="*://*:*/**/oozie/">
-        <rewrite template="{$serviceUrl[OOZIEUI]}/"/>
-    </rule>
-    <rule dir="IN" name="OOZIEUI/oozie/inbound/path" pattern="*://*:*/**/oozie/{**}">
-        <rewrite template="{$serviceUrl[OOZIEUI]}/{**}"/>
-    </rule>
-    <rule dir="IN" name="OOZIEUI/oozie/inbound/query" pattern="*://*:*/**/oozie/{**}?{**}">
-        <rewrite template="{$serviceUrl[OOZIEUI]}/{**}?{**}"/>
-    </rule>
-</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozieui/4.2.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozieui/4.2.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozieui/4.2.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozieui/4.2.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,24 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="OOZIEUI" name="oozie" version="4.2.0">
-    <routes>
-        <route path="/oozie/"/>
-        <route path="/oozie/**"/>
-        <route path="/oozie/**?**"/>
-    </routes>
-</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie-ui/4.2.0.4.2/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie-ui/4.2.0.4.2/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie-ui/4.2.0.4.2/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie-ui/4.2.0.4.2/rewrite.xml	2016-08-02 13:20:40.974812449 +0400
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+    <rule dir="IN" name="OOZIEUI/oozie/inbound/root" pattern="*://*:*/**/oozie/">
+        <rewrite template="{$serviceUrl[OOZIEUI]}/"/>
+    </rule>
+    <rule dir="IN" name="OOZIEUI/oozie/inbound/path" pattern="*://*:*/**/oozie/{**}">
+        <rewrite template="{$serviceUrl[OOZIEUI]}/{**}"/>
+    </rule>
+    <rule dir="IN" name="OOZIEUI/oozie/inbound/query" pattern="*://*:*/**/oozie/{**}?{**}">
+        <rewrite template="{$serviceUrl[OOZIEUI]}/{**}?{**}"/>
+    </rule>
+</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie-ui/4.2.0.4.2/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie-ui/4.2.0.4.2/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/oozie-ui/4.2.0.4.2/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/oozie-ui/4.2.0.4.2/service.xml	2016-08-02 13:20:40.976812496 +0400
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="OOZIEUI" name="oozie" version="4.2.0.4.2">
+    <routes>
+        <route path="/oozie/"/>
+        <route path="/oozie/**"/>
+        <route path="/oozie/**?**"/>
+    </routes>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/solr/5.1.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/solr/5.1.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/solr/5.1.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/solr/5.1.0/rewrite.xml	2016-08-02 13:20:40.982812636 +0400
@@ -0,0 +1,28 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+    <!-- Inbound rules -->
+    <rule dir="IN" name="SOLR/inbound/solr/dir" pattern="*://*:*/**/solr/">
+        <rewrite template="{$serviceUrl[SOLR]}/"/>
+    </rule>
+    <rule dir="IN" name="SOLR/inbound/solr/path" pattern="*://*:*/**/solr/{**}">
+        <rewrite template="{$serviceUrl[SOLR]}/{**}"/>
+    </rule>
+    <rule dir="IN" name="SOLR/inbound/solr/query" pattern="*://*:*/**/solr/{**}?{**}">
+        <rewrite template="{$serviceUrl[SOLR]}/{**}?{**}"/>
+    </rule>
+</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/solr/5.1.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/solr/5.1.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/solr/5.1.0/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/solr/5.1.0/service.xml	2016-08-02 13:20:40.984812683 +0400
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="SOLR" name="solr" version="5.1.0">
+    <routes>
+        <route path="/solr/"/>
+        <route path="/solr/**"/>
+        <route path="/solr/**?**"/>
+    </routes>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/sparkhistoryui/1.4.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/sparkhistoryui/1.4.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/sparkhistoryui/1.4.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/sparkhistoryui/1.4.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,104 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-  <rule dir="IN" name="SPARKHISTORYUI/sparkhistory/inbound/root" pattern="*://*:*/**/sparkhistory/">
-    <rewrite template="{$serviceUrl[SPARKHISTORYUI]}/"/>
-  </rule>
-  <rule dir="IN" name="SPARKHISTORYUI/sparkhistory/inbound/path" pattern="*://*:*/**/sparkhistory/{**}">
-    <rewrite template="{$serviceUrl[SPARKHISTORYUI]}/{**}"/>
-  </rule>
-  <rule dir="IN" name="SPARKHISTORYUI/sparkhistory/inbound/query" pattern="*://*:*/**/sparkhistory/{**}?{**}">
-    <rewrite template="{$serviceUrl[SPARKHISTORYUI]}/{**}?{**}"/>
-  </rule>
-  <rule dir="IN" name="SPARKHISTORYUI/sparkhistory/inbound/history" pattern="*://*:*/**/sparkhistory/history/{**}/?{**}">
-    <rewrite template="{$serviceUrl[SPARKHISTORYUI]}/history/{**}/?{**}"/>
-  </rule>
-  <rule dir="IN" name="SPARKHISTORYUI/sparkhistory/inbound/apps" pattern="*://*:*/**/sparkhistory/?{page}?{showIncomplete}">
-    <rewrite template="{$serviceUrl[SPARKHISTORYUI]}/?{page}?{showIncomplete}"/>
-  </rule>
-
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/history" pattern="/history/{**}">
-    <rewrite template="{$frontend[url]}/sparkhistory/history/{**}"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/history/job" pattern="/history/{**}?{**}">
-    <rewrite template="{$frontend[url]}/sparkhistory/history/{**}?{**}"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/bootstrap" pattern="/static/{bootstrap=bootstrap*}">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/{bootstrap}"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/vis" pattern="/static/{vis=vis.min.*}">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/{vis}"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/webui" pattern="/static/webui.css">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/webui.css"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/timeline" pattern="/static/{timeline=timeline-view*}">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/{timeline}"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/sorttable" pattern="/static/sorttable.js">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/sorttable.js"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/jquery" pattern="/static/{jquery=jquery*.min.js}">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/{jquery}"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/initialize" pattern="/static/initialize-tooltips.js">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/initialize-tooltips.js"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/table" pattern="/static/table.js">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/table.js"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/additional" pattern="/static/additional-metrics.js">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/additional-metrics.js"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/spark" pattern="/static/{spark=spark*}">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/{spark}"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/d3" pattern="/static/{d3=*d3.min.js}">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/{d3}"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/static/graphlib" pattern="/static/graphlib-dot.min.js">
-    <rewrite template="{$frontend[url]}/sparkhistory/static/graphlib-dot.min.js"/>
-  </rule>
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/apps" pattern="/?{page}?{showIncomplete}">
-    <rewrite template="{$frontend[url]}/sparkhistory/?{page}?{showIncomplete}"/>
-  </rule>
-
-  <rule dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/headers/location">
-    <match pattern="*://*:*/history/{**}/?{**}"/>
-    <rewrite template="{$frontend[url]}/sparkhistory/history/{**}/?{**}"/>
-  </rule>
-  <rule flow="OR" dir="OUT" name="SPARKHISTORYUI/sparkhistory/outbound/headers/jobs/location">
-    <match pattern="*://*:*/history/{**}/jobs">
-      <rewrite template="{$frontend[url]}/sparkhistory/history/{**}/jobs"/>
-    </match>
-    <match pattern="*://*:*/history/{**}/jobs/">
-      <rewrite template="{$frontend[url]}/sparkhistory/history/{**}/jobs/"/>
-    </match>
-  </rule>
-
-  <filter name="SPARKHISTORYUI/sparkhistory/outbound/headers">
-    <content type="application/x-http-headers">
-      <apply path="Location" rule="SPARKHISTORYUI/sparkhistory/outbound/headers/location"/>
-    </content>
-  </filter>
-  <filter name="SPARKHISTORYUI/sparkhistory/outbound/headers/jobs">
-    <content type="application/x-http-headers">
-      <apply path="Location" rule="SPARKHISTORYUI/sparkhistory/outbound/headers/jobs/location"/>
-    </content>
-  </filter>
-</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/sparkhistoryui/1.4.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/sparkhistoryui/1.4.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/sparkhistoryui/1.4.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/sparkhistoryui/1.4.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,33 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="SPARKHISTORYUI" name="sparkhistory" version="1.4.0">
-    <routes>
-        <route path="/sparkhistory/"/>
-        <route path="/sparkhistory/**"/>
-        <route path="/sparkhistory/**?**"/>
-        <route path="/sparkhistory/history/**?**">
-            <rewrite apply="SPARKHISTORYUI/sparkhistory/outbound/headers" to="response.headers"/>
-        </route>
-        <route path="/sparkhistory/history/**/?**">
-            <rewrite apply="SPARKHISTORYUI/sparkhistory/outbound/headers/jobs" to="response.headers"/>
-        </route>
-        <route path="/sparkhistory/history/**/jobs/**?**">
-            <rewrite apply="SPARKHISTORYUI/sparkhistory/outbound/headers/jobs" to="response.headers"/>
-        </route>
-    </routes>
-</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/spark-thrift-ui/1.6.1.4.2/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/spark-thrift-ui/1.6.1.4.2/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/spark-thrift-ui/1.6.1.4.2/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/spark-thrift-ui/1.6.1.4.2/rewrite.xml	2016-08-02 13:20:40.979812567 +0400
@@ -0,0 +1,122 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+  
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+  <!-- Inbound  rewrite rules   -->
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/jobs" pattern="*://*:*/**/thrift/jobs/">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/jobs/"/>
+  </rule>
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/stages" pattern="*://*:*/**/thrift/stages/">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/stages/"/>
+  </rule>
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/storage" pattern="*://*:*/**/thrift/storage/">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/storage/"/>
+  </rule>
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/environment" pattern="*://*:*/**/thrift/environment/">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/environment/"/>
+  </rule>
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/executors" pattern="*://*:*/**/thrift/executors/">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/executors/"/>
+  </rule>
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/executors/query" pattern="*://*:*/**/thrift/executors/threadDump/?{*}">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/executors/threadDump/?{*}"/>
+  </rule>
+
+
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/SQL" pattern="*://*:*/**/thrift/SQL/">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/SQL/"/>
+  </rule>
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/sqlserver" pattern="*://*:*/**/thrift/sqlserver/">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/sqlserver/"/>
+  </rule>
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/sqlserver/query" pattern="*://*:*/**/thrift/sqlserver/session/?{**}">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/sqlserver/session/?{**}"/>
+  </rule>
+
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/jobs1" pattern="*://*:*/**/thrift/jobs/{**}?{**}">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/jobs/{**}?{**}"/>
+  </rule>
+
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/root" pattern="*://*:*/**/thrift/">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/"/>
+  </rule>
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/path" pattern="*://*:*/**/thrift/{**}">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/{**}"/>
+  </rule>
+  <rule dir="IN" name="THRIFTSERVERUI/thrift/inbound/query" pattern="*://*:*/**/thrift/{**}?{**}">
+    <rewrite template="{$serviceUrl[THRIFTSERVERUI]}/{**}?{**}"/>
+  </rule>
+
+
+<!-- matches ouput href="/" so it throws you back to main spark history server page -->
+  <rule dir="OUT" name="THRIFSERVERUI/root/OUT" pattern="/">
+    <rewrite template="{gateway.url}/thrift/"/>
+  </rule>
+
+
+  <rule dir="OUT" name="THRIFTSERVERUI/jobs/OUT" pattern="/jobs/">>
+    <rewrite template="{$frontend[url]}/thrift/jobs/"/>
+  </rule>
+  <rule dir="OUT" name="THRIFTSERVERUI/environment/OUT" pattern="/environment/">>
+    <rewrite template="{$frontend[url]}/thrift/environment/"/>
+  </rule>
+  <rule dir="OUT" name="THRIFTSERVERUI/stages/OUT" pattern="/stages/">>
+    <rewrite template="{$frontend[url]}/thrift/stages/"/>
+  </rule>
+  <rule dir="OUT" name="THRIFTSERVERUI/storage/OUT" pattern="/storage/">>
+    <rewrite template="{$frontend[url]}/thrift/storage/"/>
+  </rule>
+  <rule dir="OUT" name="THRIFTSERVERUI/executors/OUT" pattern="/executors/">>
+    <rewrite template="{$frontend[url]}/thrift/executors/"/>
+  </rule>
+  <rule dir="OUT" name="THRIFTSERVERUI/SQL/OUT" pattern="/SQL/">>
+    <rewrite template="{$frontend[url]}/thrift/SQL/"/>
+  </rule>
+  <rule dir="OUT" name="THRIFTSERVERUI/sqlserver/OUT" pattern="/sqlserver/">>
+    <rewrite template="{$frontend[url]}/thrift/sqlserver/"/>
+  </rule>
+  <rule dir="OUT" name="THRIFTSERVERUI/sqlserver/ext/OUT" pattern="/sqlserver/{*}?{**}">>
+    <rewrite template="{$frontend[url]}/thrift/sqlserver/{*}?{**}"/>
+  </rule>
+
+  
+<!-- static web resources (css, js, png,etc)  in web page rewrite -->
+  <rule dir="OUT" name="THRIFTSERVERUI/static/OUT" pattern="/static/{**}">
+    <rewrite template="{gateway.url}/thrift/static/{**}"/>
+  </rule>
+  <rule dir="OUT" name="THRIFTSERVERUI/spark/outbound/apps" pattern="/?{page}?{showIncomplete}">
+    <rewrite template="{gateway.url}/thrift/?{page}?{showIncomplete}"/>
+  </rule>
+  <rule dir="OUT" name="THRIFTSERVERUI/spark/outbound/threaddump" pattern="threadDump/?{*}">
+    <rewrite template="{gateway.url}/thrift/executors/threadDump/?{*}"/>
+  </rule>
+
+
+
+  <filter name="THRIFTSERVERUI/thrift/outbound/headers">
+    <content type="application/x-http-headers">
+      <apply path="Location" rule="THRIFTSERVERUI/thrift/outbound/headers/location"/>
+    </content>
+  </filter>
+
+  <!-- RULE - redirection (302) response rules -->
+  <rule dir="OUT" name="THRIFTSERVERUI/thrift/outbound/headers/location">
+    <match pattern="*://*:*/jobs/"/>
+    <rewrite template="{$frontend[url]}/thrift/jobs/"/>
+  </rule>
+
+</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/spark-thrift-ui/1.6.1.4.2/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/spark-thrift-ui/1.6.1.4.2/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/spark-thrift-ui/1.6.1.4.2/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/spark-thrift-ui/1.6.1.4.2/service.xml	2016-08-02 13:20:40.981812613 +0400
@@ -0,0 +1,33 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="THRIFTSERVERUI" name="thriftserverui" version="1.4.1.4.2">
+    <routes>
+        <route path="/thrift/jobs">
+        </route>
+
+        <route path="/thrift/">
+            <rewrite apply="THRIFTSERVERUI/thrift/outbound/headers" to="response.headers"/>
+        </route>
+        <route path="/thrift/**">
+            <rewrite apply="THRIFTSERVERUI/thrift/outbound/headers" to="response.headers"/>
+        </route>
+        <route path="/thrift/**?**">
+            <rewrite apply="THRIFTSERVERUI/thrift/outbound/headers" to="response.headers"/>
+        </route>
+    </routes>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/spark-ui/1.4.1.4.2/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/spark-ui/1.4.1.4.2/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/spark-ui/1.4.1.4.2/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/spark-ui/1.4.1.4.2/rewrite.xml	2016-08-02 13:20:41.023813595 +0400
@@ -0,0 +1,118 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+  
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+  <!-- Inbound  rewrite rules   -->
+  <rule dir="IN" name="SPARKUI/spark/inbound/root" pattern="*://*:*/**/spark/">
+    <rewrite template="{$serviceUrl[SPARKUI]}/"/>
+  </rule>
+  <rule dir="IN" name="SPARKUI/spark/inbound/path" pattern="*://*:*/**/spark/{**}">
+    <rewrite template="{$serviceUrl[SPARKUI]}/{**}"/>
+  </rule>
+  <rule dir="IN" name="SPARKUI/spark/inbound/query" pattern="*://*:*/**/spark/{**}?{**}">
+    <rewrite template="{$serviceUrl[SPARKUI]}/{**}?{**}"/>
+  </rule>
+  <rule dir="IN" name="SPARKUI/spark/inbound/query" pattern="*://*:*/**/spark/history/{**}/?{**}">
+    <rewrite template="{$serviceUrl[SPARKUI]}/history/{**}/?{**}"/>
+  </rule>
+  <rule dir="IN" name="SPARKUI/spark/inbound/apps" pattern="*://*:*/**/spark/?{page}?{showIncomplete}">
+    <rewrite template="{$serviceUrl[SPARKUI]}//?{page}?{showIncomplete}"/>
+  </rule>
+
+  <rule dir="IN" name="SPARKUI/spark/inbound/nodemanager/containerlogs/container" 
+      pattern="*://*:*/**/spark/nodemanager/node/containerlogs/{**}/spark/{**}?{scheme}?{host}?{port}?{**}">
+      <rewrite template="{scheme}://{host}:{port}/node/containerlogs/{**}/spark/{**}?{**}"/>
+  </rule>
+
+  <rule dir="IN" name="SPARKUI/spark/inbound/jobhistory/job" pattern="*://*:*/**/yarn/jobhistory/job/{**}?{scheme}?{host}?{port}">
+      <rewrite template="{scheme}://{host}:{port}/jobhistory/job/{**}"/>
+  </rule>
+
+  <!-- Outbound rewrite rules   -->
+
+  <!-- spark job history web page rewrite -->
+
+  <!-- matches ouput href="/" so it throws you back to main spark history server page -->
+  <rule dir="OUT" name="SPARKUI/root/OUT" pattern="/">
+    <rewrite template="{gateway.url}/spark/"/>
+  </rule>
+  <rule dir="OUT" name="SPARKUI/yarn/outbound/node/containerlogs" pattern="{scheme}://{host}:{port}/node/containerlogs/{**}/spark/{op}?{**}">
+    <rewrite template="{$frontend[url]}/spark//nodemanager/node/containerlogs/{**}/spark/{op}?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
+  </rule>
+
+  <!-- history server paths -->
+
+  <rule dir="OUT" name="SPARKUI/history/path/OUT" pattern="/history/{**}">
+    <rewrite template="{gateway.url}/spark/history/{**}"/>
+  </rule>
+
+  <rule dir="OUT" name="SPARKUI/spark/outbound/history/query" pattern="/history/{**}?{**}">
+    <rewrite template="{gateway.url}/spark/history/{**}?{**}"/>
+  </rule>
+
+  <!-- static web resources (css, js, png,etc)  in web page rewrite -->
+  <rule dir="OUT" name="SPARKUI/static/OUT" pattern="/static/{**}">
+    <rewrite template="{gateway.url}/spark/static/{**}"/>
+  </rule>
+  <rule dir="OUT" name="SPARKUI/spark/outbound/apps" pattern="/?{page}?{showIncomplete}">
+    <rewrite template="{gateway.url}/spark/?{page}?{showIncomplete}"/>
+  </rule>
+
+  <!-- RULE - redirection (302) response rules -->
+  <rule dir="OUT" name="SPARKUI/spark/outbound/headers/location">
+    <match pattern="*://*:*/history/{**}/?{**}"/>
+    <rewrite template="{$frontend[url]}/spark/history/{**}/?{**}"/>
+  </rule>
+
+  <!-- RULES -  redirection (302) matching rules for above -->
+  <rule flow="OR" dir="OUT" name="SPARKUI/spark/outbound/headers/jobs/location">
+    <match pattern="*://*:*/history/{**}/jobs">
+      <rewrite template="{$frontend[url]}/spark/history/{**}/jobs"/>
+    </match>
+    <match pattern="*://*:*/history/{**}/jobs/">
+      <rewrite template="{$frontend[url]}/spark/history/{**}/jobs/"/>
+    </match>
+  </rule>
+
+  <!--  these matched the services definition to change Location response header user RULES set above for jobs and headers-->
+  <filter name="SPARKUI/spark/outbound/headers">
+    <content type="application/x-http-headers">
+      <apply path="Location" rule="SPARKUI/spark/outbound/headers/location"/>
+    </content>
+  </filter>
+  <filter name="SPARKUI/spark/outbound/headers/jobs">
+    <content type="application/x-http-headers">
+      <apply path="Location" rule="SPARKUI/spark/outbound/headers/jobs/location"/>
+    </content>
+  </filter>
+
+  <rule flow="OR" dir="OUT" name="SPARKUI/yarn/outbound/headers/jobhistory/job/location">
+    <match pattern="{scheme}://{host}:{port}/jobhistory/job/{**}">
+        <rewrite template="{$frontend[url]}/yarn/jobhistory/job/{**}?{scheme}?{host}?{port}"/>
+    </match>
+    <match pattern="{scheme}://{host}:{port}/history/{**}?{**}">
+        <rewrite template="{$frontend[url]}/yarn/history/{**}?{**}?{scheme}?{host}?{port}"/>
+    </match>
+    <match pattern="*://*:*/cluster/app/{**}">
+        <rewrite template="{$frontend[url]}/yarn/cluster/app/{**}"/>
+    </match>
+  </rule>
+
+  <rule dir="OUT" name="SPARKUI/spark/inbound/jobhistory/logs" pattern="*1; url=*://*:*/jobhistory/logs/{**}">
+    <rewrite template="1; url=/gateway/jobstoryui/jobstory/jobhistory/logs/{**}"/>
+  </rule>
+</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/spark-ui/1.4.1.4.2/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/spark-ui/1.4.1.4.2/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/spark-ui/1.4.1.4.2/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/spark-ui/1.4.1.4.2/service.xml	2016-08-02 13:20:41.024813618 +0400
@@ -0,0 +1,36 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="SPARKUI" name="sparkui" version="1.4.1.4.2">
+    <routes>
+        <route path="/spark/"/>
+        <route path="/spark/**"/>
+        <route path="/spark/**?**"/>
+        <route path="/spark/history/**">
+            <rewrite apply="SPARKUI/spark/outbound/headers" to="response.headers"/>
+        </route>
+        <route path="/spark/history/**?**">
+            <rewrite apply="SPARKUI/spark/outbound/headers" to="response.headers"/>
+        </route>
+        <route path="/spark/history/**/?**">
+            <rewrite apply="SPARKUI/spark/outbound/headers/jobs" to="response.headers"/>
+        </route>
+        <route path="/spark/history/**/jobs/**?**">
+            <rewrite apply="SPARKUI/spark/outbound/headers/jobs" to="response.headers"/>
+        </route>
+    </routes>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,28 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-
-    <rule dir="IN" name="WEBHCAT/webhcat/root/inbound" pattern="*://*:*/**/templeton/v1/?{**}">
-      <rewrite template="{$serviceUrl[WEBHCAT]}/v1/?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="WEBHCAT/webhcat/path/inbound" pattern="*://*:*/**/templeton/v1/{path=**}?{**}">
-      <rewrite template="{$serviceUrl[WEBHCAT]}/v1/{path=**}?{**}"/>
-    </rule>
-
-</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,29 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="WEBHCAT" name="webhcat" version="0.13.0">
-    <routes>
-        <route path="/templeton/v1/?**"/>
-        <route path="/templeton/v1/**?**"/>
-    </routes>
-    <testURLs>
-        <testURL>/templeton/v1/status</testURL>
-        <testURL>/templeton/v1/version</testURL>
-        <testURL>/templeton/v1/version/hive</testURL>
-        <testURL>/templeton/v1/version/hadoop</testURL>
-    </testURLs>
-</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0.1/rewrite.xml	2016-08-02 13:20:40.967812286 +0400
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+
+    <rule dir="IN" name="WEBHCAT/webhcat/root/inbound" pattern="*://*:*/**/templeton/v1/?{**}">
+      <rewrite template="{$serviceUrl[WEBHCAT]}/v1/?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="WEBHCAT/webhcat/path/inbound" pattern="*://*:*/**/templeton/v1/{path=**}?{**}">
+      <rewrite template="{$serviceUrl[WEBHCAT]}/v1/{path=**}?{**}"/>
+    </rule>
+
+</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhcat/0.13.0.1/service.xml	2016-08-02 13:20:40.970812355 +0400
@@ -0,0 +1,29 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="WEBHCAT" name="webhcat" version="0.13.0.1">
+    <routes>
+        <route path="/templeton/v1/?**"/>
+        <route path="/templeton/v1/**?**"/>
+    </routes>
+    <testURLs>
+        <testURL>/templeton/v1/status</testURL>
+        <testURL>/templeton/v1/version</testURL>
+        <testURL>/templeton/v1/version/hive</testURL>
+        <testURL>/templeton/v1/version/hadoop</testURL>
+    </testURLs>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,70 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-
-    <rule dir="OUT" name="WEBHDFS/webhdfs/outbound" pattern="hdfs://*:*/{path=**}?{**}">
-        <rewrite template="{$frontend[url]}/webhdfs/v1/{path=**}?{**}"/>
-    </rule>
-
-    <rule dir="OUT" name="WEBHDFS/webhdfs/outbound" pattern="webhdfs://*:*/{path=**}?{**}">
-        <rewrite template="{$frontend[url]}/webhdfs/v1/{path=**}?{**}"/>
-    </rule>
-
-    <rule dir="OUT" name="WEBHDFS/webhdfs/outbound/namenode/headers/location">
-        <match pattern="{scheme}://{host}:{port}/{path=**}?{**}"/>
-        <rewrite template="{$frontend[url]}/webhdfs/data/v1/{path=**}?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
-        <encrypt-query/>
-    </rule>
-
-    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/hdfs" pattern="hdfs:/{path=**}?{**}">
-        <rewrite template="{$serviceMappedUrl[NAMENODE]}/{path=**}?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/webhdfs" pattern="webhdfs:/{path=**}?{**}">
-        <rewrite template="{$serviceUrl[WEBHDFS]}/{path=**}?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/namenode/root" pattern="*://*:*/**/webhdfs/{version}/?{**}">
-        <rewrite template="{$serviceUrl[WEBHDFS]}/{version}/?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/namenode/file" pattern="*://*:*/**/webhdfs/{version}/{path=**}?{**}">
-        <rewrite template="{$serviceUrl[WEBHDFS]}/{version}/{path=**}?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/namenode/home" pattern="*://*:*/**/webhdfs/{version}/~?{**}">
-        <rewrite template="{$serviceUrl[WEBHDFS]}/{version}/user/{$username}?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/namenode/home/file" pattern="*://*:*/**/webhdfs/{version}/~/{path=**}?{**}">
-        <rewrite template="{$serviceUrl[WEBHDFS]}/{version}/user/{$username}/{path=**}?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/datanode">
-        <decrypt-query/>
-        <match pattern="*://*:*/**/webhdfs/data/*/{path=**}?{scheme}?{host}?{port}?{**}"/>
-        <rewrite template="{scheme}://{host}:{port}/{path=**}?{**}"/>
-    </rule>
-
-    <filter name="WEBHDFS/webhdfs/outbound/namenode/headers">
-        <content type="application/x-http-headers">
-            <apply path="Location" rule="WEBHDFS/webhdfs/outbound/namenode/headers/location"/>
-        </content>
-    </filter>
-
-</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,43 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="WEBHDFS" name="webhdfs" version="2.4.0">
-    <routes>
-        <route path="/webhdfs/v1/?**">
-            <rewrite apply="WEBHDFS/webhdfs/inbound/namenode/root" to="request.url"/>
-        </route>
-        <route path="/webhdfs/v1/**?**">
-            <rewrite apply="WEBHDFS/webhdfs/inbound/namenode/file" to="request.url"/>
-            <rewrite apply="WEBHDFS/webhdfs/outbound/namenode/headers" to="response.headers"/>
-        </route>
-        <route path="/webhdfs/v1/~?**">
-            <rewrite apply="WEBHDFS/webhdfs/inbound/namenode/home" to="request.url"/>
-        </route>
-        <route path="/webhdfs/v1/~/**?**">
-            <rewrite apply="WEBHDFS/webhdfs/inbound/namenode/home/file" to="request.url"/>
-            <rewrite apply="WEBHDFS/webhdfs/outbound/namenode/headers" to="response.headers"/>
-        </route>
-        <route path="/webhdfs/data/v1/**?**">
-            <rewrite apply="WEBHDFS/webhdfs/inbound/datanode" to="request.url"/>
-            <dispatch contributor-name="http-client" />
-        </route>
-    </routes>
-    <dispatch classname="org.apache.hadoop.gateway.hdfs.dispatch.HdfsHttpClientDispatch" ha-classname="org.apache.hadoop.gateway.hdfs.dispatch.WebHdfsHaDispatch"/>
-    <testURLs>
-        <testURL>/webhdfs/v1/?op=LISTSTATUS</testURL>
-    </testURLs>
-</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0.1/rewrite.xml	2016-08-02 13:20:41.026813664 +0400
@@ -0,0 +1,70 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+
+    <rule dir="OUT" name="WEBHDFS/webhdfs/outbound" pattern="hdfs://*:*/{path=**}?{**}">
+        <rewrite template="{$frontend[url]}/webhdfs/v1/{path=**}?{**}"/>
+    </rule>
+
+    <rule dir="OUT" name="WEBHDFS/webhdfs/outbound" pattern="webhdfs://*:*/{path=**}?{**}">
+        <rewrite template="{$frontend[url]}/webhdfs/v1/{path=**}?{**}"/>
+    </rule>
+
+    <rule dir="OUT" name="WEBHDFS/webhdfs/outbound/namenode/headers/location">
+        <match pattern="{scheme}://{host}:{port}/{path=**}?{**}"/>
+        <rewrite template="{$frontend[url]}/webhdfs/data/v1/{path=**}?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
+        <encrypt-query/>
+    </rule>
+
+    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/hdfs" pattern="hdfs:/{path=**}?{**}">
+        <rewrite template="{$serviceMappedUrl[NAMENODE]}/{path=**}?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/webhdfs" pattern="webhdfs:/{path=**}?{**}">
+        <rewrite template="{$serviceUrl[WEBHDFS]}/{path=**}?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/namenode/root" pattern="*://*:*/**/webhdfs/{version}/?{**}">
+        <rewrite template="{$serviceUrl[WEBHDFS]}/{version}/?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/namenode/file" pattern="*://*:*/**/webhdfs/{version}/{path=**}?{**}">
+        <rewrite template="{$serviceUrl[WEBHDFS]}/{version}/{path=**}?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/namenode/home" pattern="*://*:*/**/webhdfs/{version}/~?{**}">
+        <rewrite template="{$serviceUrl[WEBHDFS]}/{version}/user/{$username}?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/namenode/home/file" pattern="*://*:*/**/webhdfs/{version}/~/{path=**}?{**}">
+        <rewrite template="{$serviceUrl[WEBHDFS]}/{version}/user/{$username}/{path=**}?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="WEBHDFS/webhdfs/inbound/datanode">
+        <decrypt-query/>
+        <match pattern="*://*:*/**/webhdfs/data/*/{path=**}?{scheme}?{host}?{port}?{**}"/>
+        <rewrite template="{scheme}://{host}:{port}/{path=**}?{**}"/>
+    </rule>
+
+    <filter name="WEBHDFS/webhdfs/outbound/namenode/headers">
+        <content type="application/x-http-headers">
+            <apply path="Location" rule="WEBHDFS/webhdfs/outbound/namenode/headers/location"/>
+        </content>
+    </filter>
+
+</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/webhdfs/2.4.0.1/service.xml	2016-08-02 13:20:41.027813688 +0400
@@ -0,0 +1,43 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="WEBHDFS" name="webhdfs" version="2.4.0.1">
+    <routes>
+        <route path="/webhdfs/v1/?**">
+            <rewrite apply="WEBHDFS/webhdfs/inbound/namenode/root" to="request.url"/>
+        </route>
+        <route path="/webhdfs/v1/**?**">
+            <rewrite apply="WEBHDFS/webhdfs/inbound/namenode/file" to="request.url"/>
+            <rewrite apply="WEBHDFS/webhdfs/outbound/namenode/headers" to="response.headers"/>
+        </route>
+        <route path="/webhdfs/v1/~?**">
+            <rewrite apply="WEBHDFS/webhdfs/inbound/namenode/home" to="request.url"/>
+        </route>
+        <route path="/webhdfs/v1/~/**?**">
+            <rewrite apply="WEBHDFS/webhdfs/inbound/namenode/home/file" to="request.url"/>
+            <rewrite apply="WEBHDFS/webhdfs/outbound/namenode/headers" to="response.headers"/>
+        </route>
+        <route path="/webhdfs/data/v1/**?**">
+            <rewrite apply="WEBHDFS/webhdfs/inbound/datanode" to="request.url"/>
+            <dispatch contributor-name="http-client" />
+        </route>
+    </routes>
+    <dispatch classname="org.apache.hadoop.gateway.hdfs.dispatch.HdfsHttpClientDispatch" ha-classname="org.apache.hadoop.gateway.hdfs.dispatch.WebHdfsHaDispatch"/>
+    <testURLs>
+        <testURL>/webhdfs/v1/?op=LISTSTATUS</testURL>
+    </testURLs>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,193 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-
-    <rule dir="IN" name="RESOURCEMANAGER/resourcemanager/inbound/root" pattern="*://*:*/**/resourcemanager/v1/?{**}">
-        <rewrite template="{$serviceUrl[RESOURCEMANAGER]}/v1/?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="RESOURCEMANAGER/resourcemanager/inbound/path" pattern="*://*:*/**/resourcemanager/v1/{path=**}?{**}">
-        <rewrite template="{$serviceUrl[RESOURCEMANAGER]}/v1/{path=**}/?{**}"/>
-    </rule>
-
-    <rule dir="IN" name="RESOURCEMANAGER/resourcemanager/inbound/proxy" pattern="*://*:*/**/resourcemanager/proxy/{appid=*}/ws/v1/{path=**}?{**}">
-        <decrypt-query/>
-        <match pattern="*://*:*/**/resourcemanager/proxy/{appid=*}/ws/v1/{path=**}?{scheme}?{host}?{port}?{**}"/>
-        <rewrite template="{scheme}://{host}:{port}/proxy/{appid=*}/ws/v1/{path=**}?{**}"/>
-    </rule>
-
-    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/url/outbound">
-        <match pattern="*://*:*/**?**"/>
-		<rewrite template=""/>
-    </rule>
-    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/trackingUrlHistory/outbound">
-        <match pattern="{scheme}://{host}:{port}/proxy/{appid=*}/jobhistory/job/**"/>
-		<rewrite template=""/>
-    </rule>
-    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/trackingUrlAM/outbound">
-        <match pattern="{scheme}://{host}:{port}/proxy/{appid=*}"/>
-		<rewrite template="{$frontend[url]}/resourcemanager/proxy/{appid=*}?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
-		<encrypt-query/>
-    </rule>
-    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/hostport/outbound">
-        <match pattern="*:*"/>
-		<rewrite template=""/>
-    </rule>
-    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/logsLink/outbound">
-        <match pattern="//*:*/**?**"/>
-		<rewrite template=""/>
-    </rule>
-    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/host/outbound">
-		<rewrite template=""/>
-    </rule>
-    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/nodeId/outbound">
-        <match pattern="{host=*}:{port=*}"/>
-        <encrypt template="{host}:{port}" param="encaddr"/>
-        <rewrite template="{encaddr}"/>
-    </rule>
-    <rule dir="IN" name="RESOURCEMANAGER/resourcemanager/nodeId/inbound">
-        <match pattern="*://*:*/**/resourcemanager/v1/cluster/nodes/{addr=*}?{**}"/>
-        <decrypt param="addr"/>
-        <rewrite template="{$serviceUrl[RESOURCEMANAGER]}/v1/cluster/nodes/{addr}?{**}"/>
-    </rule>
-
-    <filter name="RESOURCEMANAGER/resourcemanager/apps/outbound">
-        <content type="*/json">
-        	<buffer path="$.apps.app[*]">
-        		<detect path="$.trackingUI" value="History">
-					<apply path="$.trackingUrl" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
-				</detect>
-				<detect path="$.trackingUI" value="ApplicationMaster">
-					<apply path="$.trackingUrl" rule="RESOURCEMANAGER/resourcemanager/trackingUrlAM/outbound"/>
-				</detect>
-				<apply path="$.amContainerLogs" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
-            	<apply path="$.amHostHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-        	</buffer>
-        </content>
-        <content type="*/xml">
-        	<buffer path="/apps/app">
-        		<detect path="trackingUI" value="History">
-					<apply path="trackingUrl" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
-				</detect>
-				<detect path="trackingUI" value="ApplicationMaster">
-					<apply path="trackingUrl" rule="RESOURCEMANAGER/resourcemanager/trackingUrlAM/outbound"/>
-				</detect>
-				<apply path="amContainerLogs" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
-            	<apply path="amHostHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-        	</buffer>
-        </content>
-    </filter>
-
-    <filter name="RESOURCEMANAGER/resourcemanager/app/outbound">
-        <content type="*/json">
-        	<buffer path="$.app">
-	       		<detect path="$.trackingUI" value="History">
-	       			<apply path="$.trackingUrl" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
-	       		</detect>
-	       		<detect path="$.trackingUI" value="ApplicationMaster">
-	       			<apply path="$.trackingUrl" rule="RESOURCEMANAGER/resourcemanager/trackingUrlAM/outbound"/>
-	       		</detect>
-	            <apply path="$.amContainerLogs" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
-	            <apply path="$.amHostHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-            </buffer>
-        </content>
-        <content type="*/xml">
-        	<buffer path="/app">
-	       		<detect path="trackingUI" value="History">
-	       			<apply path="trackingUrl" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
-	       		</detect>
-	       		<detect path="trackingUI" value="ApplicationMaster">
-	       			<apply path="trackingUrl" rule="RESOURCEMANAGER/resourcemanager/trackingUrlAM/outbound"/>
-	       		</detect>
-	            <apply path="amContainerLogs" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
-	            <apply path="amHostHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-            </buffer>
-        </content>
-    </filter>
-
-    <filter name="RESOURCEMANAGER/resourcemanager/appattempts/outbound">
-        <content type="*/json">
-            <apply path="$.appAttempts.appAttempt[*].nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-            <apply path="$.appAttempts.appAttempt[*].logsLink" rule="RESOURCEMANAGER/resourcemanager/logsLink/outbound"/>
-            <apply path="$.appAttempts.appAttempt[*].nodeId" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
-        </content>
-        <content type="*/xml">
-            <apply path="/appAttempts/appAttempt/nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-            <apply path="/appAttempts/appAttempt/logsLink" rule="RESOURCEMANAGER/resourcemanager/logsLink/outbound"/>
-            <apply path="/appAttempts/appAttempt/nodeId" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
-        </content>
-    </filter>
-
-    <filter name="RESOURCEMANAGER/resourcemanager/nodes/outbound">
-        <content type="*/json">
-            <apply path="$.nodes.node[*].nodeHTTPAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-            <apply path="$.nodes.node[*].nodeHostName" rule="RESOURCEMANAGER/resourcemanager/host/outbound"/>
-            <apply path="$.nodes.node[*].id" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
-        </content>
-        <content type="*/xml">
-            <apply path="/nodes/node/nodeHTTPAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-            <apply path="/nodes/node/nodeHostName" rule="RESOURCEMANAGER/resourcemanager/host/outbound"/>
-            <apply path="/nodes/node/id" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
-        </content>
-    </filter>
-
-    <filter name="RESOURCEMANAGER/resourcemanager/node/outbound">
-        <content type="*/json">
-            <apply path="$.node.nodeHTTPAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-            <apply path="$.node.nodeHostName" rule="RESOURCEMANAGER/resourcemanager/host/outbound"/>
-            <apply path="$.node.id" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
-        </content>
-        <content type="*/xml">
-            <apply path="/node/nodeHTTPAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-            <apply path="/node/nodeHostName" rule="RESOURCEMANAGER/resourcemanager/host/outbound"/>
-            <apply path="/node/id" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
-        </content>
-    </filter>
-
-    <filter name="RESOURCEMANAGER/resourcemanager/proxy/jobattempts/outbound">
-        <content type="*/json">
-            <apply path="$.jobAttempts.jobAttempt[*].nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-            <apply path="$.jobAttempts.jobAttempt[*].nodeId" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
-            <apply path="$.jobAttempts.jobAttempt[*].logsLink" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
-        </content>
-        <content type="*/xml">
-            <apply path="/jobAttempts/jobAttempt/nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-            <apply path="/jobAttempts/jobAttempt/nodeId" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
-            <apply path="/jobAttempts/jobAttempt/logsLink" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
-        </content>
-    </filter>
-
-    <filter name="RESOURCEMANAGER/resourcemanager/proxy/taskattempts/outbound">
-        <content type="*/json">
-            <apply path="$.taskAttempts.taskAttempt[*].nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-        </content>
-        <content type="*/xml">
-            <apply path="/taskAttempts/taskAttempt/nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-        </content>
-    </filter>
-
-    <filter name="RESOURCEMANAGER/resourcemanager/proxy/taskattempt/outbound">
-        <content type="*/json">
-            <apply path="$.taskAttempt.nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-        </content>
-        <content type="*/xml">
-            <apply path="/taskAttempt/nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
-        </content>
-    </filter>
-
-</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,59 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="RESOURCEMANAGER" name="resourcemanager" version="2.5.0">
-    <routes>
-        <route path="/resourcemanager/v1/cluster/"/>
-        <route path="/resourcemanager/v1/cluster/**?**"/>
-        <route path="/resourcemanager/v1/cluster/apps?**">
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/apps/outbound" to="response.body"/>
-        </route>
-        <route path="/resourcemanager/v1/cluster/apps?**">
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/apps/outbound" to="response.body"/>
-        </route>
-        <route path="/resourcemanager/v1/cluster/apps/*?**">
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/app/outbound" to="response.body"/>
-        </route>
-        <route path="/resourcemanager/v1/cluster/apps/*/appattempts?**">
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/appattempts/outbound" to="response.body"/>
-        </route>
-        <route path="/resourcemanager/v1/cluster/nodes?**">
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/nodes/outbound" to="response.body"/>
-        </route>
-        <route path="/resourcemanager/v1/cluster/nodes/*?**">
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/nodeId/inbound" to="request.url"/>
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/node/outbound" to="response.body"/>
-        </route>
-        <route path="/resourcemanager/proxy/*/ws/v1/**?**">
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/inbound/proxy" to="request.url"/>
-        </route>
-        <route path="/resourcemanager/proxy/*/ws/v1/mapreduce/jobs/*/jobattempts">
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/proxy/jobattempts/outbound" to="response.body"/>
-        </route>
-        <route path="/resourcemanager/proxy/*/ws/v1/mapreduce/jobs/*/tasks/*/attempts">
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/proxy/taskattempts/outbound" to="response.body"/>
-        </route>
-        <route path="/resourcemanager/proxy/*/ws/v1/mapreduce/jobs/*/tasks/*/attempts/*">
-            <rewrite apply="RESOURCEMANAGER/resourcemanager/proxy/taskattempt/outbound" to="response.body"/>
-        </route>
-    </routes>
-    <testURLs>
-        <testURL>/resourcemanager/v1/cluster/info</testURL>
-        <testURL>/resourcemanager/v1/cluster/metrics</testURL>
-        <testURL>/resourcemanager/v1/cluster/apps</testURL>
-    </testURLs>
-</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0.1/rewrite.xml	2016-08-02 13:20:40.993812894 +0400
@@ -0,0 +1,193 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<rules>
+
+    <rule dir="IN" name="RESOURCEMANAGER/resourcemanager/inbound/root" pattern="*://*:*/**/resourcemanager/v1/?{**}">
+        <rewrite template="{$serviceUrl[RESOURCEMANAGER]}/v1/?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="RESOURCEMANAGER/resourcemanager/inbound/path" pattern="*://*:*/**/resourcemanager/v1/{path=**}?{**}">
+        <rewrite template="{$serviceUrl[RESOURCEMANAGER]}/v1/{path=**}/?{**}"/>
+    </rule>
+
+    <rule dir="IN" name="RESOURCEMANAGER/resourcemanager/inbound/proxy" pattern="*://*:*/**/resourcemanager/proxy/{appid=*}/ws/v1/{path=**}?{**}">
+        <decrypt-query/>
+        <match pattern="*://*:*/**/resourcemanager/proxy/{appid=*}/ws/v1/{path=**}?{scheme}?{host}?{port}?{**}"/>
+        <rewrite template="{scheme}://{host}:{port}/proxy/{appid=*}/ws/v1/{path=**}?{**}"/>
+    </rule>
+
+    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/url/outbound">
+        <match pattern="*://*:*/**?**"/>
+		<rewrite template=""/>
+    </rule>
+    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/trackingUrlHistory/outbound">
+        <match pattern="{scheme}://{host}:{port}/proxy/{appid=*}/jobhistory/job/**"/>
+		<rewrite template=""/>
+    </rule>
+    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/trackingUrlAM/outbound">
+        <match pattern="{scheme}://{host}:{port}/proxy/{appid=*}"/>
+		<rewrite template="{$frontend[url]}/resourcemanager/proxy/{appid=*}?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
+		<encrypt-query/>
+    </rule>
+    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/hostport/outbound">
+        <match pattern="*:*"/>
+		<rewrite template=""/>
+    </rule>
+    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/logsLink/outbound">
+        <match pattern="//*:*/**?**"/>
+		<rewrite template=""/>
+    </rule>
+    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/host/outbound">
+		<rewrite template=""/>
+    </rule>
+    <rule dir="OUT" name="RESOURCEMANAGER/resourcemanager/nodeId/outbound">
+        <match pattern="{host=*}:{port=*}"/>
+        <encrypt template="{host}:{port}" param="encaddr"/>
+        <rewrite template="{encaddr}"/>
+    </rule>
+    <rule dir="IN" name="RESOURCEMANAGER/resourcemanager/nodeId/inbound">
+        <match pattern="*://*:*/**/resourcemanager/v1/cluster/nodes/{addr=*}?{**}"/>
+        <decrypt param="addr"/>
+        <rewrite template="{$serviceUrl[RESOURCEMANAGER]}/v1/cluster/nodes/{addr}?{**}"/>
+    </rule>
+
+    <filter name="RESOURCEMANAGER/resourcemanager/apps/outbound">
+        <content type="*/json">
+        	<buffer path="$.apps.app[*]">
+        		<detect path="$.trackingUI" value="History">
+					<apply path="$.trackingUrl" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
+				</detect>
+				<detect path="$.trackingUI" value="ApplicationMaster">
+					<apply path="$.trackingUrl" rule="RESOURCEMANAGER/resourcemanager/trackingUrlAM/outbound"/>
+				</detect>
+				<apply path="$.amContainerLogs" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
+            	<apply path="$.amHostHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+        	</buffer>
+        </content>
+        <content type="*/xml">
+        	<buffer path="/apps/app">
+        		<detect path="trackingUI" value="History">
+					<apply path="trackingUrl" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
+				</detect>
+				<detect path="trackingUI" value="ApplicationMaster">
+					<apply path="trackingUrl" rule="RESOURCEMANAGER/resourcemanager/trackingUrlAM/outbound"/>
+				</detect>
+				<apply path="amContainerLogs" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
+            	<apply path="amHostHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+        	</buffer>
+        </content>
+    </filter>
+
+    <filter name="RESOURCEMANAGER/resourcemanager/app/outbound">
+        <content type="*/json">
+        	<buffer path="$.app">
+	       		<detect path="$.trackingUI" value="History">
+	       			<apply path="$.trackingUrl" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
+	       		</detect>
+	       		<detect path="$.trackingUI" value="ApplicationMaster">
+	       			<apply path="$.trackingUrl" rule="RESOURCEMANAGER/resourcemanager/trackingUrlAM/outbound"/>
+	       		</detect>
+	            <apply path="$.amContainerLogs" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
+	            <apply path="$.amHostHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+            </buffer>
+        </content>
+        <content type="*/xml">
+        	<buffer path="/app">
+	       		<detect path="trackingUI" value="History">
+	       			<apply path="trackingUrl" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
+	       		</detect>
+	       		<detect path="trackingUI" value="ApplicationMaster">
+	       			<apply path="trackingUrl" rule="RESOURCEMANAGER/resourcemanager/trackingUrlAM/outbound"/>
+	       		</detect>
+	            <apply path="amContainerLogs" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
+	            <apply path="amHostHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+            </buffer>
+        </content>
+    </filter>
+
+    <filter name="RESOURCEMANAGER/resourcemanager/appattempts/outbound">
+        <content type="*/json">
+            <apply path="$.appAttempts.appAttempt[*].nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+            <apply path="$.appAttempts.appAttempt[*].logsLink" rule="RESOURCEMANAGER/resourcemanager/logsLink/outbound"/>
+            <apply path="$.appAttempts.appAttempt[*].nodeId" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
+        </content>
+        <content type="*/xml">
+            <apply path="/appAttempts/appAttempt/nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+            <apply path="/appAttempts/appAttempt/logsLink" rule="RESOURCEMANAGER/resourcemanager/logsLink/outbound"/>
+            <apply path="/appAttempts/appAttempt/nodeId" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
+        </content>
+    </filter>
+
+    <filter name="RESOURCEMANAGER/resourcemanager/nodes/outbound">
+        <content type="*/json">
+            <apply path="$.nodes.node[*].nodeHTTPAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+            <apply path="$.nodes.node[*].nodeHostName" rule="RESOURCEMANAGER/resourcemanager/host/outbound"/>
+            <apply path="$.nodes.node[*].id" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
+        </content>
+        <content type="*/xml">
+            <apply path="/nodes/node/nodeHTTPAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+            <apply path="/nodes/node/nodeHostName" rule="RESOURCEMANAGER/resourcemanager/host/outbound"/>
+            <apply path="/nodes/node/id" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
+        </content>
+    </filter>
+
+    <filter name="RESOURCEMANAGER/resourcemanager/node/outbound">
+        <content type="*/json">
+            <apply path="$.node.nodeHTTPAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+            <apply path="$.node.nodeHostName" rule="RESOURCEMANAGER/resourcemanager/host/outbound"/>
+            <apply path="$.node.id" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
+        </content>
+        <content type="*/xml">
+            <apply path="/node/nodeHTTPAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+            <apply path="/node/nodeHostName" rule="RESOURCEMANAGER/resourcemanager/host/outbound"/>
+            <apply path="/node/id" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
+        </content>
+    </filter>
+
+    <filter name="RESOURCEMANAGER/resourcemanager/proxy/jobattempts/outbound">
+        <content type="*/json">
+            <apply path="$.jobAttempts.jobAttempt[*].nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+            <apply path="$.jobAttempts.jobAttempt[*].nodeId" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
+            <apply path="$.jobAttempts.jobAttempt[*].logsLink" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
+        </content>
+        <content type="*/xml">
+            <apply path="/jobAttempts/jobAttempt/nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+            <apply path="/jobAttempts/jobAttempt/nodeId" rule="RESOURCEMANAGER/resourcemanager/nodeId/outbound"/>
+            <apply path="/jobAttempts/jobAttempt/logsLink" rule="RESOURCEMANAGER/resourcemanager/url/outbound"/>
+        </content>
+    </filter>
+
+    <filter name="RESOURCEMANAGER/resourcemanager/proxy/taskattempts/outbound">
+        <content type="*/json">
+            <apply path="$.taskAttempts.taskAttempt[*].nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+        </content>
+        <content type="*/xml">
+            <apply path="/taskAttempts/taskAttempt/nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+        </content>
+    </filter>
+
+    <filter name="RESOURCEMANAGER/resourcemanager/proxy/taskattempt/outbound">
+        <content type="*/json">
+            <apply path="$.taskAttempt.nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+        </content>
+        <content type="*/xml">
+            <apply path="/taskAttempt/nodeHttpAddress" rule="RESOURCEMANAGER/resourcemanager/hostport/outbound"/>
+        </content>
+    </filter>
+
+</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-rm/2.5.0.1/service.xml	2016-08-02 13:20:40.994812917 +0400
@@ -0,0 +1,59 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="RESOURCEMANAGER" name="resourcemanager" version="2.5.0.1">
+    <routes>
+        <route path="/resourcemanager/v1/cluster/"/>
+        <route path="/resourcemanager/v1/cluster/**?**"/>
+        <route path="/resourcemanager/v1/cluster/apps?**">
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/apps/outbound" to="response.body"/>
+        </route>
+        <route path="/resourcemanager/v1/cluster/apps?**">
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/apps/outbound" to="response.body"/>
+        </route>
+        <route path="/resourcemanager/v1/cluster/apps/*?**">
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/app/outbound" to="response.body"/>
+        </route>
+        <route path="/resourcemanager/v1/cluster/apps/*/appattempts?**">
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/appattempts/outbound" to="response.body"/>
+        </route>
+        <route path="/resourcemanager/v1/cluster/nodes?**">
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/nodes/outbound" to="response.body"/>
+        </route>
+        <route path="/resourcemanager/v1/cluster/nodes/*?**">
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/nodeId/inbound" to="request.url"/>
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/node/outbound" to="response.body"/>
+        </route>
+        <route path="/resourcemanager/proxy/*/ws/v1/**?**">
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/inbound/proxy" to="request.url"/>
+        </route>
+        <route path="/resourcemanager/proxy/*/ws/v1/mapreduce/jobs/*/jobattempts">
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/proxy/jobattempts/outbound" to="response.body"/>
+        </route>
+        <route path="/resourcemanager/proxy/*/ws/v1/mapreduce/jobs/*/tasks/*/attempts">
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/proxy/taskattempts/outbound" to="response.body"/>
+        </route>
+        <route path="/resourcemanager/proxy/*/ws/v1/mapreduce/jobs/*/tasks/*/attempts/*">
+            <rewrite apply="RESOURCEMANAGER/resourcemanager/proxy/taskattempt/outbound" to="response.body"/>
+        </route>
+    </routes>
+    <testURLs>
+        <testURL>/resourcemanager/v1/cluster/info</testURL>
+        <testURL>/resourcemanager/v1/cluster/metrics</testURL>
+        <testURL>/resourcemanager/v1/cluster/apps</testURL>
+    </testURLs>
+</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarnui/2.7.0/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarnui/2.7.0/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarnui/2.7.0/rewrite.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarnui/2.7.0/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,176 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<rules>
-  <rule dir="IN" name="YARNUI/yarn/inbound/root" pattern="*://*:*/**/yarn/">
-    <rewrite template="{$serviceUrl[YARNUI]}/cluster"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/path" pattern="*://*:*/**/yarn/{**}">
-    <rewrite template="{$serviceUrl[YARNUI]}/cluster/{**}"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/cluster" pattern="*://*:*/**/yarn/cluster/{**}">
-    <rewrite template="{$serviceUrl[YARNUI]}/cluster/{**}"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/proxy" pattern="*://*:*/**/yarn/proxy/{**}">
-    <rewrite template="{$serviceUrl[YARNUI]}/proxy/{**}"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/static" pattern="*://*:*/**/yarn/static/{**}">
-    <rewrite template="{$serviceUrl[YARNUI]}/static/{**}"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/conf" pattern="*://*:*/**/yarn/conf">
-    <rewrite template="{$serviceUrl[YARNUI]}/conf"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/logs" pattern="*://*:*/**/yarn/logs">
-    <rewrite template="{$serviceUrl[YARNUI]}/logs"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/logs/files" pattern="*://*:*/**/yarn/logs/{**}">
-    <rewrite template="{$serviceUrl[YARNUI]}/logs/{**}"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/stacks" pattern="*://*:*/**/yarn/stacks">
-    <rewrite template="{$serviceUrl[YARNUI]}/stacks"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/metrics" pattern="*://*:*/**/yarn/metrics">
-    <rewrite template="{$serviceUrl[YARNUI]}/metrics"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/jmx" pattern="*://*:*/**/yarn/jmx">
-    <rewrite template="{$serviceUrl[YARNUI]}/jmx"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/jmx/query" pattern="*://*:*/**/yarn/jmx?{**}">
-    <rewrite template="{$serviceUrl[YARNUI]}/jmx?{**}"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/node" pattern="*://*:*/**/yarn/node/{**}">
-    <rewrite template="{$serviceUrl[YARNUI]}/node/{**}"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/nodemanager/home" pattern="*://*:*/**/yarn/nodemanager?{host}?{port}">
-    <rewrite template="{$serviceScheme[YARNUI]}://{host}:{port}/node"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/resourcemanager/home" pattern="*://*:*/**/yarn/resourcemanager?{scheme}?{host}?{port}">
-    <rewrite template="{scheme}://{host}:{port}/cluster"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/node/containerlogs" pattern="*://*:*/**/yarn/nodemanager/node/containerlogs/{**}?{host}?{port}">
-    <rewrite template="{$serviceScheme[YARNUI]}://{host}:{port}/node/containerlogs/{**}"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/logs" pattern="*://*:*/**/yarn/logs?{scheme}?{host}?{port}?{**}">
-    <rewrite template="{scheme}://{host}:{port}/logs/?{**}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/headers/logs/location">
-    <match pattern="{scheme}://{host}:{port}/logs/?{**}"/>
-    <rewrite template="{$frontend[url]}/yarn/logs?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/logs/files" pattern="/logs/{**}">
-    <rewrite template="{$frontend[url]}/yarn/logs/{**}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/static" pattern="/static/{**}">
-    <rewrite template="{$frontend[url]}/yarn/static/{**}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/cluster" pattern="/cluster/{**}">
-    <rewrite template="{$frontend[url]}/yarn/{**}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/conf" pattern="/conf">
-    <rewrite template="{$frontend[url]}/yarn/conf"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/logs" pattern="/logs">
-    <rewrite template="{$frontend[url]}/yarn/logs"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/stacks" pattern="/stacks">
-    <rewrite template="{$frontend[url]}/yarn/stacks"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/metrics" pattern="/metrics">
-    <rewrite template="{$frontend[url]}/yarn/metrics"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/jmx" pattern="/jmx?{**}">
-    <rewrite template="{$frontend[url]}/yarn/jmx?{**}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/node" pattern="/node/{**}">
-    <rewrite template="{$frontend[url]}/yarn/node/{**}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/cluster/app" pattern="*://*:*/cluster/app/{**}">
-    <rewrite template="{$frontend[url]}/yarn/cluster/app/{**}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/apps/app">
-    <rewrite template="{$frontend[url]}/yarn/cluster/app"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/cluster/container">
-    <rewrite template="{$frontend[url]}/yarn/cluster/container"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/apps/history">
-    <match pattern="*://*:*/proxy/{**}"/>
-    <rewrite template="{$frontend[url]}/yarn/proxy/{**}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/node/containerlogs">
-    <match pattern="//{host}:{port}/node/containerlogs/{**}"/>
-    <rewrite template="{$frontend[url]}/yarn/nodemanager/node/containerlogs/{**}?host={$hostmap(host)}?{port}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/node/containerlogs2" pattern="{scheme}://{host}:{port}/node/containerlogs/{**}?{**}">
-    <rewrite template="{$frontend[url]}/yarn/nodemanager/node/containerlogs/{**}?{**}?{scheme}?host={$hostmap(host)}?{port}"/>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/proxy" pattern="*://*:*/proxy/{**}">
-    <rewrite template="{$frontend[url]}/yarn/proxy/{**}"/>
-  </rule>
-  <rule flow="OR" dir="OUT" name="YARNUI/yarn/outbound/headers/jobhistory/job/location">
-    <match pattern="{scheme}://{host}:{port}/jobhistory/job/{**}">
-      <rewrite template="{$frontend[url]}/yarn/jobhistory/job/{**}?{scheme}?{host}?{port}"/>
-    </match>
-    <match pattern="{scheme}://{host}:{port}/history/{**}?{**}">
-      <rewrite template="{$frontend[url]}/yarn/history/{**}?{**}?{scheme}?{host}?{port}"/>
-    </match>
-    <match pattern="*://*:*/cluster/app/{**}">
-      <rewrite template="{$frontend[url]}/yarn/cluster/app/{**}"/>
-    </match>
-  </rule>
-  <rule dir="OUT" name="YARNUI/yarn/outbound/headers/sparkhistory/job/location">
-    <match pattern="*://*:*/history/{**}/jobs"/>
-      <rewrite template="{$frontend[url]}/sparkhistory/history/{**}/jobs"/>
-  </rule>
-
-  <rule dir="IN" name="YARNUI/yarn/inbound/jobhistory/job" pattern="*://*:*/**/yarn/jobhistory/job/{**}?{scheme}?{host}?{port}">
-    <rewrite template="{scheme}://{host}:{port}/jobhistory/job/{**}"/>
-  </rule>
-  <rule dir="IN" name="YARNUI/yarn/inbound/sparkhistory/job" pattern="*://*:*/**/yarn/history/{**}?{**}?{scheme}?{host}?{port}">
-    <rewrite template="{scheme}://{host}:{port}/history/{**}?{**}"/>
-  </rule>
-
-  <filter name="YARNUI/yarn/outbound/headers/logs">
-    <content type="application/x-http-headers">
-      <apply path="Location" rule="YARNUI/yarn/outbound/headers/logs/location"/>
-    </content>
-  </filter>
-  <filter name="YARNUI/yarn/outbound/headers/jobhistory/job">
-    <content type="application/x-http-headers">
-      <apply path="Location" rule="YARNUI/yarn/outbound/headers/jobhistory/job/location"/>
-    </content>
-  </filter>
-  <filter name="YARNUI/yarn/outbound/headers/sparkhistory/job">
-    <content type="application/x-http-headers">
-      <apply path="Location" rule="YARNUI/yarn/outbound/headers/sparkhistory/job/location"/>
-    </content>
-  </filter>
-  <filter name="YARNUI/yarn/outbound/configuration">
-    <content type="*/xml">
-      <buffer path="/configuration/property"/>
-    </content>
-  </filter>
-  <filter name="YARNUI/yarn/outbound/apps">
-    <content type="*/html">
-      <apply path="https?://[^/':,]+:[\d]+/proxy/[^']*" rule="YARNUI/yarn/outbound/apps/history"/>
-      <apply path="//[^/':,]+:[\d]+/node/containerlogs/container[^']*" rule="YARNUI/yarn/outbound/node/containerlogs"/>
-      <apply path="(https?://[^/':,]+:[\d]+)?/cluster/app" rule="YARNUI/yarn/outbound/apps/app"/>
-      <apply path="/cluster/container" rule="YARNUI/yarn/outbound/cluster/container"/>
-    </content>
-  </filter>
-
-</rules>
\ No newline at end of file
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarnui/2.7.0/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarnui/2.7.0/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarnui/2.7.0/service.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarnui/2.7.0/service.xml	1970-01-01 04:00:00.000000000 +0400
@@ -1,42 +0,0 @@
-<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
-<!--
-   Licensed to the Apache Software Foundation (ASF) under one or more
-   contributor license agreements.  See the NOTICE file distributed with
-   this work for additional information regarding copyright ownership.
-   The ASF licenses this file to You under the Apache License, Version 2.0
-   (the "License"); you may not use this file except in compliance with
-   the License.  You may obtain a copy of the License at
-
-       http://www.apache.org/licenses/LICENSE-2.0
-
-   Unless required by applicable law or agreed to in writing, software
-   distributed under the License is distributed on an "AS IS" BASIS,
-   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-   See the License for the specific language governing permissions and
-   limitations under the License.
--->
-<service role="YARNUI" name="yarn" version="2.7.0">
-    <routes>
-        <route path="/yarn/">
-            <rewrite apply="YARNUI/yarn/outbound/apps" to="response.body"/>
-        </route>
-        <route path="/yarn/**">
-            <rewrite apply="YARNUI/yarn/outbound/apps" to="response.body"/>
-        </route>
-        <route path="/yarn/**?**">
-            <rewrite apply="YARNUI/yarn/outbound/apps" to="response.body"/>
-        </route>
-        <route path="/yarn/logs?**">
-            <rewrite apply="YARNUI/yarn/outbound/headers/logs" to="response.headers"/>
-        </route>
-        <route path="/yarn/conf">
-            <rewrite apply="YARNUI/yarn/outbound/configuration" to="response.body"/>
-        </route>
-        <route path="/yarn/proxy/**">
-            <rewrite apply="YARNUI/yarn/outbound/headers/jobhistory/job" to="response.headers"/>
-        </route>
-        <route path="/yarn/history/**?**">
-            <rewrite apply="YARNUI/yarn/outbound/headers/sparkhistory/job" to="response.headers"/>
-        </route>
-    </routes>
-</service>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-ui/2.7.2.1/rewrite.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-ui/2.7.2.1/rewrite.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-ui/2.7.2.1/rewrite.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-ui/2.7.2.1/rewrite.xml	2016-08-02 13:20:40.989812800 +0400
@@ -0,0 +1,295 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+Licensed to the Apache Software Foundation (ASF) under one or more
+contributor license agreements.  See the NOTICE file distributed with
+this work for additional information regarding copyright ownership.
+The ASF licenses this file to You under the Apache License, Version 2.0
+(the "License"); you may not use this file except in compliance with
+the License.  You may obtain a copy of the License at
+
+http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+-->
+<rules>
+<!-- Inbound rules -->
+<!-- Resource manager routing in rules -->
+<!-- 
+     {$frontend[url] is used through the rewrite and is it equivalent to {$serviceUrl[YARNUI]},  this the endpoint url for the service.
+     e.g. http://host.com:8088
+-->
+
+<rule dir="IN" name="YARNUI/yarn/inbound/ws" pattern="*://*:*/**/yarn/ws/v1/cluster/apps/{**}">
+    <rewrite template="{$serviceUrl[YARNUI]}/ws/v1/cluster/apps/{**}"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/root" pattern="*://*:*/**/yarn/">
+    <rewrite template="{$serviceUrl[YARNUI]}/cluster"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/path" pattern="*://*:*/**/yarn/{**}">
+     <rewrite template="{$serviceUrl[YARNUI]}/cluster/{**}"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/cluster" pattern="*://*:*/**/yarn/cluster/{**}">
+    <rewrite template="{$serviceUrl[YARNUI]}/cluster/{**}"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/proxy" pattern="*://*:*/**/yarn/proxy/{**}">
+    <rewrite template="{$serviceUrl[YARNUI]}/proxy/{**}"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/static" pattern="*://*:*/**/yarn/static/{**}">
+    <rewrite template="{$serviceUrl[YARNUI]}/static/{**}"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/conf" pattern="*://*:*/**/yarn/conf">
+    <rewrite template="{$serviceUrl[YARNUI]}/conf"/>
+</rule>
+<!-- Resource manager configuration inbound routing -->
+<rule dir="IN" name="YARNUI/yarn/inbound/logs" pattern="*://*:*/**/yarn/logs">
+    <rewrite template="{$serviceUrl[YARNUI]}/logs"/>
+</rule>
+<!-- Yarn local logs inbound routing -->
+<rule dir="IN" name="YARNUI/yarn/inbound/logs/files" pattern="*://*:*/**/yarn/logs/{**}">
+    <rewrite template="{$serviceUrl[YARNUI]}/logs/{**}"/>
+</rule>
+<!-- Yarn Thread Server stacks inbound routing -->
+<rule dir="IN" name="YARNUI/yarn/inbound/stacks" pattern="*://*:*/**/yarn/stacks">
+    <rewrite template="{$serviceUrl[YARNUI]}/stacks"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/metrics" pattern="*://*:*/**/yarn/metrics">
+    <rewrite template="{$serviceUrl[YARNUI]}/metrics"/>
+</rule>
+<!-- Yarn Resource Manager server Metrics JMX inbound routing -->
+<rule dir="IN" name="YARNUI/yarn/inbound/jmx" pattern="*://*:*/**/yarn/jmx">
+    <rewrite template="{$serviceUrl[YARNUI]}/jmx"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/jmx/query" pattern="*://*:*/**/yarn/jmx?{**}">
+    <rewrite template="{$serviceUrl[YARNUI]}/jmx?{**}"/>
+</rule>
+<!-- Yarn nodemanager inbound routing -->
+<rule dir="IN" name="YARNUI/yarn/inbound/node" pattern="*://*:*/**/yarn/node/{**}">
+    <rewrite template="{$serviceUrl[YARNUI]}/yarn/node/{**}"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/node/query" pattern="*://*:*/**/yarn/node/{**}?{**}">
+    <rewrite template="{$serviceUrl[YARNUI]}/yarn/node/{**}?{**}"/>
+</rule>
+<!-- inbound route to  Node Manager page -->
+<rule dir="IN" name="YARNUI/yarn/inbound/nodemanager/node2" pattern="*://*:*/**/yarn/nodemanager/node?{scheme}?{host}?{port}">
+    <rewrite template="{scheme}://{host}:{port}/node"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/nodemanager/containerlogs/container" pattern="*://*:*/**/yarn/nodemanager/node/containerlogs/{**}?{scheme}?{host}?{port}">
+    <rewrite template="{scheme}://{host}:{port}/node/containerlogs/{**}"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/resourcemanager/home" pattern="*://*:*/**/yarn/resourcemanager?{scheme}?{host}?{port}">
+    <rewrite template="{scheme}://{host}:{port}/cluster"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/logs" pattern="*://*:*/**/yarn/logs?{scheme}?{host}?{port}?{**}">
+    <rewrite template="{scheme}://{host}:{port}/logs/?{**}"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/jobhistory/job" pattern="*://*:*/**/yarn/jobhistory/job/{**}?{scheme}?{host}?{port}">
+    <rewrite template="{scheme}://{host}:{port}/jobhistory/job/{**}"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/sparkhistory/job" pattern="*://*:*/**/yarn/history/{**}?{**}?{scheme}?{host}?{port}">
+    <rewrite template="{scheme}://{host}:{port}/history/{**}?{**}"/>
+</rule>
+<rule dir="IN" name="YARNUI/yarn/inbound/jobhistory/params" pattern="*://*:*/**/jobstory/jobhistory/{**}?{**}">
+    <rewrite template="{$serviceUrl[JOBSTORYUI]}/jobhistory/{**}?{**}"/>
+</rule>
+<!--
+  This rewrites a META refresh in web page so it will re-direct to jobstory.
+-->
+<!--
+<rule dir="OUT" name="YARNUI/yarn/outbound/node/allApplications" pattern="/node/allApplications">
+    <rewrite template="{$frontend[url]}/yarn/nodemanager/node/node/allApplications?{scheme}?host={$hostmap(host)}?{port}"/>
+</rule>
+-->
+<rule dir="OUT" name="YARNUI/yarn/inbound/jobhistory/logs" pattern="*1; url=*://*:*/jobhistory/logs/{**}">
+    <rewrite template="1; url=/gateway/jobstoryui/jobstory/jobhistory/logs/{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/headers/logs/location">
+    <match pattern="{scheme}://{host}:{port}/logs/?{**}"/>
+    <rewrite template="{$frontend[url]}/yarn/logs?{scheme}?host={$hostmap(host)}?{port}?{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/logs/files" pattern="/logs/{**}">
+    <rewrite template="{$frontend[url]}/yarn/logs/{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/static" pattern="/static/{**}">
+    <rewrite template="{$frontend[url]}/yarn/static/{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/cluster" pattern="/cluster/{**}">
+    <rewrite template="{$frontend[url]}/yarn/{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/conf" pattern="/conf">
+    <rewrite template="{$frontend[url]}/yarn/conf"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/logs" pattern="/logs">
+    <rewrite template="{$frontend[url]}/yarn/logs"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/stacks" pattern="/stacks">
+    <rewrite template="{$frontend[url]}/yarn/stacks"/>
+</rule>
+    <rule dir="OUT" name="YARNUI/yarn/outbound/metrics" pattern="/metrics">
+    <rewrite template="{$frontend[url]}/yarn/metrics"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/jmx" pattern="/jmx?{**}">
+    <rewrite template="{$frontend[url]}/yarn/jmx?{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/node" pattern="/node/{**}">
+    <rewrite template="{$frontend[url]}/yarn/node/{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/cluster/app" pattern="*://*:*/cluster/app/{**}">
+    <rewrite template="{$frontend[url]}/yarn/cluster/app/{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/apps/app">
+    <rewrite template="{$frontend[url]}/yarn/cluster/app"/>
+</rule>
+
+<rule dir="OUT" name="YARNUI/yarn/outbound/proxy" pattern="*://*:*/proxy/{**}">
+    <rewrite template="{$frontend[url]}/yarn/proxy/{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/jobhistory/params" pattern="/jobhistory/{**}?{**}">
+    <rewrite template="/gateway/jobstoryui/jobstory/jobhistory/{**}?{**}"/>
+</rule>
+<rule flow="OR" dir="OUT" name="YARNUI/yarn/outbound/headers/jobhistory/job/location">
+    <match pattern="{scheme}://{host}:{port}/jobhistory/job/{**}">
+        <rewrite template="{$frontend[url]}/yarn/jobhistory/job/{**}?{scheme}?{host}?{port}"/>
+    </match>
+    <match pattern="{scheme}://{host}:{port}/history/{**}?{**}">
+        <rewrite template="{$frontend[url]}/yarn/history/{**}?{**}?{scheme}?{host}?{port}"/>
+    </match>
+    <match pattern="*://*:*/cluster/app/{**}">
+        <rewrite template="{$frontend[url]}/yarn/cluster/app/{**}"/>
+    </match>
+    <match pattern="*://*:*/cluster/apps/{**}">
+        <rewrite template="{$frontend[url]}/yarn/cluster/apps/{**}"/>
+    </match>
+    <match pattern="*://*:*/cluster/apps">
+        <rewrite template="{$frontend[url]}/yarn/cluster/apps"/>
+    </match>
+    <match pattern="*://*:*/cluster">
+        <rewrite template="{$frontend[url]}/yarn/cluster"/>
+    </match>
+
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/headers/sparkhistory/job/location">
+    <match pattern="*://*:*/history/{**}/jobs"/>
+    <rewrite template="{$frontend[url]}/sparkhistory/history/{**}/jobs"/>
+</rule>
+
+<!-- These rules are used for redirection case (302) to  rewrite Location  header. -->
+<filter name="YARNUI/yarn/outbound/headers/logs">
+    <content type="application/x-http-headers">
+    <apply path="Location" rule="YARNUI/yarn/outbound/headers/logs/location"/>
+</content>
+</filter>
+<filter name="YARNUI/yarn/outbound/headers/jobhistory/job">
+    <content type="application/x-http-headers">
+        <apply path="Location" rule="YARNUI/yarn/outbound/headers/jobhistory/job/location"/>
+    </content>
+</filter>
+<filter name="YARNUI/yarn/outbound/headers/sparkhistory/job">
+    <content type="application/x-http-headers">
+        <apply path="Location" rule="YARNUI/yarn/outbound/headers/sparkhistory/job/location"/>
+    </content>
+</filter>
+
+<!-- rewrites XML content from configuration link -->
+<filter name="YARNUI/yarn/outbound/configuration">
+    <content type="*/xml">
+        <buffer path="/configuration/property"/>
+    </content>
+</filter>
+
+<!-- rewrite html content of application page htmp/embedded js  --> 
+<filter name="YARNUI/yarn/outbound/apps">
+    <content type="*/html">
+        <apply path="(https?://[^/':,]+:[\d]+)?/proxy/[^']*" rule="YARNUI/yarn/outbound/apps/history"/>
+        <apply path="(https?:)?//[^/':,]+:[\d]+/node/containerlogs/container(_[^/':,]+)+/[^/':,]+" rule="YARNUI/yarn/outbound/node/containerlogs"/>
+        <apply path="(https?://[^/':,]+:[\d]+)?/cluster/app" rule="YARNUI/yarn/outbound/apps/app"/>
+        <apply path="/cluster/container" rule="YARNUI/yarn/outbound/cluster/container"/>
+    </content>
+</filter>
+<filter name="YARNUI/yarn/outbound/apps1">
+    <content type="*/html">
+        <apply path="/proxy/[^']*" rule="YARNUI/yarn/outbound/apps/history1"/>
+    </content>
+</filter>
+<filter name="YARNUI/yarn/outbound/filter/cluster">
+    <content type="*/html">
+        <apply path="(https?://[^/':,]+:[\d]+)?/ws/v1/cluster/apps/application" rule="YARNUI/yarn/outbound/apps/cluster1"/>
+        <apply path="/cluster/app/application" rule="YARNUI/yarn/outbound/cluster/app/application"/>
+        <apply path="/cluster/appatt" rule="YARNUI/yarn/outbound/apps/appatt"/>
+        <apply path="(https?:)?//[^/':,]+:[\d]+/node/containerlogs/container(_[^/':,]+)+/[^/':,]+" rule="YARNUI/yarn/outbound/node/containerlogs"/>
+        <apply path="/cluster/container" rule="YARNUI/yarn/outbound/cluster/container"/>
+        <apply path="https?://[^/':,]+:[\d][^']*" rule="YARNUI/yarn/outbound/node2"/>
+    </content>
+</filter>
+<filter name="YARNUI/yarn/outbound/filter/nodes">
+    <content type="*/html">
+        <apply path="(?!http:)//[^/':,]+:[\d]+" rule="YARNUI/yarn/outbound/node3"/>
+    </content>
+</filter>
+
+<rule dir="OUT" name="YARNUI/yarn/outbound/apps/app">
+    <rewrite template="{$frontend[url]}/yarn/cluster/app"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/apps/appatt">
+    <rewrite template="{$frontend[url]}/yarn/cluster/appatt"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/apps/cluster1">
+    <rewrite template="{$frontend[url]}/yarn/ws/v1/cluster/apps/application"/>
+</rule>
+
+<rule dir="OUT" name="YARNUI/yarn/outbound/cluster/app/application">
+    <rewrite template="{$frontend[url]}/yarn/cluster/app/application"/>
+</rule>
+
+<rule dir="OUT" name="YARNUI/yarn/outbound/apps/history">
+    <match pattern="*://*:*/proxy/{**}"/>
+    <rewrite template="{$frontend[url]}/yarn/proxy/{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/apps/history1">
+    <match pattern="/proxy/{**}"/>
+    <rewrite template="{$frontend[url]}/yarn/proxy/{**}"/>
+</rule>
+
+<rule dir="OUT" name="YARNUI/yarn/outbound/cluster/container">
+    <rewrite template="{$frontend[url]}/yarn/cluster/container"/>
+</rule>
+<!-- Yarn application containerlog outbound routing -->
+<!--
+     This is the reference to the log button on application page
+Rule changes 
+href='//${yarn.nodemanager}:{yarn.nodemanager.port}/node/containerlogs/container_xxx/user' into'
+https://knox_host:knox_port/gateway/yarnui/yarn/nodemanager/node/containerlogs/container_XXX/user?host=${yarn.nodemanager.host}&port=${yarn.nodemanager.port}
+
+This is match by inbound "YARNUI/yarn/inbound/jobhistory/logs" rewrite which is a client content rewrite
+by adding META refresh. So we need to rewrite META refresh to jobstory. 
+-->
+<rule dir="OUT" name="YARNUI/yarn/outbound/node/containerlogs">
+    <match pattern="{scheme}://{host}:{port}/node/containerlogs/{**}"/>
+    <rewrite template="{$frontend[url]}/yarn/nodemanager/node/containerlogs/{**}?{scheme}?host={$hostmap(host)}?{port}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/node2">
+    <match pattern="{scheme}://{host}:{port}"/>
+    <rewrite template="{gateway.scheme}://{gateway.host}:{gateway.port}/gateway/nodemanagerui/node?host={host}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/node3">
+    <match pattern="//{host}:{port}"/>
+    <rewrite template="{gateway.scheme}://{gateway.host}:{gateway.port}/gateway/nodemanagerui/node?host={host}?port={port}"/>
+</rule>
+
+
+<rule dir="OUT" name="YARNUI/yarn/outbound/node/containerlogs2"> 
+    <match pattern="{scheme}://{host}:{port}/node/containerlogs/{**}?{**}"/>
+</rule>
+<rule dir="OUT" name="YARNUI/yarn/outbound/proxy1" pattern="/proxy/{**}">
+    <rewrite template="{$frontend[url]}/yarn/proxy/{**}"/>
+</rule>
+
+<rule dir="OUT" name="YARNUI/yarn/outbound/cluster1" pattern="*://*:*/cluster/{**}">
+    <rewrite template="{$frontend[url]}/yarn/cluster/{**}"/>
+</rule>
+
+
+</rules>
diff -uNr knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-ui/2.7.2.1/service.xml knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-ui/2.7.2.1/service.xml
--- knox-0.7.0-a/gateway-service-definitions/src/main/resources/services/yarn-ui/2.7.2.1/service.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-definitions/src/main/resources/services/yarn-ui/2.7.2.1/service.xml	2016-08-02 13:20:40.990812823 +0400
@@ -0,0 +1,63 @@
+<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+       http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<service role="YARNUI" name="yarn" version="2.7.2.1">
+    <routes>
+        <route path="/yarn/ws/**">
+            <rewrite apply="YARNUI/yarn/inbound/ws" to="request.url"/>
+            <dispatch contributor-name="http-client" />
+        </route>
+        <route path="/yarn/proxy/**">
+            <rewrite apply="YARNUI/yarn/outbound/headers/jobhistory/job" to="response.headers"/>
+            <rewrite apply="YARNUI/yarn/outbound/apps1" to="response.body"/>
+        </route>
+
+        <route path="/yarn/cluster/**">
+            <rewrite apply="YARNUI/yarn/outbound/headers/jobhistory/job" to="response.headers"/>
+            <rewrite apply="YARNUI/yarn/outbound/filter/cluster" to="response.body"/>
+        </route>
+
+        <route path="/yarn/nodes/**">
+            <rewrite apply="YARNUI/yarn/outbound/headers/jobhistory/job" to="response.headers"/>
+            <rewrite apply="YARNUI/yarn/outbound/filter/nodes" to="response.body"/>
+        </route>
+
+        <route path="/yarn/">
+            <rewrite apply="YARNUI/yarn/outbound/apps" to="response.body"/>
+            <rewrite apply="YARNUI/yarn/outbound/headers/jobhistory/job" to="response.headers"/>
+        </route>
+        <route path="/yarn/**">
+            <rewrite apply="YARNUI/yarn/outbound/apps" to="response.body"/>
+            <rewrite apply="YARNUI/yarn/outbound/headers/jobhistory/job" to="response.headers"/>
+        </route>
+        <route path="/yarn/**?**">
+            <rewrite apply="YARNUI/yarn/outbound/apps" to="response.body"/>
+            <rewrite apply="YARNUI/yarn/outbound/headers/jobhistory/job" to="response.headers"/>
+        </route>
+        <route path="/yarn/logs?**">
+            <rewrite apply="YARNUI/yarn/outbound/headers/logs" to="response.headers"/>
+        </route>
+        <route path="/yarn/conf">
+            <rewrite apply="YARNUI/yarn/outbound/configuration" to="response.body"/>
+        </route>
+        <route path="/yarn/history/**?**">
+            <rewrite apply="YARNUI/yarn/outbound/headers/sparkhistory/job" to="response.headers"/>
+        </route>
+    </routes>
+    <dispatch classname="org.apache.hadoop.gateway.rm.dispatch.RMUIHttpClientDispatch" ha-classname="org.apache.hadoop.gateway.rm.dispatch.RMUIHaDispatch"/>
+
+</service>
diff -uNr knox-0.7.0-a/gateway-service-rm/pom.xml knox-0.7.0-b/gateway-service-rm/pom.xml
--- knox-0.7.0-a/gateway-service-rm/pom.xml	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/pom.xml	2016-08-02 13:20:41.336820910 +0400
@@ -0,0 +1,81 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+  Licensed to the Apache Software Foundation (ASF) under one or more
+  contributor license agreements.  See the NOTICE file distributed with
+  this work for additional information regarding copyright ownership.
+  The ASF licenses this file to You under the Apache License, Version 2.0
+  (the "License"); you may not use this file except in compliance with
+  the License.  You may obtain a copy of the License at
+
+      http://www.apache.org/licenses/LICENSE-2.0
+
+  Unless required by applicable law or agreed to in writing, software
+  distributed under the License is distributed on an "AS IS" BASIS,
+  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+  See the License for the specific language governing permissions and
+  limitations under the License.
+-->
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
+    <modelVersion>4.0.0</modelVersion>
+    <parent>
+        <groupId>org.apache.knox</groupId>
+        <artifactId>gateway</artifactId>
+        <version>0.7.0</version>
+    </parent>
+    <artifactId>gateway-service-rm</artifactId>
+
+    <name>gateway-service-rm</name>
+    <description>The extension to the gateway for supporting RM.</description>
+
+    <licenses>
+        <license>
+            <name>The Apache Software License, Version 2.0</name>
+            <url>http://www.apache.org/licenses/LICENSE-2.0.txt</url>
+            <distribution>repo</distribution>
+        </license>
+    </licenses>
+
+    <dependencies>
+        <dependency>
+            <groupId>${gateway-group}</groupId>
+            <artifactId>gateway-spi</artifactId>
+        </dependency>
+        <dependency>
+            <groupId>${gateway-group}</groupId>
+            <artifactId>gateway-provider-rewrite</artifactId>
+        </dependency>
+        <dependency>
+            <groupId>${gateway-group}</groupId>
+            <artifactId>gateway-provider-ha</artifactId>
+        </dependency>
+
+        <dependency>
+            <groupId>junit</groupId>
+            <artifactId>junit</artifactId>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>${gateway-group}</groupId>
+            <artifactId>gateway-test-utils</artifactId>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.easymock</groupId>
+            <artifactId>easymock</artifactId>
+            <scope>test</scope>
+        </dependency>
+
+        <dependency>
+            <groupId>org.hamcrest</groupId>
+            <artifactId>hamcrest-core</artifactId>
+            <scope>test</scope>
+        </dependency>
+        <dependency>
+            <groupId>org.hamcrest</groupId>
+            <artifactId>hamcrest-library</artifactId>
+            <scope>test</scope>
+        </dependency>
+
+    </dependencies>
+
+</project>
diff -uNr knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMDispatch.java knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMDispatch.java
--- knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMDispatch.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMDispatch.java	2016-08-02 13:20:41.335820886 +0400
@@ -0,0 +1,35 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.dispatch;
+
+import org.apache.hadoop.gateway.dispatch.GatewayDispatchFilter;
+
+import javax.servlet.FilterConfig;
+import javax.servlet.ServletException;
+
+/***
+ */
+@Deprecated
+public class RMDispatch extends GatewayDispatchFilter {
+
+  @Override
+  public void init(FilterConfig filterConfig) throws ServletException {
+    setDispatch(new RMHttpClientDispatch());
+    super.init(filterConfig);
+  }
+}
diff -uNr knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHaDispatch.java knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHaDispatch.java
--- knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHaDispatch.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHaDispatch.java	2016-08-02 13:20:41.333820840 +0400
@@ -0,0 +1,196 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ * <p/>
+ * http://www.apache.org/licenses/LICENSE-2.0
+ * <p/>
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.dispatch;
+
+import org.apache.hadoop.gateway.config.Configure;
+import org.apache.hadoop.gateway.filter.AbstractGatewayFilter;
+import org.apache.hadoop.gateway.ha.provider.HaProvider;
+import org.apache.hadoop.gateway.ha.provider.HaServiceConfig;
+import org.apache.hadoop.gateway.ha.provider.impl.HaServiceConfigConstants;
+import org.apache.hadoop.gateway.rm.i18n.RMMessages;
+import org.apache.hadoop.gateway.i18n.messages.MessagesFactory;
+import org.apache.http.HttpResponse;
+import org.apache.http.client.methods.HttpRequestBase;
+import org.apache.http.client.methods.HttpUriRequest;
+import org.apache.http.entity.BufferedHttpEntity;
+
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.ByteArrayOutputStream;
+import java.io.IOException;
+import java.net.URI;
+import java.util.concurrent.atomic.AtomicInteger;
+
+public class RMHaDispatch extends RMHttpClientDispatch {
+
+  private static final String FAILOVER_COUNTER_ATTRIBUTE = "dispatch.ha.failover.counter";
+
+   private static final String RETRY_COUNTER_ATTRIBUTE = "dispatch.ha.retry.counter";
+
+   public static final String RESOURCE_ROLE = "RESOURCEMANAGER";
+
+   private static final RMMessages LOG = MessagesFactory.get(RMMessages.class);
+
+   private int maxFailoverAttempts = HaServiceConfigConstants.DEFAULT_MAX_FAILOVER_ATTEMPTS;
+
+   private int failoverSleep = HaServiceConfigConstants.DEFAULT_FAILOVER_SLEEP;
+
+   private int maxRetryAttempts = HaServiceConfigConstants.DEFAULT_MAX_RETRY_ATTEMPTS;
+
+   private int retrySleep = HaServiceConfigConstants.DEFAULT_RETRY_SLEEP;
+
+   private HaProvider haProvider;
+
+   /**
+   * @throws javax.servlet.ServletException
+   */
+  public RMHaDispatch() throws ServletException {
+    super();
+  }
+
+   @Override
+   public void init() {
+     super.init();
+     if (haProvider != null) {
+       HaServiceConfig serviceConfig = haProvider.getHaDescriptor().getServiceConfig(RESOURCE_ROLE);
+       maxFailoverAttempts = serviceConfig.getMaxFailoverAttempts();
+       failoverSleep = serviceConfig.getFailoverSleep();
+       maxRetryAttempts = serviceConfig.getMaxRetryAttempts();
+       retrySleep = serviceConfig.getRetrySleep();
+     }
+   }
+
+  public HaProvider getHaProvider() {
+    return haProvider;
+  }
+
+  @Configure
+  public void setHaProvider(HaProvider haProvider) {
+    this.haProvider = haProvider;
+  }
+
+  @Override
+   protected void executeRequest(HttpUriRequest outboundRequest, HttpServletRequest inboundRequest, HttpServletResponse outboundResponse) throws IOException {
+      HttpResponse inboundResponse = null;
+      try {
+         inboundResponse = executeOutboundRequest(outboundRequest);
+         writeOutboundResponse(outboundRequest, inboundRequest, outboundResponse, inboundResponse);
+      } catch (StandbyException e) {
+         LOG.errorReceivedFromStandbyNode(e);
+         failoverRequest(outboundRequest, inboundRequest, outboundResponse, inboundResponse, e);
+      } catch (SafeModeException e) {
+         LOG.errorReceivedFromSafeModeNode(e);
+         retryRequest(outboundRequest, inboundRequest, outboundResponse, inboundResponse, e);
+      } catch (IOException e) {
+         LOG.errorConnectingToServer(outboundRequest.getURI().toString(), e);
+         failoverRequest(outboundRequest, inboundRequest, outboundResponse, inboundResponse, e);
+      }
+   }
+
+   /**
+    * Checks for specific outbound response codes/content to trigger a retry or failover
+    */
+   @Override
+   protected void writeOutboundResponse(HttpUriRequest outboundRequest, HttpServletRequest inboundRequest, HttpServletResponse outboundResponse, HttpResponse inboundResponse) throws IOException {
+      int status = inboundResponse.getStatusLine().getStatusCode();
+      if ( status  == 403 || status == 307) {
+         BufferedHttpEntity entity = new BufferedHttpEntity(inboundResponse.getEntity());
+         inboundResponse.setEntity(entity);
+         ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
+         inboundResponse.getEntity().writeTo(outputStream);
+         String body = new String(outputStream.toByteArray());
+         if (body.contains("This is standby RM")) {
+            throw new StandbyException();
+         }
+         if (body.contains("SafeModeException") || body.contains("RetriableException")) {
+            throw new SafeModeException();
+         }
+      }
+      super.writeOutboundResponse(outboundRequest, inboundRequest, outboundResponse, inboundResponse);
+   }
+
+   private void failoverRequest(HttpUriRequest outboundRequest, HttpServletRequest inboundRequest, HttpServletResponse outboundResponse, HttpResponse inboundResponse, Exception exception) throws IOException {
+      LOG.failingOverRequest(outboundRequest.getURI().toString());
+      AtomicInteger counter = (AtomicInteger) inboundRequest.getAttribute(FAILOVER_COUNTER_ATTRIBUTE);
+      if (counter == null) {
+         counter = new AtomicInteger(0);
+      }
+      inboundRequest.setAttribute(FAILOVER_COUNTER_ATTRIBUTE, counter);
+      if (counter.incrementAndGet() <= maxFailoverAttempts) {
+         haProvider.markFailedURL(RESOURCE_ROLE, outboundRequest.getURI().toString());
+         //null out target url so that rewriters run again
+         inboundRequest.setAttribute(AbstractGatewayFilter.TARGET_REQUEST_URL_ATTRIBUTE_NAME, null);
+         URI uri = getDispatchUrl(inboundRequest);
+         ((HttpRequestBase) outboundRequest).setURI(uri);
+         if (failoverSleep > 0) {
+            try {
+               Thread.sleep(failoverSleep);
+            } catch (InterruptedException e) {
+               LOG.failoverSleepFailed(RESOURCE_ROLE, e);
+            }
+         }
+         executeRequest(outboundRequest, inboundRequest, outboundResponse);
+      } else {
+         LOG.maxFailoverAttemptsReached(maxFailoverAttempts, RESOURCE_ROLE);
+         if (inboundResponse != null) {
+            writeOutboundResponse(outboundRequest, inboundRequest, outboundResponse, inboundResponse);
+         } else {
+            throw new IOException(exception);
+         }
+      }
+   }
+
+   private void retryRequest(HttpUriRequest outboundRequest, HttpServletRequest inboundRequest, HttpServletResponse outboundResponse, HttpResponse inboundResponse, Exception exception) throws IOException {
+      LOG.retryingRequest(outboundRequest.getURI().toString());
+      AtomicInteger counter = (AtomicInteger) inboundRequest.getAttribute(RETRY_COUNTER_ATTRIBUTE);
+      if (counter == null) {
+         counter = new AtomicInteger(0);
+      }
+      inboundRequest.setAttribute(RETRY_COUNTER_ATTRIBUTE, counter);
+      if (counter.incrementAndGet() <= maxRetryAttempts) {
+         if (retrySleep > 0) {
+            try {
+               Thread.sleep(retrySleep);
+            } catch (InterruptedException e) {
+               LOG.retrySleepFailed(RESOURCE_ROLE, e);
+            }
+         }
+         executeRequest(outboundRequest, inboundRequest, outboundResponse);
+      } else {
+         LOG.maxRetryAttemptsReached(maxRetryAttempts, RESOURCE_ROLE, outboundRequest.getURI().toString());
+         if (inboundResponse != null) {
+            writeOutboundResponse(outboundRequest, inboundRequest, outboundResponse, inboundResponse);
+         } else {
+            throw new IOException(exception);
+         }
+      }
+   }
+
+  private static URI getDispatchUrl(HttpServletRequest request) {
+    StringBuffer str = request.getRequestURL();
+    String query = request.getQueryString();
+    if ( query != null ) {
+      str.append('?');
+      str.append(query);
+    }
+    URI url = URI.create(str.toString());
+    return url;
+  }
+
+}
diff -uNr knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHaHttpClientDispatch.java knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHaHttpClientDispatch.java
--- knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHaHttpClientDispatch.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHaHttpClientDispatch.java	2016-08-02 13:20:41.334820863 +0400
@@ -0,0 +1,36 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ * <p/>
+ * http://www.apache.org/licenses/LICENSE-2.0
+ * <p/>
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.dispatch;
+
+import org.apache.hadoop.gateway.dispatch.GatewayDispatchFilter;
+
+import javax.servlet.FilterConfig;
+import javax.servlet.ServletException;
+
+
+/***
+ */
+@Deprecated
+public class RMHaHttpClientDispatch extends GatewayDispatchFilter {
+
+  @Override
+  public void init(FilterConfig filterConfig) throws ServletException {
+    setDispatch(new RMHaDispatch());
+    super.init(filterConfig);
+  }
+}
diff -uNr knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHttpClientDispatch.java knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHttpClientDispatch.java
--- knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHttpClientDispatch.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMHttpClientDispatch.java	2016-08-02 13:20:41.333820840 +0400
@@ -0,0 +1,45 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.dispatch;
+
+import org.apache.hadoop.gateway.dispatch.DefaultDispatch;
+import org.apache.http.HttpEntity;
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
+import java.io.IOException;
+
+public class RMHttpClientDispatch extends DefaultDispatch {
+
+  public RMHttpClientDispatch() throws ServletException {
+    super();
+  }
+
+  //@Override
+  /**
+   * This method ensures that the request InputStream is not acquired
+   * prior to a dispatch to a component such as a namenode that doesn't
+   * the request body. The side effect of this is that the client does
+   * not get a 100 continue from Knox which will trigger the client to
+   * send the entire payload before redirect to the target component
+   * like a datanode and have to send it again.
+   */
+  protected HttpEntity createRequestEntity(HttpServletRequest request)
+      throws IOException {
+    return null;
+  }
+}
diff -uNr knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHaDispatch.java knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHaDispatch.java
--- knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHaDispatch.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHaDispatch.java	2016-08-02 13:20:41.334820863 +0400
@@ -0,0 +1,196 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ * <p/>
+ * http://www.apache.org/licenses/LICENSE-2.0
+ * <p/>
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.dispatch;
+
+import org.apache.hadoop.gateway.config.Configure;
+import org.apache.hadoop.gateway.filter.AbstractGatewayFilter;
+import org.apache.hadoop.gateway.ha.provider.HaProvider;
+import org.apache.hadoop.gateway.ha.provider.HaServiceConfig;
+import org.apache.hadoop.gateway.ha.provider.impl.HaServiceConfigConstants;
+import org.apache.hadoop.gateway.rm.i18n.RMMessages;
+import org.apache.hadoop.gateway.i18n.messages.MessagesFactory;
+import org.apache.http.HttpResponse;
+import org.apache.http.client.methods.HttpRequestBase;
+import org.apache.http.client.methods.HttpUriRequest;
+import org.apache.http.entity.BufferedHttpEntity;
+
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.ByteArrayOutputStream;
+import java.io.IOException;
+import java.net.URI;
+import java.util.concurrent.atomic.AtomicInteger;
+
+public class RMUIHaDispatch extends RMUIHttpClientDispatch {
+
+  private static final String FAILOVER_COUNTER_ATTRIBUTE = "dispatch.ha.failover.counter";
+
+   private static final String RETRY_COUNTER_ATTRIBUTE = "dispatch.ha.retry.counter";
+
+   public static final String RESOURCE_ROLE = "YARNUI";
+
+   private static final RMMessages LOG = MessagesFactory.get(RMMessages.class);
+
+   private int maxFailoverAttempts = HaServiceConfigConstants.DEFAULT_MAX_FAILOVER_ATTEMPTS;
+
+   private int failoverSleep = HaServiceConfigConstants.DEFAULT_FAILOVER_SLEEP;
+
+   private int maxRetryAttempts = HaServiceConfigConstants.DEFAULT_MAX_RETRY_ATTEMPTS;
+
+   private int retrySleep = HaServiceConfigConstants.DEFAULT_RETRY_SLEEP;
+
+   private HaProvider haProvider;
+
+   /**
+   * @throws javax.servlet.ServletException
+   */
+  public RMUIHaDispatch() throws ServletException {
+    super();
+  }
+
+   @Override
+   public void init() {
+     super.init();
+     if (haProvider != null) {
+       HaServiceConfig serviceConfig = haProvider.getHaDescriptor().getServiceConfig(RESOURCE_ROLE);
+       maxFailoverAttempts = serviceConfig.getMaxFailoverAttempts();
+       failoverSleep = serviceConfig.getFailoverSleep();
+       maxRetryAttempts = serviceConfig.getMaxRetryAttempts();
+       retrySleep = serviceConfig.getRetrySleep();
+     }
+   }
+
+  public HaProvider getHaProvider() {
+    return haProvider;
+  }
+
+  @Configure
+  public void setHaProvider(HaProvider haProvider) {
+    this.haProvider = haProvider;
+  }
+
+  @Override
+   protected void executeRequest(HttpUriRequest outboundRequest, HttpServletRequest inboundRequest, HttpServletResponse outboundResponse) throws IOException {
+      HttpResponse inboundResponse = null;
+      try {
+         inboundResponse = executeOutboundRequest(outboundRequest);
+         writeOutboundResponse(outboundRequest, inboundRequest, outboundResponse, inboundResponse);
+      } catch (StandbyException e) {
+         LOG.errorReceivedFromStandbyNode(e);
+         failoverRequest(outboundRequest, inboundRequest, outboundResponse, inboundResponse, e);
+      } catch (SafeModeException e) {
+         LOG.errorReceivedFromSafeModeNode(e);
+         retryRequest(outboundRequest, inboundRequest, outboundResponse, inboundResponse, e);
+      } catch (IOException e) {
+         LOG.errorConnectingToServer(outboundRequest.getURI().toString(), e);
+         failoverRequest(outboundRequest, inboundRequest, outboundResponse, inboundResponse, e);
+      }
+   }
+
+   /**
+    * Checks for specific outbound response codes/content to trigger a retry or failover
+    */
+   @Override
+   protected void writeOutboundResponse(HttpUriRequest outboundRequest, HttpServletRequest inboundRequest, HttpServletResponse outboundResponse, HttpResponse inboundResponse) throws IOException {
+       int status = inboundResponse.getStatusLine().getStatusCode();
+      if ( status  == 403 || status == 307) {
+         BufferedHttpEntity entity = new BufferedHttpEntity(inboundResponse.getEntity());
+         inboundResponse.setEntity(entity);
+         ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
+         inboundResponse.getEntity().writeTo(outputStream);
+         String body = new String(outputStream.toByteArray());
+         if (body.contains("This is standby RM")) {
+            throw new StandbyException();
+         }
+         if (body.contains("SafeModeException") || body.contains("RetriableException")) {
+            throw new SafeModeException();
+         }
+      }
+      super.writeOutboundResponse(outboundRequest, inboundRequest, outboundResponse, inboundResponse);
+   }
+
+   private void failoverRequest(HttpUriRequest outboundRequest, HttpServletRequest inboundRequest, HttpServletResponse outboundResponse, HttpResponse inboundResponse, Exception exception) throws IOException {
+      LOG.failingOverRequest(outboundRequest.getURI().toString());
+      AtomicInteger counter = (AtomicInteger) inboundRequest.getAttribute(FAILOVER_COUNTER_ATTRIBUTE);
+      if (counter == null) {
+         counter = new AtomicInteger(0);
+      }
+      inboundRequest.setAttribute(FAILOVER_COUNTER_ATTRIBUTE, counter);
+      if (counter.incrementAndGet() <= maxFailoverAttempts) {
+         haProvider.markFailedURL(RESOURCE_ROLE, outboundRequest.getURI().toString());
+         //null out target url so that rewriters run again
+         inboundRequest.setAttribute(AbstractGatewayFilter.TARGET_REQUEST_URL_ATTRIBUTE_NAME, null);
+         URI uri = getDispatchUrl(inboundRequest);
+         ((HttpRequestBase) outboundRequest).setURI(uri);
+         if (failoverSleep > 0) {
+            try {
+               Thread.sleep(failoverSleep);
+            } catch (InterruptedException e) {
+               LOG.failoverSleepFailed(RESOURCE_ROLE, e);
+            }
+         }
+         executeRequest(outboundRequest, inboundRequest, outboundResponse);
+      } else {
+         LOG.maxFailoverAttemptsReached(maxFailoverAttempts, RESOURCE_ROLE);
+         if (inboundResponse != null) {
+            writeOutboundResponse(outboundRequest, inboundRequest, outboundResponse, inboundResponse);
+         } else {
+            throw new IOException(exception);
+         }
+      }
+   }
+
+   private void retryRequest(HttpUriRequest outboundRequest, HttpServletRequest inboundRequest, HttpServletResponse outboundResponse, HttpResponse inboundResponse, Exception exception) throws IOException {
+      LOG.retryingRequest(outboundRequest.getURI().toString());
+      AtomicInteger counter = (AtomicInteger) inboundRequest.getAttribute(RETRY_COUNTER_ATTRIBUTE);
+      if (counter == null) {
+         counter = new AtomicInteger(0);
+      }
+      inboundRequest.setAttribute(RETRY_COUNTER_ATTRIBUTE, counter);
+      if (counter.incrementAndGet() <= maxRetryAttempts) {
+         if (retrySleep > 0) {
+            try {
+               Thread.sleep(retrySleep);
+            } catch (InterruptedException e) {
+               LOG.retrySleepFailed(RESOURCE_ROLE, e);
+            }
+         }
+         executeRequest(outboundRequest, inboundRequest, outboundResponse);
+      } else {
+         LOG.maxRetryAttemptsReached(maxRetryAttempts, RESOURCE_ROLE, outboundRequest.getURI().toString());
+         if (inboundResponse != null) {
+            writeOutboundResponse(outboundRequest, inboundRequest, outboundResponse, inboundResponse);
+         } else {
+            throw new IOException(exception);
+         }
+      }
+   }
+
+  private static URI getDispatchUrl(HttpServletRequest request) {
+    StringBuffer str = request.getRequestURL();
+    String query = request.getQueryString();
+    if ( query != null ) {
+      str.append('?');
+      str.append(query);
+    }
+    URI url = URI.create(str.toString());
+    return url;
+  }
+
+}
diff -uNr knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHaHttpClientDispatch.java knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHaHttpClientDispatch.java
--- knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHaHttpClientDispatch.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHaHttpClientDispatch.java	2016-08-02 13:20:41.334820863 +0400
@@ -0,0 +1,33 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ * <p/>
+ * http://www.apache.org/licenses/LICENSE-2.0
+ * <p/>
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.dispatch;
+
+import org.apache.hadoop.gateway.dispatch.GatewayDispatchFilter;
+
+import javax.servlet.FilterConfig;
+import javax.servlet.ServletException;
+
+
+public class RMUIHaHttpClientDispatch extends GatewayDispatchFilter {
+
+  @Override
+  public void init(FilterConfig filterConfig) throws ServletException {
+    setDispatch(new RMUIHaDispatch());
+    super.init(filterConfig);
+  }
+}
diff -uNr knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHttpClientDispatch.java knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHttpClientDispatch.java
--- knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHttpClientDispatch.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/RMUIHttpClientDispatch.java	2016-08-02 13:20:41.333820840 +0400
@@ -0,0 +1,45 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.dispatch;
+
+import org.apache.hadoop.gateway.dispatch.DefaultDispatch;
+import org.apache.http.HttpEntity;
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
+import java.io.IOException;
+
+public class RMUIHttpClientDispatch extends DefaultDispatch {
+
+  public RMUIHttpClientDispatch() throws ServletException {
+    super();
+  }
+
+  //@Override
+  /**
+   * This method ensures that the request InputStream is not acquired
+   * prior to a dispatch to a component such as a namenode that doesn't
+   * the request body. The side effect of this is that the client does
+   * not get a 100 continue from Knox which will trigger the client to
+   * send the entire payload before redirect to the target component
+   * like a datanode and have to send it again.
+   */
+  protected HttpEntity createRequestEntity(HttpServletRequest request)
+      throws IOException {
+    return null;
+  }
+}
diff -uNr knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/SafeModeException.java knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/SafeModeException.java
--- knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/SafeModeException.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/SafeModeException.java	2016-08-02 13:20:41.334820863 +0400
@@ -0,0 +1,21 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ * <p/>
+ * http://www.apache.org/licenses/LICENSE-2.0
+ * <p/>
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.dispatch;
+
+public class SafeModeException extends RuntimeException {
+}
diff -uNr knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/StandbyException.java knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/StandbyException.java
--- knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/StandbyException.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/dispatch/StandbyException.java	2016-08-02 13:20:41.335820886 +0400
@@ -0,0 +1,21 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ * <p/>
+ * http://www.apache.org/licenses/LICENSE-2.0
+ * <p/>
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.dispatch;
+
+public class StandbyException extends RuntimeException {
+}
diff -uNr knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/i18n/RMMessages.java knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/i18n/RMMessages.java
--- knox-0.7.0-a/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/i18n/RMMessages.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/main/java/org/apache/hadoop/gateway/rm/i18n/RMMessages.java	2016-08-02 13:20:41.332820817 +0400
@@ -0,0 +1,43 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.i18n;
+
+import org.apache.hadoop.gateway.ha.dispatch.i18n.HaDispatchMessages;
+import org.apache.hadoop.gateway.i18n.messages.Message;
+import org.apache.hadoop.gateway.i18n.messages.MessageLevel;
+import org.apache.hadoop.gateway.i18n.messages.Messages;
+import org.apache.hadoop.gateway.i18n.messages.StackTrace;
+
+@Messages(logger = "org.apache.hadoop.gateway")
+public interface RMMessages extends HaDispatchMessages {
+
+  @Message(level = MessageLevel.INFO, text = "Received an error from a node in Standby: {0}")
+   void errorReceivedFromStandbyNode(@StackTrace(level = MessageLevel.DEBUG) Exception e);
+
+  @Message(level = MessageLevel.INFO, text = "Received an error from a node in SafeMode: {0}")
+   void errorReceivedFromSafeModeNode(@StackTrace(level = MessageLevel.DEBUG) Exception e);
+
+  @Message(level = MessageLevel.INFO, text = "Retrying request to a server: {0}")
+   void retryingRequest(String uri);
+
+  @Message(level = MessageLevel.INFO, text = "Maximum attempts {0} to retry reached for service: {1} at url : {2}")
+   void maxRetryAttemptsReached(int attempts, String service, String url);
+
+  @Message(level = MessageLevel.INFO, text = "Error occurred while trying to sleep for retry : {0} {1}")
+   void retrySleepFailed(String service, @StackTrace(level = MessageLevel.DEBUG) Exception e);
+}
diff -uNr knox-0.7.0-a/gateway-service-rm/src/test/java/org/apache/hadoop/gateway/rm/dispatch/RMHaDispatchTest.java knox-0.7.0-b/gateway-service-rm/src/test/java/org/apache/hadoop/gateway/rm/dispatch/RMHaDispatchTest.java
--- knox-0.7.0-a/gateway-service-rm/src/test/java/org/apache/hadoop/gateway/rm/dispatch/RMHaDispatchTest.java	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-service-rm/src/test/java/org/apache/hadoop/gateway/rm/dispatch/RMHaDispatchTest.java	2016-08-02 13:20:41.335820886 +0400
@@ -0,0 +1,105 @@
+/**
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.hadoop.gateway.rm.dispatch;
+
+import org.apache.hadoop.gateway.ha.provider.HaDescriptor;
+import org.apache.hadoop.gateway.ha.provider.HaProvider;
+import org.apache.hadoop.gateway.ha.provider.HaServletContextListener;
+import org.apache.hadoop.gateway.ha.provider.impl.DefaultHaProvider;
+import org.apache.hadoop.gateway.ha.provider.impl.HaDescriptorFactory;
+import org.apache.http.client.methods.HttpRequestBase;
+import org.apache.http.client.methods.HttpUriRequest;
+import org.apache.http.impl.client.DefaultHttpClient;
+import org.apache.http.params.BasicHttpParams;
+import org.easymock.EasyMock;
+import org.easymock.IAnswer;
+import org.junit.Assert;
+import org.junit.Test;
+
+import javax.servlet.FilterConfig;
+import javax.servlet.ServletContext;
+import javax.servlet.ServletOutputStream;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+import java.io.IOException;
+import java.net.URI;
+import java.util.ArrayList;
+import java.util.concurrent.atomic.AtomicInteger;
+
+public class RMHaDispatchTest {
+
+   @Test
+   public void testConnectivityFailover() throws Exception {
+      String serviceName = "RESOURCEMANAGER";
+      HaDescriptor descriptor = HaDescriptorFactory.createDescriptor();
+      descriptor.addServiceConfig(HaDescriptorFactory.createServiceConfig(serviceName, "true", "1", "1000", "2", "1000", null, null));
+      HaProvider provider = new DefaultHaProvider(descriptor);
+      URI uri1 = new URI( "http://unreachable-host" );
+      URI uri2 = new URI( "http://reachable-host" );
+      ArrayList<String> urlList = new ArrayList<String>();
+      urlList.add(uri1.toString());
+      urlList.add(uri2.toString());
+      provider.addHaService(serviceName, urlList);
+      FilterConfig filterConfig = EasyMock.createNiceMock(FilterConfig.class);
+      ServletContext servletContext = EasyMock.createNiceMock(ServletContext.class);
+
+      EasyMock.expect(filterConfig.getServletContext()).andReturn(servletContext).anyTimes();
+      EasyMock.expect(servletContext.getAttribute(HaServletContextListener.PROVIDER_ATTRIBUTE_NAME)).andReturn(provider).anyTimes();
+
+      BasicHttpParams params = new BasicHttpParams();
+
+      HttpUriRequest outboundRequest = EasyMock.createNiceMock(HttpRequestBase.class);
+      EasyMock.expect(outboundRequest.getMethod()).andReturn( "GET" ).anyTimes();
+      EasyMock.expect(outboundRequest.getURI()).andReturn( uri1  ).anyTimes();
+      EasyMock.expect(outboundRequest.getParams()).andReturn( params ).anyTimes();
+
+      HttpServletRequest inboundRequest = EasyMock.createNiceMock(HttpServletRequest.class);
+      EasyMock.expect(inboundRequest.getRequestURL()).andReturn( new StringBuffer(uri2.toString()) ).once();
+      EasyMock.expect(inboundRequest.getAttribute("dispatch.ha.failover.counter")).andReturn(new AtomicInteger(0)).once();
+      EasyMock.expect(inboundRequest.getAttribute("dispatch.ha.failover.counter")).andReturn(new AtomicInteger(1)).once();
+
+      HttpServletResponse outboundResponse = EasyMock.createNiceMock(HttpServletResponse.class);
+      EasyMock.expect(outboundResponse.getOutputStream()).andAnswer( new IAnswer<ServletOutputStream>() {
+         @Override
+         public ServletOutputStream answer() throws Throwable {
+            return new ServletOutputStream() {
+               @Override
+               public void write( int b ) throws IOException {
+                  throw new IOException( "unreachable-host" );
+               }
+            };
+         }
+      }).once();
+      EasyMock.replay(filterConfig, servletContext, outboundRequest, inboundRequest, outboundResponse);
+      Assert.assertEquals(uri1.toString(), provider.getActiveURL(serviceName));
+      RMHaDispatch dispatch = new RMHaDispatch();
+      dispatch.setHttpClient(new DefaultHttpClient());
+      dispatch.setHaProvider(provider);
+      dispatch.init();
+      long startTime = System.currentTimeMillis();
+      try {
+         dispatch.executeRequest(outboundRequest, inboundRequest, outboundResponse);
+      } catch (IOException e) {
+        //this is expected after the failover limit is reached
+      }
+      long elapsedTime = System.currentTimeMillis() - startTime;
+      Assert.assertEquals(uri2.toString(), provider.getActiveURL(serviceName));
+      //test to make sure the sleep took place
+      Assert.assertTrue(elapsedTime > 1000);
+   }
+}
diff -uNr knox-0.7.0-a/gateway-test-iop-solr/src/test/resources/document.json knox-0.7.0-b/gateway-test-iop-solr/src/test/resources/document.json
--- knox-0.7.0-a/gateway-test-iop-solr/src/test/resources/document.json	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-test-iop-solr/src/test/resources/document.json	2016-08-02 13:20:40.919811163 +0400
@@ -0,0 +1 @@
+{"id" : "book1", "title_t" : "The Way of Kings", "author_s" : "Brandon Sanderson" }
diff -uNr knox-0.7.0-a/gateway-test-iop-solr/src/test/resources/query.json knox-0.7.0-b/gateway-test-iop-solr/src/test/resources/query.json
--- knox-0.7.0-a/gateway-test-iop-solr/src/test/resources/query.json	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-test-iop-solr/src/test/resources/query.json	2016-08-02 13:20:40.920811187 +0400
@@ -0,0 +1,4 @@
+{
+  "query" : "title_t:black",
+  "fields" : ["title_t", "author_s"]
+}
diff -uNr knox-0.7.0-a/gateway-test-iop-solr/src/test/resources/sort.txt knox-0.7.0-b/gateway-test-iop-solr/src/test/resources/sort.txt
--- knox-0.7.0-a/gateway-test-iop-solr/src/test/resources/sort.txt	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-test-iop-solr/src/test/resources/sort.txt	2016-08-02 13:20:40.916811094 +0400
@@ -0,0 +1,5 @@
+q=*:*&
+fq=publisher_s:Bantam&
+rows=3&
+sort=pubyear_i desc&
+fl=title_t,pubyear_i
diff -uNr knox-0.7.0-a/gateway-test-iop-solr/src/test/resources/testSolr.sh knox-0.7.0-b/gateway-test-iop-solr/src/test/resources/testSolr.sh
--- knox-0.7.0-a/gateway-test-iop-solr/src/test/resources/testSolr.sh	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-test-iop-solr/src/test/resources/testSolr.sh	2016-08-02 13:20:40.915811071 +0400
@@ -0,0 +1,219 @@
+#!/bin/sh
+##########################################################################
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#-------------------------------------------------------------
+# ============================================================
+# Usage: sh testSolr.sh knox_host_name knox_port 
+# Current: 
+# REQUIREMENT to run test.
+# Run "solr create -c demo" to create demo collection. This
+# needs to be run from solr server.
+#
+# ============================================================
+
+#
+#  Tests Solr API through Knox
+#
+#
+#
+#
+
+ServerName=$1
+portNumber=$2
+
+if [ -z "$ServerName" ]; then
+  echo "Usage: sh testSolr.sh knox_host_name knox_port."
+  echo "Please Enter Knox server full qualified hostname."
+  exit
+fi
+if [ -z "$portNumber" ]; then
+  echo "Usage: sh testSolr.sh knox_host_name knox_port."
+  echo "Please Enter Knox port."
+  exit
+fi
+
+
+
+
+getSessionId() {
+    callREST=$1
+    session_id=`echo "${callREST}" | grep JSESSIONID`
+    session_id=${session_id#Set-Cookie:}
+    t2=`expr index "$session_id" ";"`
+    session_id=${session_id:0:$t2-1}
+    #echo "JSESSIONID= ${session_id}"
+    echo  "$session_id"
+}
+
+ServerName=${ServerName}:${portNumber}
+username=guest
+password=guest-password
+default_deployment=default
+default_paths=gateway/${default_deployment}
+protocol=https
+#protocol=http
+
+
+SERVER_URL=${protocol}://${ServerName}/
+#
+#Test access to IOP admin REST services using BASIC authentication
+#
+
+echo "Test SOLR through knox..."
+
+#
+# Calling SOLR through knox
+#
+
+#
+# Run "solr create -c demo" to create demo collection.
+#
+
+collectionName=demo
+content="Content-Type:text/json"
+
+SOLR_API_GET_SCHEMA=/solr/${collectionName}/schema?wt=xml
+SOLR_API_ADD_DOCUMENT=/solr/${collectionName}/update
+SOLR_API_RETRIEVE_DOCUMENT=/solr/${collectionName}/get?id=book1
+SOLR_API_UPDATE_DOCUMENT=/solr/${collectionName}/update
+SOLR_API_QUERY="/solr/${collectionName}/query?q=title_t:black&fl=author_s,title_t"
+SOLR_API_QUERY_JSON="/solr/${collectionName}/query"
+SOLR_API_PAGING_SEARCH="/solr/${collectionName}/query"
+
+
+
+echo "Test SOLR  Get Schems status through Knox..." 
+echo "curl -k  --basic  --user $username:$password -X GET -L  -i ${SERVER_URL}${default_paths}${SOLR_API_GET_SCHEMA}"
+callREST=`curl -k  -D basictest1.txt --basic  --user $username:$password -X GET  -L  -i ${SERVER_URL}${default_paths}${SOLR_API_GET_SCHEMA}`
+
+
+if echo "$callREST" | grep -q "HTTP/1.1 200 OK" ; then
+   echo $callREST
+   echo "PASS SOLR GET SCHEMA REST TEST"
+else
+   echo "FAILED SOLR  GET SCHEMA REST TEST"
+fi
+
+echo "Test SOLR  Add document through Knox..." 
+echo "curl -k  --basic  --user $username:$password -X GET -L  -i ${SERVER_URL}${default_paths}${SOLR_API_ADD_DOCUMENT} -d  @document.json -H ${content}"
+callREST=`curl -k  -D basictest1.txt --basic  --user $username:$password -X GET  -L  -i ${SERVER_URL}${default_paths}${SOLR_API_ADD_DOCUMENT} -d @document.json -H ${content}`
+
+
+if echo "$callREST" | grep -q "HTTP/1.1 200 OK" ; then
+   echo $callREST
+   echo "PASS SOLR ADD DOCUMENT REST TEST"
+else
+   echo "FAILED SOLR ADD DOCUMENT REST TEST"
+fi
+
+echo "Test SOLR  retrieving document through Knox..." 
+echo "curl -k  --basic  --user $username:$password -X GET -L  -i ${SERVER_URL}${default_paths}${SOLR_API_RETRIEVE_DOCUMENT}"
+callREST=`curl -k  -D basictest1.txt --basic  --user $username:$password -X GET  -L  -i ${SERVER_URL}${default_paths}${SOLR_API_RETRIEVE_DOCUMENT}`
+
+
+if echo "$callREST" | grep -q "HTTP/1.1 200 OK" ; then
+   echo $callREST
+   echo "PASS REST RETRIEVING DOCUMENT TEST"
+else
+   echo "FAILED REST RETRIEVING DOCUMENT TEST"
+fi
+
+echo "Test SOLR  updating a  document through Knox..." 
+echo "curl -k  --basic  --user $username:$password -X GET -L  -i ${SERVER_URL}${default_paths}${SOLR_API_UPDATE_DOCUMENT} -d  @document.json -H ${content}"
+callREST=`curl -k  -D basictest1.txt --basic  --user $username:$password -X GET  -L  -i ${SERVER_URL}${default_paths}${SOLR_API_UPDATE_DOCUMENT} -d @document.json -H ${content}`
+
+if echo "$callREST" | grep -q "HTTP/1.1 200 OK" ; then
+   echo $callREST
+   echo "PASS REST AUTHENTICATION TEST"
+else
+   echo "FAILED REST AUTHENTICATION TEST"
+fi
+
+
+echo "Test SOLR  Query document through Knox..." 
+echo "curl -k  --basic  --user $username:$password -X GET -L  -i ${SERVER_URL}${default_paths}${SOLR_API_QUERY}"
+callREST=`curl -k  -D basictest1.txt --basic  --user $username:$password -X GET  -L  -i ${SERVER_URL}${default_paths}${SOLR_API_QUERY}`
+
+
+if echo "$callREST" | grep -q "HTTP/1.1 200 OK" ; then
+   echo $callREST
+   echo "PASS REST SOLR QUERY TEST"
+else
+   echo "FAILED REST SOLR QUERY TEST"
+fi
+
+echo "Test SOLR  QUERY document using JSON"
+
+echo "curl -k  --basic  --user $username:$password -X GET -L  -i ${SERVER_URL}${default_paths}${SOLR_API_QUERY_JSON} -d  @query.json "
+callREST=`curl -k  -D basictest1.txt --basic  --user $username:$password -X GET  -L  -i ${SERVER_URL}${default_paths}${SOLR_API_QUERY_JSON} -d @query.json `
+
+if echo "$callREST" | grep -q "HTTP/1.1 200 OK" ; then
+   echo $callREST
+   echo "PASS REST SOLR QUERYIN with JSON  TEST"
+else
+   echo "FAILED REST SOLR RETRIEVING with JSON TEST"
+fi
+
+echo "Test SOLR Sorting and Paging Search Results "
+
+echo "curl -k  --basic  --user $username:$password -X GET -L  -i ${SERVER_URL}${default_paths}${SOLR_API_PAGING_SEARCH} -d  @sort.json "
+callREST=`curl -k  -D basictest1.txt --basic  --user $username:$password -X GET  -L  -i ${SERVER_URL}${default_paths}${SOLR_API_PAGING_SEARCH} -d @sort.txt `
+
+if echo "$callREST" | grep -q "HTTP/1.1 200 OK" ; then
+   echo $callREST
+   echo "PASS REST SOLR SORTING/PAGING TEST"
+else
+   echo "FAILED REST SOLR SORTING/PAGING TEST"
+fi
+
+echo "Test SOLR Negative test. Test is expected to fail. Wrong Content type "
+
+echo "curl -k  --basic  --user $username:$password -X POST -L  -i ${SERVER_URL}${default_paths}${SOLR_API_PAGING_SEARCH} -d  @sort.json -H 'Content-Type:text/xml' "
+callREST=`curl -k  -D basictest1.txt --basic  --user $username:$password -X POST  -L  -i ${SERVER_URL}${default_paths}${SOLR_API_PAGING_SEARCH} -d @sort.txt -H 'Content-Type:text/xml'`
+
+if echo "$callREST" | grep -q "HTTP/1.1 200 OK" ; then
+   echo $callREST
+   echo "FAILED REST SOLR NEGATIVE TEST"
+else
+   echo "PASS REST SOLR NEGATIVE TEST"
+fi
+
+echo "Test SOLR Negative test. Test is expected to fail. Wrong Authentication credentials "
+
+echo "curl -k  --basic  --user foo:foo-password -X GET -L  -i ${SERVER_URL}${default_paths}${SOLR_API_PAGING_SEARCH} -d  @sort.json  "
+callREST=`curl -k  -D basictest1.txt --basic  --user foo:foo-password -X GET  -L  -i ${SERVER_URL}${default_paths}${SOLR_API_PAGING_SEARCH} -d @sort.txt `
+
+if echo "$callREST" | grep -q "HTTP/1.1 200 OK" ; then
+   echo $callREST
+   echo "FAILED REST SOLR NEGATIVE TEST"
+else
+   echo "PASS REST SOLR NEGATIVE TEST"
+fi
+
+echo "Test SOLR Negative test. Test is expected to fail. Wrong hostname "
+
+echo "curl -k  --basic  --user foo:foo-password -X GET -L  -i http://foo.com/${default_paths}${SOLR_API_PAGING_SEARCH} -d  @sort.json  "
+callREST=`curl -k  -D basictest1.txt --basic  --user foo:foo-password -X GET  -L  -i htto://foo.com/${default_paths}${SOLR_API_PAGING_SEARCH} -d @sort.txt `
+
+if echo "$callREST" | grep -q "HTTP/1.1 200 OK" ; then
+   echo $callREST
+   echo "FAILED REST SOLR NEGATIVE TEST"
+else
+   echo "PASS REST SOLR NEGATIVE TEST"
+fi
+
+
diff -uNr knox-0.7.0-a/gateway-test-iop-solr/src/test/resources/update.json knox-0.7.0-b/gateway-test-iop-solr/src/test/resources/update.json
--- knox-0.7.0-a/gateway-test-iop-solr/src/test/resources/update.json	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/gateway-test-iop-solr/src/test/resources/update.json	2016-08-02 13:20:40.918811140 +0400
@@ -0,0 +1,5 @@
+{"id"         : "book1",
+  "cat_s"      : { "add" : "fantasy" },
+  "pubyear_i"  : { "add" : 2010 },
+  "ISBN_s"     : { "add" : "978-0-7653-2635-5" }
+ }
diff -uNr knox-0.7.0-a/gateway-test-ldap/pom.xml knox-0.7.0-b/gateway-test-ldap/pom.xml
--- knox-0.7.0-a/gateway-test-ldap/pom.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-test-ldap/pom.xml	2016-08-02 13:20:40.943811727 +0400
@@ -71,8 +69,7 @@
                         <version>2.0</version>
                         <configuration>
                             <transformers>
-                                <transformer
-                                        implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
+                                <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                                     <manifestEntries>
                                         <Main-Class>org.apache.hadoop.gateway.security.EmbeddedApacheDirectoryServer
                                         </Main-Class>
diff -uNr knox-0.7.0-a/gateway-util-common/src/main/java/org/apache/hadoop/gateway/util/HttpUtils.java knox-0.7.0-b/gateway-util-common/src/main/java/org/apache/hadoop/gateway/util/HttpUtils.java
--- knox-0.7.0-a/gateway-util-common/src/main/java/org/apache/hadoop/gateway/util/HttpUtils.java	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/gateway-util-common/src/main/java/org/apache/hadoop/gateway/util/HttpUtils.java	2016-08-02 13:20:41.125815978 +0400
@@ -20,6 +20,7 @@
 import java.io.UnsupportedEncodingException;
 import java.net.URLDecoder;
 import java.util.Arrays;
+import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.Map;
 import java.util.StringTokenizer;
@@ -71,6 +72,63 @@
     }
     return map;
   }
+  public static Map<String, String[]> parseQueryString2(String queryString) {
+      if (queryString == null)
+         return new HashMap<String, String[]>(0);
+      // In map1 we use strings and ArrayLists to collect the parameter
+      // values.
+      HashMap<String, Object> map1 = new HashMap<String, Object>();
+      int p = 0;
+      while (p < queryString.length()) {
+         int p0 = p;
+         while (p < queryString.length() && queryString.charAt(p) != '=' && queryString.charAt(p) != '&')
+            p++;
+         String name = urlDecodeUtf8(queryString.substring(p0, p));
+         if (p < queryString.length() && queryString.charAt(p) == '=')
+            p++;
+         p0 = p;
+         while (p < queryString.length() && queryString.charAt(p) != '&')
+            p++;
+         String value = urlDecodeUtf8(queryString.substring(p0, p));
+         if (p < queryString.length() && queryString.charAt(p) == '&')
+            p++;
+         Object x = map1.get(name);
+         if (x == null) {
+            // The first value of each name is added directly as a string to
+            // the map.
+            map1.put(name, value);
+         } else if (x instanceof String) {
+            // For multiple values, we use an ArrayList.
+            ArrayList<String> a = new ArrayList<String>();
+            a.add((String) x);
+            a.add(value);
+            map1.put(name, a);
+         } else {
+            @SuppressWarnings("unchecked")
+            ArrayList<String> a = (ArrayList<String>) x;
+            a.add(value);
+         }
+      }
+
+      // Copy map1 to map2. Map2 uses string arrays to store the parameter
+      // values.
+      HashMap<String, String[]> map2 = new HashMap<String, String[]>(map1.size());
+      for (Map.Entry<String, Object> e : map1.entrySet()) {
+         String name = e.getKey();
+         Object x = e.getValue();
+         String[] v;
+         if (x instanceof String) {
+            v = new String[] { (String) x };
+         } else {
+            @SuppressWarnings("unchecked")
+            ArrayList<String> a = (ArrayList<String>) x;
+            v = new String[a.size()];
+            v = a.toArray(v);
+         }
+         map2.put(name, v);
+      }
+      return map2;
+  }
 
   private final static String urlDecodeUtf8( String s ) {
     if( s != null ) {
diff -uNr knox-0.7.0-a/.gitattributes knox-0.7.0-b/.gitattributes
--- knox-0.7.0-a/.gitattributes	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/.gitattributes	2016-08-02 13:20:40.679805554 +0400
@@ -0,0 +1,19 @@
+##########################################################################
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+##########################################################################
+
+*.cmd text eol=crlf
diff -uNr knox-0.7.0-a/.gitignore knox-0.7.0-b/.gitignore
--- knox-0.7.0-a/.gitignore	1970-01-01 04:00:00.000000000 +0400
+++ knox-0.7.0-b/.gitignore	2016-08-02 13:20:41.254818993 +0400
@@ -0,0 +1,38 @@
+##########################################################################
+# Licensed to the Apache Software Foundation (ASF) under one
+# or more contributor license agreements.  See the NOTICE file
+# distributed with this work for additional information
+# regarding copyright ownership.  The ASF licenses this file
+# to you under the Apache License, Version 2.0 (the
+# "License"); you may not use this file except in compliance
+# with the License.  You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+##########################################################################
+
+.classpath
+.project
+.settings
+dependency-reduced-pom.xml
+.idea/
+.iml/
+*.iml
+*.ipr
+*.iws
+atlassian-ide-plugin.xml
+.DS_Store
+target
+install
+patch
+candidate
+org.apache.hadoop.gateway.security.EmbeddedApacheDirectoryServer/
+velocity.log
+*.pyc
+*.py~
+*.patch
diff -uNr knox-0.7.0-a/ISSUES knox-0.7.0-b/ISSUES
--- knox-0.7.0-a/ISSUES	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/ISSUES	2016-08-02 13:20:41.301820092 +0400
@@ -2,3 +2,5 @@
 Known Issues
 ------------------------------------------------------------------------------
 
+In order to comply with Hive 0.13 REST contract changes, the Knox Gateway 
+no longer works with previous versions of Hive.
diff -uNr knox-0.7.0-a/pom.xml knox-0.7.0-b/pom.xml
--- knox-0.7.0-a/pom.xml	2015-12-16 14:53:40.000000000 +0300
+++ knox-0.7.0-b/pom.xml	2016-08-02 13:20:41.393822244 +0400
@@ -51,6 +49,7 @@
         <module>gateway-provider-rewrite</module>
         <module>gateway-provider-rewrite-func-hostmap-static</module>
         <module>gateway-provider-rewrite-func-service-registry</module>
+        <module>gateway-provider-rewrite-func-header</module>
         <module>gateway-provider-rewrite-step-secure-query</module>
         <module>gateway-provider-rewrite-step-encrypt-uri</module>
         <module>gateway-provider-security-jwt</module>
@@ -72,6 +71,7 @@
         <module>gateway-service-hive</module>
         <module>gateway-service-knoxsso</module>
         <module>gateway-service-webhdfs</module>
+        <module>gateway-service-rm</module>
         <module>gateway-service-tgs</module>
         <module>gateway-service-storm</module>
         <module>gateway-service-definitions</module>
@@ -89,14 +89,15 @@
     <properties>
         <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
         <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
+        <internal.maven.repo>https://repository.apache.org/service/local/staging/deploy/maven2</internal.maven.repo>
         <repo.id>internal.repo</repo.id>
         <internal.maven.repo>https://repository.apache.org/service/local/staging/deploy/maven2</internal.maven.repo>
         <gateway-name>Apache Knox</gateway-name>
         <gateway-project>knox</gateway-project>
         <gateway-artifact>knox</gateway-artifact>
         <gateway-version>0.7.0</gateway-version>
         <gateway-group>org.apache.knox</gateway-group>
-        <hadoop-version>2.2.0</hadoop-version>
+        <hadoop-version>2.7.2</hadoop-version>
         <jetty-version>8.1.14.v20131031</jetty-version>
     </properties>
 
@@ -171,6 +172,15 @@
                 </plugins>
             </build>
         </profile>
+        <profile>
+          <id>disable-java8-doclint</id>
+          <activation>
+              <jdk>[1.8,)</jdk>
+          </activation>
+          <properties>
+              <additionalparam>-Xdoclint:none</additionalparam>
+          </properties>
+       </profile>
     </profiles>
 
     <build>
@@ -310,7 +320,7 @@
                     <formats>
                         <format>html</format>
                     </formats>
-                    <check/>
+                    <check />
                 </configuration>
             </plugin>
             <plugin>
@@ -460,6 +470,11 @@
             </dependency>
             <dependency>
                 <groupId>${gateway-group}</groupId>
+                <artifactId>gateway-provider-rewrite-func-header</artifactId>
+                <version>${gateway-version}</version>
+            </dependency>
+            <dependency>
+                <groupId>${gateway-group}</groupId>
                 <artifactId>gateway-provider-rewrite-step-secure-query</artifactId>
                 <version>${gateway-version}</version>
             </dependency>
@@ -484,9 +499,9 @@
                 <version>${gateway-version}</version>
             </dependency>
             <dependency>
-                <groupId>${gateway-group}</groupId>
-                <artifactId>gateway-service-vault</artifactId>
-                <version>${gateway-version}</version>
+                 <groupId>${gateway-group}</groupId>
+                 <artifactId>gateway-service-vault</artifactId>
+                 <version>${gateway-version}</version>
             </dependency>
             <dependency>
                 <groupId>${gateway-group}</groupId>
@@ -525,6 +540,11 @@
             </dependency>
             <dependency>
                 <groupId>${gateway-group}</groupId>
+                <artifactId>gateway-service-rm</artifactId>
+                <version>${gateway-version}</version>
+            </dependency>
+            <dependency>
+                <groupId>${gateway-group}</groupId>
                 <artifactId>gateway-service-storm</artifactId>
                 <version>${gateway-version}</version>
             </dependency>
@@ -965,6 +985,16 @@
                 <artifactId>shiro-ehcache</artifactId>
                 <version>1.2.3</version>
             </dependency>
+            <dependency>
+                <groupId>org.kohsuke</groupId>
+                   <artifactId>libpam4j</artifactId>
+                <version>1.8</version>
+            </dependency>
+            <dependency>
+                <groupId>net.java.dev.jna</groupId>
+                <artifactId>jna</artifactId>
+                <version>4.1.0</version>
+            </dependency>
 
             <dependency>
                 <groupId>org.apache.zookeeper</groupId>
